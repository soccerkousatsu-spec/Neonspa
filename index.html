<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, viewport-fit=cover">
<title>NEON SPAGHETTI: ROGUE (Step 3 Integrated)</title>
<style>
  /* =========================================
     BASE & THEME (Step 2 Original)
     ========================================= */
  * { box-sizing: border-box; user-select: none; font-family: 'Segoe UI', sans-serif; font-weight: 900; -webkit-tap-highlight-color: transparent; }
  
  body {
    margin: 0; background-color: #050510; color: white; 
    height: 100dvh; 
    width: 100vw; 
    overflow: hidden;
    overscroll-behavior: none;
    background-image: 
      linear-gradient(rgba(0, 255, 255, 0.03) 1px, transparent 1px),
      linear-gradient(90deg, rgba(0, 255, 255, 0.03) 1px, transparent 1px);
    background-size: 40px 40px;
  }

  /* UTILS */
  .hidden { display: none !important; }
  .screen { position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; z-index: 100; padding: 20px; }
  .scroll-box { overflow-y: auto; -webkit-overflow-scrolling: touch; }
  
  /* BUTTONS */
  button { 
    background: rgba(0, 20, 40, 0.9); color: #0ff; border: 2px solid #0ff; 
    padding: 10px 20px; font-size: 16px; cursor: pointer; border-radius: 4px;
    box-shadow: 0 0 10px rgba(0,255,255,0.2); transition: 0.2s;
  }
  button:hover:not(:disabled) { background: #0ff; color: #000; box-shadow: 0 0 20px #0ff; }
  button:disabled { border-color: #555; color: #555; cursor: not-allowed; box-shadow: none; }

  /* --- SHOP/INVENTORY SMALL CARD --- */
  .item-card {
    position: relative; width: 70px; height: 90px;
    border: 2px solid #445; background: #112; border-radius: 6px;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    cursor: pointer; transition: 0.1s; margin: 3px; flex-shrink: 0;
  }
  .item-card.selected { border-color: #ffd700; box-shadow: 0 0 15px #ffd700; transform: scale(1.05); }
  .item-card img { width: 50px; height: 50px; object-fit: contain; }
  .item-card .no-img { width: 40px; height: 40px; background: #334; display: flex; align-items: center; justify-content: center; font-size: 10px; color: #889; }
  .item-card .name { font-size: 9px; margin-top: 5px; text-align: center; line-height: 1.1; width: 100%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  
  /* --- DRAFT DETAIL CARD --- */
  .draft-card {
    background: #0b0b15; border: 1px solid #445; border-radius: 8px;
    padding: 10px; display: flex; flex-direction: column; align-items: center;
    cursor: pointer; transition: 0.2s; position: relative; overflow: hidden;
    height: 160px;
  }
  .draft-card.selected { border-color: #ffd700; background: #1a1a2e; box-shadow: 0 0 15px rgba(255, 215, 0, 0.2); transform: scale(1.02); }
  
  .draft-card .img-area { width: 50px; height: 50px; margin-bottom: 5px; flex-shrink: 0; }
  .draft-card img { width: 100%; height: 100%; object-fit: contain; }
  .draft-card .no-img { width: 100%; height: 100%; background: #223; color: #667; display: flex; align-items: center; justify-content: center; font-size: 10px; border-radius: 4px; }
  
  .draft-card .role-badge { font-size: 10px; padding: 2px 6px; border-radius: 3px; margin-bottom: 5px; font-weight: bold; background: #223; border: 1px solid #445; }
  .draft-card .name { font-size: 13px; color: #fff; margin-bottom: 5px; text-align: center; font-weight: bold; }
  .draft-card .desc { font-size: 10px; color: #889; line-height: 1.3; text-align: center; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }

  /* TYPE COLORS */
  .type-tank { border-color: #0f0; color: #0f0; }
  .type-atk { border-color: #f05; color: #f05; }
  .type-supp { border-color: #0ff; color: #0ff; }
  .type-card { border-color: #fff; color: #fff; }
  
  /* === TITLE SCREEN === */
  #screen-title { 
    justify-content: center; 
    gap: 10px; 
    
    /* â˜…ä¿®æ­£ï¼šè¦ç´ ãŒå¢—ãˆã¦ç”»é¢ã‹ã‚‰ã¯ã¿å‡ºãŸå ´åˆã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ */
    overflow-y: auto; 
    -webkit-overflow-scrolling: touch; /* Safariã§ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’æ»‘ã‚‰ã‹ã«ã™ã‚‹ */
  }
  .title-content { display: flex; flex-direction: column; align-items: center; width: 100%; }
  .title-box { margin-bottom: 30px; text-align: center; animation: float 3s infinite ease-in-out; }
  .title-neon { font-size: 60px; color: #0ff; text-shadow: 0 0 20px #0ff; display: block; line-height: 0.9; transform: skew(-5deg); margin-bottom: 5px; }
  .title-spag { font-size: 40px; color: #f05; text-shadow: 0 0 20px #f05; display: block; line-height: 0.9; transform: skew(-5deg); letter-spacing: 2px; }
  @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

  .btn-title { width: 300px; margin: 8px; font-weight: 900; letter-spacing: 4px; }
  .btn-survival { height: 80px; font-size: 28px; border-color: #ffd700; color: #ffd700; box-shadow: 0 0 20px rgba(255, 215, 0, 0.3); }
  .btn-survival:hover { background: #ffd700; color: #000; box-shadow: 0 0 40px #ffd700; }
  
  .practice-menu { 
    height: 0; 
    overflow: hidden; 
    transition: height 0.3s ease-out; 
    display: flex; 
    flex-wrap: wrap; 
    justify-content: center; 
    width: 320px; 
    margin-bottom: 5px; 
    
    /* â˜…ä¿®æ­£ï¼šç”»é¢ãŒç‹­ããªã£ã¦ã‚‚ã“ã®ã‚¨ãƒªã‚¢ã‚’è‡ªå‹•ç¸®å°ã•ã›ãªã„ */
    flex-shrink: 0;
  }
  
  /* â˜…ä¿®æ­£ï¼šé«˜ã•ã‚’140pxã‹ã‚‰160pxã«å¢—ã‚„ã—ã¦ã€ãƒœã‚¿ãƒ³ãŒè¦‹åˆ‡ã‚Œã‚‹ã®ã‚’é˜²ã */
  .practice-menu.open { height: 160px; }

  .btn-diff { width: 140px; font-size: 16px; padding: 10px; display: inline-block; margin: 5px; }
  .btn-easy { border-color: #0f0; color: #0f0; } .btn-easy:hover { background: #0f0; }
  .btn-normal { border-color: #0ff; color: #0ff; } .btn-normal:hover { background: #0ff; }
  .btn-hard { border-color: #f05; color: #f05; } .btn-hard:hover { background: #f05; }
  .btn-omg { border-color: #a0f; color: #a0f; animation: omgPulse 1s infinite alternate; } 
  .btn-omg:hover { background: #a0f; color: #fff; }
  @keyframes omgPulse { from { transform: scale(1); } to { transform: scale(1.05); text-shadow: 0 0 10px #a0f; } }

  .footer { 
    position: relative; width: 100%; display: flex; flex-direction: column; align-items: center; gap: 15px; margin-top: 20px; 
    padding-bottom: calc(20px + env(safe-area-inset-bottom));
  }
  .btn-ofuse { width: auto; padding: 10px 30px; font-size: 16px; border-color: #ff914d; color: #ff914d; box-shadow: 0 0 10px #ff914d; margin: 0; letter-spacing: 2px; }
  .btn-ofuse:hover { background: #ff914d; color: #fff; }

  .settings-row { display: flex; gap: 20px; font-size: 12px; color: #889; background: rgba(0,0,0,0.5); padding: 10px 20px; border-radius: 20px; border: 1px solid #334; }
  input[type=range] { -webkit-appearance: none; width: 100px; background: transparent; cursor: pointer; }

  /* === DRAFT SCREEN === */
  #screen-draft { 
    background: rgba(5, 5, 10, 0.98); 
    overflow-y: auto; -webkit-overflow-scrolling: touch; 
    justify-content: flex-start; 
    padding-bottom: calc(120px + env(safe-area-inset-bottom));
  }
  .draft-header { text-align: center; margin-bottom: 15px; flex-shrink: 0; }

  /* â–¼â–¼â–¼ è¿½åŠ ï¼šãƒ‰ãƒ©ãƒ•ãƒˆã®ã‚¹ãƒ­ãƒƒãƒˆé…ç½®ã‚¨ãƒªã‚¢ â–¼â–¼â–¼ */
  .draft-slots-area {
    display: flex; justify-content: center; gap: 10px;
    margin-bottom: 20px; width: 100%; max-width: 800px;
    flex-shrink: 0;
  }
  .d-slot {
    width: 90px; height: 120px;
    background: rgba(0,0,0,0.5); border: 2px dashed #445; border-radius: 8px;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    position: relative; cursor: pointer; transition: 0.2s;
  }
  .d-slot:hover { border-color: #fff; background: rgba(255,255,255,0.05); }
  .d-slot.filled { border-style: solid; border-color: #0ff; background: #001; box-shadow: 0 0 15px rgba(0,255,255,0.2); }
  
  .d-slot .label { font-size: 10px; color: #667; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 1px; }
  .d-slot img { width: 60px; height: 60px; object-fit: contain; margin-bottom: 5px; }
  .d-slot .name { font-size: 11px; color: #fff; text-align: center; width: 100%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .d-slot .placeholder { font-size: 20px; color: #334; }
  .d-slot .remove-hint { position: absolute; top: 2px; right: 4px; color: #f05; font-size: 14px; display: none; }
  .d-slot.filled:hover .remove-hint { display: block; }
  /* â–²â–²â–² è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–² */
  
  .draft-grid { 
    display: grid; 
    grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); 
    gap: 10px; 
    width: 100%; max-width: 800px; 
    margin-bottom: 30px; flex-shrink: 0; 
  }

  .draft-counter { font-size: 14px; color: #889; margin-bottom: 8px; flex-shrink: 0; width: 100%; max-width: 800px; padding-left: 5px; border-left: 3px solid #445; }
  .draft-counter.ok { color: #0f0; border-color: #0f0; text-shadow: 0 0 5px #0f0; }

  #btn-draft-confirm { 
    flex-shrink: 0; margin-top: 20px; height: 60px; font-size: 20px; width: 90%; max-width: 400px; box-shadow: 0 0 20px rgba(0,255,255,0.1); 
    margin-bottom: 20px;
  }

  /* === HANGAR SCREEN (Mobile Optimized) === */
  #screen-hangar { 
    background: rgba(5, 10, 20, 0.98); 
    padding: 10px; 
    display: flex; flex-direction: column; 
    gap: 10px;
    height: 100dvh; /* Dynamic Height */
  }
  
  .hangar-top { display: flex; justify-content: space-between; align-items: center; width: 100%; flex-shrink: 0; border-bottom: 1px solid #334; padding-bottom: 5px; }
  .money-disp { font-size: 24px; color: #ffd700; font-family: monospace; }
  
  .hangar-tabs { display: flex; gap: 10px; width: 100%; overflow-x: auto; flex-shrink: 0; padding-bottom: 5px; }
  .tab-btn { flex: 1; padding: 10px 5px; font-size: 12px; border: 1px solid #445; background: #112; color: #889; white-space: nowrap; }
  .tab-btn.active { border-color: #0ff; color: #0ff; background: #002; }

  .hangar-main { 
    display: flex; flex-direction: column; 
    width: 100%; flex: 1; overflow: hidden; 
  }

  .shop-list { 
    flex: 1; 
    display: flex; flex-wrap: wrap; align-content: flex-start; justify-content: center;
    gap: 5px; overflow-y: auto; 
    padding: 5px; border: 1px dashed #334; background: rgba(0,0,0,0.2);
    padding-bottom: 20px;
  }

  .info-panel { 
    width: 100%; height: 180px; flex-shrink: 0; 
    background: rgba(0,0,0,0.8); border: 1px solid #445; 
    padding: 15px; margin-top: 10px;
    display: flex; flex-direction: column; 
  }
  
  .info-name { font-size: 20px; color: #fff; margin-bottom: 5px; }
  .info-role { font-size: 12px; color: #889; margin-bottom: 10px; border-bottom: 1px solid #445; padding-bottom: 5px; }
  .info-desc { font-size: 13px; color: #ccc; line-height: 1.4; flex: 1; overflow-y: auto; margin-bottom: 10px; }
  .info-row { display: flex; justify-content: space-between; align-items: center; }
  .info-price { font-size: 24px; color: #ffd700; }
  
  .hangar-footer { 
    width: 100%; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; margin-top: 5px;
    padding-bottom: calc(10px + env(safe-area-inset-bottom));
  }

  #screen-battle { z-index: 50; display: none; } 
  
  /* =========================================
     BATTLE SYSTEM STYLES (v17.5 Integrated)
     ========================================= */
  #screen-battle {
    position: absolute; inset: 0; display: flex; flex-direction: column; 
    overflow: hidden;
    padding: 0; /* Reset screen padding */
  }

  /* FX & ANIMATIONS */
  .glitch-active { animation: glitchAnim 0.1s steps(2, end); }
  @keyframes glitchAnim {
    0% { filter: invert(0); transform: translate(0); }
    25% { filter: invert(0.8) hue-rotate(90deg); transform: translate(1px, -1px); }
    50% { filter: sepia(1) hue-rotate(-90deg); transform: translate(-1px, 1px); }
    75% { filter: invert(0); transform: translate(0); }
  }

  .omg-win-bg { animation: godRay 3s infinite alternate; }
  @keyframes godRay {
    0% { filter: hue-rotate(0deg) contrast(1.2); box-shadow: inset 0 0 50px #ffd700; }
    100% { filter: hue-rotate(20deg) contrast(1.5); box-shadow: inset 0 0 150px #fff; }
  }

  #layer-bg { position: absolute; inset: 0; z-index: 0; opacity: 0.5; pointer-events: none; }
  #layer-lines { position: absolute; inset: 0; z-index: 50; pointer-events: none; }
  #layer-ui { position: relative; z-index: 100; flex: 1; display: flex; flex-direction: column; width: 100%; height: 100%; }
  #layer-drag { position: absolute; inset: 0; z-index: 999; pointer-events: none; }
  
  #layer-count { 
    position: absolute; inset: 0; z-index: 2000; pointer-events: none; 
    display: flex; justify-content: center; align-items: center;
    font-size: 120px; color: #fff; text-shadow: 0 0 20px #0ff;
    opacity: 0; transform: scale(0.5);
  }
  .count-anim { animation: countPop 0.8s forwards; }
  @keyframes countPop { 0% { opacity: 0; transform: scale(0.5); } 50% { opacity: 1; transform: scale(1.2); } 100% { opacity: 0; transform: scale(1.5); } }

  .hud { 
    height: 40px; display: flex; justify-content: space-between; align-items: center; padding: 0 20px; 
    font-size: 12px; color: #889; letter-spacing: 1px;
    background: rgba(10, 15, 30, 0.6); backdrop-filter: blur(5px);
    border-bottom: 1px solid rgba(0, 255, 255, 0.15);
    box-shadow: 0 5px 15px rgba(0,0,0,0.5);
    position: relative; z-index: 1000; width: 100%;
  }
  .hud span { color: #0ff; font-size: 16px; text-shadow: 0 0 5px #0ff; margin-left: 8px; }

  #pause-btn {
    width: 30px; height: 30px; 
    border: 2px solid #0ff; border-radius: 4px;
    display: flex; justify-content: center; align-items: center;
    color: #0ff; font-size: 14px; cursor: pointer;
    box-shadow: 0 0 5px #0ff; transition: 0.2s;
    background: rgba(0,0,0,0.5); pointer-events: auto;
  }
  #pause-btn:hover { background: #0ff; color: #000; box-shadow: 0 0 15px #0ff; }

  .field { flex: 1; display: flex; flex-direction: column; justify-content: space-evenly; width: 100%; position: relative; }
  
  .row { display: grid; grid-template-columns: repeat(3, 1fr); place-items: center; height: 100px; width: 100%; }
  .row.boss { display: flex; justify-content: center; align-items: center; height: 60px; }
  .row.enemy-row { margin-top: 25px; }
  .row.mob-line { 
    display: grid; grid-template-columns: repeat(3, 1fr); place-items: center; height: 120px; width: 100%;
    margin-top: 15px; 
    background: none !important; box-shadow: none !important; border: none !important;
  }
  .row.ally { margin-top: 25px; }

  .hand { 
    height: 160px; 
    display: flex; justify-content: center; align-items: center; gap: 15px; 
    padding-bottom: 10px; width: 100%;
    position: relative; z-index: 1000;
  }
  .hand::before {
    content: ''; position: absolute; top: 40px; left: 0; right: 0; bottom: 0;
    background: rgba(10, 12, 20, 0.85); backdrop-filter: blur(10px);
    border-top: 1px solid rgba(0, 255, 255, 0.15);
    box-shadow: 0 -5px 20px rgba(0,0,0,0.5); z-index: -1; 
  }

  @keyframes shake { 0% { transform: translate(0, 0); } 25% { transform: translate(-4px, 4px); } 50% { transform: translate(4px, -4px); } 75% { transform: translate(-4px, -4px); } 100% { transform: translate(0, 0); } }
  .shaking { animation: shake 0.15s ease-in-out; }

  .box {
    position: relative; width: 80px; height: 110px; max-width: 90%; max-height: 95%;
    border-radius: 8px; display: flex; flex-direction: column; justify-content: center; align-items: center;
    font-size: 14px; letter-spacing: 1px; text-transform: uppercase;
    transition: box-shadow 0.1s, transform 0.1s;
    animation: float 4s infinite ease-in-out;
    z-index: 10;
    background-size: cover; background-position: center; background-repeat: no-repeat; background-color: #000; 
  }
  .box img { width: 100%; height: 100%; object-fit: contain; position: absolute; inset:0; z-index:-1; opacity: 0.8; }
  .box.active-flash { background-color: white !important; background-image: none !important; transition: 0s; }
  .box:nth-child(1) { animation-delay: 0s; } .box:nth-child(2) { animation-delay: 1.5s; } .box:nth-child(3) { animation-delay: 3s; }

  .box.p { border: 2px solid #0ff; box-shadow: 0 0 15px rgba(0, 255, 255, 0.5); color: #e0ffff; text-shadow: 0 0 5px #000, 0 0 2px #0ff; }
  .box.e { border: 2px solid #f05; box-shadow: 0 0 15px rgba(255, 0, 85, 0.5); color: #ffe0e0; text-shadow: 0 0 5px #000, 0 0 2px #f05; }

  /* Battle Images (Mapped from JS or Defaults) */
  #p_tank, #e_tank { background-image: url('char_golden.png'); } /* Fallback */
  
  .mob {
    position: relative; width: 60px; height: 60px; min-width: 60px; min-height: 60px;
    background-color: transparent; border-radius: 0; border: none; box-shadow: none;
    display: flex; justify-content: center; align-items: center;
    flex-shrink: 0; justify-self: center; align-self: center; z-index: 10;
    transition: transform 0.3s;
  }
  .mob::before {
    content: ''; position: absolute; inset: 0;
    background-image: url('mob.png'); 
    background-size: contain; background-position: center; background-repeat: no-repeat;
    filter: drop-shadow(0 0 5px #0f0); transition: filter 0.3s; z-index: 0;
  }
  .mob.elite { transform: scale(1.3); }
  .mob.elite::before { background-image: url('mob_elite.png'); filter: drop-shadow(0 0 8px #fa0) drop-shadow(0 0 2px #fff); }
  .mob.buff { transform: scale(1.1); }
  .mob.buff::before { filter: drop-shadow(0 0 8px #a0f) drop-shadow(0 0 2px #fff); }

  /* â–¼â–¼â–¼ ä¿®æ­£å‰ â–¼â–¼â–¼ */
  /*
  .core {
    width: 60px; height: 60px; border-radius: 50%;
    display: flex; justify-content: center; align-items: center;
    font-size: 14px; z-index: 10; flex-shrink: 0; border: 3px solid white;
    font-weight: 900; text-shadow: 0 0 5px black;
    background-size: cover; background-position: center;
  }
  */

  /* â–¼â–¼â–¼ ä¿®æ­£å¾Œï¼ˆã“ã‚Œã‚’ä¸Šæ›¸ãã—ã¦ãã ã•ã„ï¼‰ â–¼â–¼â–¼ */
  .core {
    /* â˜…è¿½åŠ ï¼šã“ã‚ŒãŒãªã„ã¨ã‚¢ã‚¤ã‚³ãƒ³ãŒç”»é¢å·¦ä¸Šã«é£›ã‚“ã§ã—ã¾ã„ã¾ã™ */
    position: relative; 
    
    width: 60px; height: 60px; border-radius: 50%;
    display: flex; justify-content: center; align-items: center;
    font-size: 14px; z-index: 10; flex-shrink: 0; border: 3px solid white;
    font-weight: 900; text-shadow: 0 0 5px black;
    background-size: cover; background-position: center;
  }
  .core.p { border-color: #0ff; box-shadow: 0 0 25px #00f; color: #fff; margin-top: 25px; }
  .core.e { border-color: #f05; box-shadow: 0 0 25px #f05; color: #fff; }

  .bars { width: 90%; position: absolute; bottom: 6px; display: flex; flex-direction: column; gap: 3px; pointer-events: none; z-index: 35; }
  .bar-bg { width: 100%; height: 6px; background: rgba(0,0,0,0.8); border-radius: 3px; overflow: hidden; border: 1px solid rgba(255,255,255,0.3); }
  .fill { height: 100%; width: 100%; transition: width 0.1s linear; }
  .fill.hp.p { background: #0ff; box-shadow: 0 0 5px #0ff; }
  .fill.hp.e { background: #f05; box-shadow: 0 0 5px #f05; }
  .fill.hp.m { background: #0f0; box-shadow: 0 0 5px #0f0; }
  .fill.xp { background: #fc0; box-shadow: 0 0 5px #fc0; }
  .badge { position: absolute; top: -8px; right: -8px; background: #000; color: #fff; border: 1px solid #fff; font-size: 10px; padding: 2px 5px; border-radius: 4px; z-index: 35; box-shadow: 0 0 5px black; }
  .mob .bars { width: 160%; left: -30%; bottom: -12px; gap: 0; z-index: 35; }
  
  /* â–¼â–¼â–¼ ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ä½ç½®æƒãˆ â–¼â–¼â–¼ */
  .indicators {
    position: absolute; top: -14px; left: 0; width: 100%;
    display: flex; justify-content: flex-start; 
    align-items: center; /* â˜…è¿½åŠ ï¼šä¸Šä¸‹ä¸­å¤®æƒãˆï¼ˆå››è§’ã®ä½ç½®ã‚ºãƒ¬é˜²æ­¢ï¼‰ */
    padding-left: 4px;
    flex-wrap: wrap; gap: 3px; pointer-events: none; z-index: 40;
  }

  /* â–¼â–¼â–¼ å…±é€šãƒ‰ãƒƒãƒˆè¨­å®š â–¼â–¼â–¼ */

  .b-dot.p { color: #00ffff; } /* å‘³æ–¹ï¼ˆæ°´è‰²ï¼‰ */
  .b-dot.e { color: #ff0055; } /* æ•µï¼ˆèµ¤è‰²ï¼‰ */
  .b-dot.mob { color: #00ff00; } /* ãƒ¢ãƒ–ï¼ˆç·‘è‰²ï¼‰ */

  .b-dot { 
    width: 8px; height: 8px; 
    border: 1px solid #fff; border-radius: 50%; 
    
    /* â˜…ä¿®æ­£ï¼štransparentã§ã¯ãªãcurrentColorï¼ˆç¾åœ¨ã®è‰²ï¼‰ã§å¡—ã‚Šã¤ã¶ã—ã¾ã™ */
    background-color: currentColor;
    
    box-shadow: 0 0 2px currentColor; 
    transition: transform 0.2s; 
    margin: 1px; 
    position: relative; 
  }

  /* â–¼â–¼â–¼ å››è§’ï¼ˆTANKï¼‰ï¼šã‚µã‚¤ã‚ºã‚’å°‘ã—å¤§ããï¼ˆ7.5pxï¼‰ â–¼â–¼â–¼ */
  .b-dot.square { 
    width: 7.5px; height: 7.5px; 
    border-radius: 0; 
  }
  
  /* â–¼â–¼â–¼ è±å½¢ï¼ˆCARDï¼‰ï¼šã‚µã‚¤ã‚ºã‚’å¤§ããï¼ˆ6.5pxï¼‰ â–¼â–¼â–¼ */
  .b-dot.diamond {
    width: 6.5px; height: 6.5px;
    border-radius: 0;
    transform: rotate(45deg);
    margin: 2px; /* å›è»¢ã—ãŸåˆ†ã€éš£ã¨é‡ãªã‚‰ãªã„ã‚ˆã†ã«éš™é–“èª¿æ•´ */
  }

/* â–¼â–¼â–¼ ä¿®æ­£å¾Œï¼ˆã“ã‚Œã‚’ã‚³ãƒ”ãƒšã—ã¦ç½®ãæ›ãˆã‚‹ï¼‰ â–¼â–¼â–¼ */

/* 1. ãƒ™ãƒ¼ã‚¹ã®ç™½ã„ä¸‰è§’å½¢ï¼ˆborderã§ä½œæˆï¼‰ */
.b-dot.tri {
  width: 0; 
  height: 0; 
  
  /* â˜…é‡è¦ï¼šå…ƒã®å››è§’ã„æ ç·šã‚’ãƒªã‚»ãƒƒãƒˆ */
  border: none;
  background-color: transparent !important;
  border-radius: 0;
  box-shadow: none;
  clip-path: none; 

  /* å·¦å³ã‚’é€æ˜ã€ä¸‹ã‚’ç™½ã«ã™ã‚‹ã“ã¨ã§ä¸‰è§’ã‚’ä½œã‚‹ */
  border-left: 4.5px solid transparent;
  border-right: 4.5px solid transparent;
  border-bottom: 8px solid #fff; 
  
  margin: 0 1px;
  position: relative;
  
  /* ã¼ã‹ã—ã‚’3pxã«ã€‚ã“ã‚Œã§è‰²ãŒæ¿ƒãè¦‹ãˆã¾ã™ */
  filter: drop-shadow(0 0 3px currentColor);
  
  transform-origin: center center;
  transition: transform 0.2s;
}

/* 2. å†…å´ã®è‰²ä»˜ãä¸‰è§’å½¢ */
.b-dot.tri::after {
  content: ''; 
  position: absolute; 
  inset: auto; 
  
  /* ç™½æ ã®å†…å´ã«é…ç½®ã™ã‚‹èª¿æ•´ */
  top: 2px; 
  left: -2.5px; 
  
  /* å°ã•ã„ä¸‰è§’ */
  width: 0;
  height: 0;
  border-left: 2.5px solid transparent;
  border-right: 2.5px solid transparent;
  border-bottom: 5px solid currentColor; 
  
  background-color: transparent;
  clip-path: none;
  transform: none;
}

/* 3. ä¸‰è§’å°‚ç”¨ã®æ‹¡å¤§ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
@keyframes urgentPulseTri { 
  0% { 
    transform: scale(1); 
    filter: drop-shadow(0 0 3px currentColor); 
  } 
  100% { 
    transform: scale(1.4); 
    /* æ‹¡å¤§æ™‚ã¯å…‰ã‚’ã•ã‚‰ã«å¼·ã(8px) */
    filter: drop-shadow(0 0 8px currentColor); 
  } 
}

/* urgentã‚¯ãƒ©ã‚¹ãŒã¤ã„ãŸæ™‚ã€ä¸‰è§’ã ã‘å°‚ç”¨ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½¿ã† */
.b-dot.tri.urgent { 
  animation: urgentPulseTri 0.3s infinite alternate;
  z-index: 50;
}
/* â–²â–²â–² ä¿®æ­£å¾Œã“ã“ã¾ã§ â–²â–²â–² */

  /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆå¼·èª¿è¡¨ç¤ºï¼‰ */
  .b-dot.urgent { transform: scale(1.4); z-index: 50; animation: urgentPulse 0.3s infinite alternate; }
  .b-dot.diamond.urgent { transform: rotate(45deg) scale(1.4); }

  @keyframes urgentPulse { from { filter: drop-shadow(0 0 2px currentColor); } to { filter: drop-shadow(0 0 8px currentColor); } }


  .cd-mask { 
    position: absolute; inset: 0; background: transparent; backdrop-filter: grayscale(100%); color: white; 
    display: flex; align-items: center; justify-content: center; 
    font-size: 11px; z-index: 30; border-radius: 8px; pointer-events: none; 
  }
  
  .slot { 
    width: 70px; height: 95px; 
    background: rgba(255,255,255,0.05); border: 1px dashed #444; border-radius: 8px; position: relative; display: flex; justify-content: center; align-items: center; 
  }
  
  .card { 
    width: 100%; height: 100%; 
    background: linear-gradient(160deg, rgba(20,50,60,0.9), rgba(5,10,20,0.95)); 
    border: 2px solid #0ff; border-radius: 8px; display: flex; flex-direction: column; 
    justify-content: center; align-items: center; 
    color: #0ff; font-size: 12px; 
    cursor: grab; z-index: 50; box-shadow: 0 0 10px rgba(0, 255, 255, 0.3); 
    text-shadow: 0 0 5px #0ff; letter-spacing: 1px; 
    
    /* â–¼â–¼â–¼ ä¿®æ­£: æ–‡å­—ã‚’ä¸­å¤®æƒãˆã«ã™ã‚‹è¨­å®šã‚’è¿½åŠ ã—ã€å·¦å³ã«å°‘ã—ä½™ç™½ã‚’æŒãŸã›ã‚‹ â–¼â–¼â–¼ */
    text-align: center; 
    padding: 0 2px 20px 2px;
    /* â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–² */
  }

  .card:active { transform: scale(0.95); box-shadow: 0 0 20px rgba(0, 255, 255, 0.6); }

  .enemy-hand-pos { position: absolute; top: 5px; left: 15px; display: flex; gap: 10px; z-index: 10; }
  .slot.enemy { width: 50px; height: 70px; border-color: #f05; color: #f05; font-size: 10px; box-shadow: 0 0 10px rgba(255, 0, 85, 0.2); background: rgba(20, 0, 10, 0.5); }

  .dead { filter: grayscale(1) brightness(0.3); opacity: 0.6; border-style: dashed !important; box-shadow: none !important; animation: none !important; }
  .casting { animation: pulse 0.2s infinite alternate !important; border-color: #fa0 !important; box-shadow: 0 0 20px #fa0 !important; color: #fa0 !important; }
  @keyframes pulse { from { transform: scale(1); } to { transform: scale(1.05); } }
  .highlight { transform: scale(1.1); z-index: 200; background: #334; box-shadow: 0 0 30px white !important; border-color: white !important; }
  .ghost { position: fixed; pointer-events: none; opacity: 0.8; z-index: 1000; transform: scale(1.1); box-shadow: 0 0 30px #0ff; border-radius: 8px; display: flex; justify-content: center; align-items: center; background: rgba(0,0,0,0.8); color: white; font-size: 12px; }
  
  .path-base { fill: none; stroke-width: 4px; stroke-opacity: 0.1; stroke-linecap: round; transition: stroke-opacity 0.2s; }
  .path-base.boss { stroke-width: 8px; stroke-opacity: 0.4; stroke-dasharray: 8 8; animation: dashMove 1s linear infinite; filter: drop-shadow(0 0 5px currentColor); }
  .path-gauge { fill: none; stroke-width: 4px; stroke-linecap: round; stroke-dasharray: 8 12; animation: dashMove 0.5s linear infinite; filter: drop-shadow(0 0 3px currentColor); }
  @keyframes dashMove { from { stroke-dashoffset: 20; } to { stroke-dashoffset: 0; } }
  .path-gauge.mob { stroke-width: 2px; stroke-dasharray: 4 6; opacity: 0.5; }
  .path-gauge.boss { stroke-width: 10px; stroke-dasharray: none; opacity: 0.7; filter: blur(2px) drop-shadow(0 0 10px currentColor); }
  .path-boss-core { fill: none; stroke: #fff; stroke-width: 3px; stroke-linecap: round; stroke-dasharray: none; filter: drop-shadow(0 0 2px #fff); z-index: 60; }
  .path-gauge.p { stroke: #0ff; } .path-gauge.e { stroke: #f05; } .path-base.p { stroke: #0ff; } .path-base.e { stroke: #f05; }
  .path-reserve { fill: none; stroke: #0ff; stroke-width: 2px; stroke-dasharray: 6 8; opacity: 0.6; animation: dashMove 1.5s linear infinite; }
  #drag-line { stroke: white; stroke-width: 3px; stroke-dasharray: 5; display: none; }
  .flash { stroke-width: 2px; stroke: white; opacity: 1; animation: flashAnim 0.15s forwards; filter: drop-shadow(0 0 5px white); }
  @keyframes flashAnim { to { stroke-width: 0px; opacity: 0; } }

  .target-frame { position: absolute; pointer-events: none; z-index: 150; width: 60px; height: 60px; opacity: 0.8; animation: framePulse 2s ease-in-out infinite alternate; }
  @keyframes framePulse { from { transform: scale(1); opacity: 0.6; } to { transform: scale(1.1); opacity: 1; } }
  .tf-c { position: absolute; width: 10px; height: 10px; border: 2px solid currentColor; }
  .tf-tl { top: 0; left: 0; border-right: none; border-bottom: none; }
  .tf-tr { top: 0; right: 0; border-left: none; border-bottom: none; }
  .tf-bl { bottom: 0; left: 0; border-right: none; border-top: none; }
  .tf-br { bottom: 0; right: 0; border-left: none; border-top: none; }

  .pop { position: fixed; z-index: 2000; pointer-events: none; font-family: 'Segoe UI', sans-serif; font-size: 11px; letter-spacing: 0px; text-shadow: 2px 2px 0 #000, 0 0 8px currentColor; animation: popFly 0.8s forwards cubic-bezier(0.175, 0.885, 0.32, 1.275); text-align: center; width: 120px; left: 50%; margin-left: -60px; }
  .pop.crit { font-size: 18px; letter-spacing: 1px; z-index: 2100; text-shadow: 3px 3px 0 #000, 0 0 20px currentColor; border: none; background: none; animation: popCrit 1.0s forwards cubic-bezier(0.25, 0.46, 0.45, 0.94); }
  @keyframes popFly { 0% { opacity: 0; transform: scale(0.5) translate(0, 10px); } 40% { opacity: 1; transform: scale(1.3) translate(var(--rx), -15px); } 100% { opacity: 0; transform: scale(1) translate(var(--rx), -50px); } }
  @keyframes popCrit { 0% { opacity: 0; transform: scale(0) rotate(-15deg); } 30% { opacity: 1; transform: scale(1.4) rotate(5deg); } 100% { opacity: 0; transform: scale(1) rotate(0deg); } }

  .particle { position: absolute; width: 8px; height: 8px; border-radius: 50%; pointer-events: none; z-index: 200; box-shadow: 0 0 10px currentColor; animation: particleFly 0.6s forwards ease-out; }
  @keyframes particleFly { 0% { transform: translate(0,0) scale(1); opacity: 1; } 100% { transform: translate(var(--tx), var(--ty)) scale(0); opacity: 0; } }

  .fx-cross { position: absolute; top: 50%; left: 50%; width: 120px; height: 120px; transform: translate(-50%, -50%) rotate(45deg); pointer-events: none; z-index: 999; }
  .fx-cross::before, .fx-cross::after { content: ''; position: absolute; background: #fff; box-shadow: 0 0 10px #0ff, 0 0 20px #fff; }
  .fx-cross::before { top: 50%; left: 0; width: 100%; height: 4px; animation: crossSlash 0.2s ease-out forwards; }
  .fx-cross::after { left: 50%; top: 0; width: 4px; height: 100%; animation: crossSlash 0.2s ease-out forwards; }
  @keyframes crossSlash { 0% { opacity: 0; transform: scale(0); } 30% { opacity: 1; transform: scale(1.1); } 100% { opacity: 0; transform: scale(1.3); } }

  .fx-white-overlay { position: absolute; inset: 0; background: #fff; border-radius: 8px; pointer-events: none; z-index: 20; mix-blend-mode: overlay; opacity: 0; animation: whiteFlash 0.15s ease-out forwards; }
  @keyframes whiteFlash { 0% { opacity: 1; } 100% { opacity: 0; } }
  .fx-lvup-overlay { position: absolute; inset: 0; background: #ffd700; border-radius: 8px; pointer-events: none; z-index: 20; mix-blend-mode: overlay; opacity: 0; animation: lvupFlash 0.3s ease-out forwards; }
  @keyframes lvupFlash { 0% { opacity: 0.8; } 100% { opacity: 0; } }
  .fx-lvup-ring { position: absolute; top: 50%; left: 50%; width: 10px; height: 10px; border: 4px solid #ffd700; border-radius: 50%; transform: translate(-50%, -50%); pointer-events: none; z-index: 5; box-shadow: 0 0 20px #ffd700, inset 0 0 10px #ffd700; animation: ringExplodeGold 0.6s ease-out forwards; }
  @keyframes ringExplodeGold { 0% { width: 10px; height: 10px; opacity: 1; border-width: 8px; } 100% { width: 200px; height: 200px; opacity: 0; border-width: 0px; } }

  .bit { position: absolute; width: 8px; height: 8px; border-radius: 50%; background: #fff; z-index: 900; pointer-events: none; box-shadow: 0 0 8px currentColor; transition: transform 1.2s cubic-bezier(0.25, 0.46, 0.45, 0.94); }

  .fx-glitch-target { animation: glitchSkew 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94) both infinite; filter: drop-shadow(2px 0 #f0f) drop-shadow(-2px 0 #0ff) invert(0.2); }
  @keyframes glitchSkew { 0% { transform: translate(0); } 20% { transform: translate(-3px, 3px); } 40% { transform: translate(-3px, -3px); } 60% { transform: translate(3px, 3px); } 80% { transform: translate(3px, -3px); } 100% { transform: translate(0); } }
  
  .fx-thunder { position: absolute; top: -50px; left: 50%; width: 4px; height: 150px; background: #fff; transform: translateX(-50%); z-index: 900; pointer-events: none; box-shadow: 0 0 15px #ff0, 0 0 30px #fa0; animation: thunderFlash 0.2s steps(2) forwards; }
  @keyframes thunderFlash { 0% { opacity: 1; height: 150px; } 50% { opacity: 0.5; } 100% { opacity: 0; height: 0; } }
  .fx-spark { position: absolute; top: 50%; left: 50%; width: 2px; height: 40px; background: #ff0; pointer-events: none; z-index: 900; box-shadow: 0 0 10px #ff0; transform-origin: center; animation: sparkZap 0.3s ease-out forwards; }
  @keyframes sparkZap { 0% { transform: translate(-50%, -50%) rotate(var(--r)) scaleY(0); opacity: 1; } 50% { transform: translate(-50%, -50%) rotate(var(--r)) scaleY(1.5); opacity: 1; } 100% { transform: translate(-50%, -50%) rotate(var(--r)) scaleY(2); opacity: 0; } }

  .mob.dead {
    transform: scale(1) !important; /* ã‚¨ãƒªãƒ¼ãƒˆç­‰ã®æ‹¡å¤§ã‚’è§£é™¤ã—ã¦æ¨™æº–ã‚µã‚¤ã‚ºã«æˆ»ã™ */
    border: 2px dashed #556 !important; /* ç‚¹ç·šã®æ ã‚’æ˜ç¢ºã«å‡ºã™ */
    background-color: transparent !important;
  }

  /* UI MODALS */
  #result-modal { position: fixed; inset: 0; height: 100dvh; background: rgba(0,5,10,0.95); z-index: 2000; display: none; flex-direction: column; justify-content: center; align-items: center; backdrop-filter: blur(10px); }

  .result-title { font-size: 40px; color: #fff; margin-bottom: 20px; letter-spacing: 5px; text-shadow: 0 0 20px currentColor; text-align: center; }
  .result-sub { font-size: 14px; color: #889; margin-bottom: 40px; letter-spacing: 2px; }
  .omg-text { color: #ffd700; text-shadow: 0 0 30px #ffd700, 0 0 10px #fff; animation: omgTextPulse 0.5s infinite alternate; font-size: 50px; }
  @keyframes omgTextPulse { from { transform: scale(1); opacity: 0.8; } to { transform: scale(1.1); opacity: 1; filter: drop-shadow(0 0 10px #f0f); } }

  /* â–¼â–¼â–¼ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚¢ã‚¤ã‚³ãƒ³ã®å®šç¾© â–¼â–¼â–¼ */
  .status-grid {
    position: absolute; top: 0; left: 0;
    display: flex; flex-direction: column; gap: 1px;
    z-index: 60; pointer-events: none;
    padding: 2px;
  }
  .st-icon {
    width: 14px; height: 14px;
    font-size: 9px; font-weight: bold; color: #fff;
    display: flex; justify-content: center; align-items: center;
    border-radius: 3px;
    box-shadow: 1px 1px 2px rgba(0,0,0,0.8);
    text-shadow: 0 0 2px #000;
    position: relative;
  }
  .st-icon span { 
    position: absolute; right: -4px; bottom: -4px;
    font-size: 8px; color: #fff; background: #000; 
    border-radius: 50%; padding: 0 2px; border: 1px solid #fff;
    transform: scale(0.8);
  }
  /* è‰²åˆ†ã‘: RAGE(èµ¤), JUICE(æ©™), WEAK(ç´«) */
  .st-rage { background: #f05; border: 1px solid #ffcccc; }
  .st-juice { background: #fa0; border: 1px solid #ffeebb; }
  .st-weak { background: #a0f; border: 1px solid #eeccff; animation: pulseWeak 0.5s infinite alternate; }
  @keyframes pulseWeak { from{ opacity: 0.8; } to{ opacity: 1; transform: scale(1.1); } }

  /* â–¼â–¼â–¼ è„³æ±æ¼”å‡ºç”¨CSS â–¼â–¼â–¼ */
  
  /* 1. å…¨ä½“ãƒ›ãƒ¯ã‚¤ãƒˆã‚¢ã‚¦ãƒˆï¼ˆé–ƒå…‰ï¼‰ */
  .flash-bang {
    position: fixed; inset: 0; background: #fff; z-index: 9999;
    pointer-events: none; opacity: 0; animation: flashBangAnim 1.5s ease-out forwards;
  }
  @keyframes flashBangAnim { 0% { opacity: 1; } 10% { opacity: 1; } 100% { opacity: 0; } }

  /* 2. ãƒ†ã‚­ã‚¹ãƒˆã®ã€Œå©ãã¤ã‘ã€æ¼”å‡º */
  .slam-anim {
    animation: slamIn 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
    transform-origin: center;
  }
  @keyframes slamIn {
    0% { opacity: 0; transform: scale(5) rotate(-10deg); filter: blur(10px); }
    70% { opacity: 1; transform: scale(0.9) rotate(0deg); filter: blur(0); }
    100% { opacity: 1; transform: scale(1) rotate(0deg); }
  }

  /* 3. ç¥ã€…ã—ã„å¾Œå…‰ï¼ˆã‚´ãƒƒãƒ‰ãƒ¬ã‚¤ï¼‰ */
  .god-rays {
    position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
    width: 600px; height: 600px;
    background: repeating-conic-gradient(rgba(255, 215, 0, 0.1) 0% 5%, transparent 5% 10%);
    animation: spinRay 10s linear infinite;
    z-index: -1; pointer-events: none; border-radius: 50%;
    mask-image: radial-gradient(circle, rgba(0,0,0,1) 0%, rgba(0,0,0,0) 70%);
  }
  @keyframes spinRay { from { transform: translate(-50%, -50%) rotate(0deg); } to { transform: translate(-50%, -50%) rotate(360deg); } }

  /* å‹åˆ©ç”»é¢ã®èƒŒæ™¯ã‚’å°‘ã—è±ªè¯ã« */
  #result-modal {
    background: radial-gradient(circle, rgba(20,0,10,0.9) 0%, rgba(0,0,0,0.98) 100%);
  }

  /* â–¼â–¼â–¼ ã‚·ãƒ§ãƒƒãƒ—æ¼”å‡ºç”¨CSS â–¼â–¼â–¼ */
  
  /* 1. ãƒ‘ãƒãƒ«ãŒè³¼å…¥æ™‚ã«ãƒ”ã‚«ãƒƒã¨å…‰ã‚‹ */
  .fx-buy-flash {
    animation: shopFlash 0.4s ease-out;
  }
  @keyframes shopFlash {
    0% { background-color: #fff; box-shadow: 0 0 50px #fff; border-color: #fff; transform: scale(1.02); }
    100% { background-color: rgba(0,0,0,0.8); border-color: #445; transform: scale(1); }
  }

  /* 2. è³¼å…¥ãƒœã‚¿ãƒ³ã‹ã‚‰é£›ã³æ•£ã‚‹ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ« */
  .shop-particle {
    position: fixed; width: 6px; height: 6px; border-radius: 50%;
    pointer-events: none; z-index: 2000;
    box-shadow: 0 0 10px currentColor;
    animation: shopPartFly 0.6s forwards ease-out;
  }
  @keyframes shopPartFly {
    0% { transform: translate(0,0) scale(1); opacity: 1; }
    100% { transform: translate(var(--tx), var(--ty)) scale(0); opacity: 0; }
  }

  /* 3. é‡‘é¡ãŒãµã‚ã£ã¨æµ®ãå‡ºã‚‹ (-$500) */
  .shop-float-text {
    position: fixed; color: #ffd700; font-size: 20px; font-weight: bold;
    z-index: 2000; pointer-events: none;
    text-shadow: 0 0 5px #000;
    animation: shopFloat 1.0s forwards ease-out;
  }
  @keyframes shopFloat {
    0% { transform: translate(-50%, 0) scale(1); opacity: 1; }
    100% { transform: translate(-50%, -50px) scale(1.5); opacity: 0; }
  }

</style>
</head>
<body>

<div id="screen-title" class="screen">
    <div class="title-box">
      <span class="title-neon">NEON</span>
      <span class="title-spag">SPAGHETTI</span>
    </div>
    
    <button id="btn-continue" class="btn-title hidden" onclick="GAME.continueGame()" style="border-color:#0f0; color:#0f0; margin-bottom:20px;">
      CONTINUE
    </button>

    <button class="btn-title btn-survival" onclick="GAME.startDraft()">SURVIVAL</button>

    <button class="btn-title btn-practice" onclick="UI.togglePractice()">PRACTICE</button>
    <div id="practice-menu" class="practice-menu">
      <button class="btn-diff btn-easy" onclick="GAME.startPractice('easy')">EASY</button>
      <button class="btn-diff btn-normal" onclick="GAME.startPractice('normal')">NORMAL</button>
      <button class="btn-diff btn-hard" onclick="GAME.startPractice('hard')">HARD</button>
      <button class="btn-diff btn-omg" onclick="GAME.startPractice('omg')">OMG</button>
    </div>

    <div class="footer">
        <div class="settings-row">
<label>BGM <input type="range" min="0" max="1" step="0.01" value="0.5" oninput="GAME.setVolume('bgm', this.value)"></label>
<label>SE <input type="range" min="0" max="1" step="0.01" value="0.5" oninput="GAME.setVolume('se', this.value)"></label>

        </div>
        <button class="btn-ofuse" onclick="window.open('https://ofuse.me/3508f033', '_blank')">ğŸ’Œ SEND OFUSE</button>
    </div>
</div>


<div id="screen-draft" class="screen hidden">
  <div class="draft-header">
    <button onclick="GAME.goToTitle()" style="margin-bottom:10px; border:1px solid #445; background:#112; color:#889; font-size:12px; padding:5px 15px; width:auto;">
      &lt; QUIT TO TITLE
    </button>
    <h2 style="color:#0ff; margin:0;">INITIAL DRAFT</h2>
    <p style="font-size:12px; color:#889;">ã‚¹ãƒ­ãƒƒãƒˆã‚’ã‚¿ãƒƒãƒ—ã—ã¦è§£é™¤ã€ä¸‹ã®ãƒªã‚¹ãƒˆã‹ã‚‰è¿½åŠ </p>
  </div>

  <div class="draft-slots-area">
    <div class="d-slot" id="d-slot-0" onclick="DRAFT.clickSlot(0)">
      <div class="label">LEFT</div>
      <div class="placeholder">+</div>
    </div>
    <div class="d-slot" id="d-slot-1" onclick="DRAFT.clickSlot(1)">
      <div class="label" style="color:#f05;">CENTER</div>
      <div class="placeholder">+</div>
    </div>
    <div class="d-slot" id="d-slot-2" onclick="DRAFT.clickSlot(2)">
      <div class="label" style="color:#0f0;">RIGHT</div>
      <div class="placeholder">+</div>
    </div>
  </div>
  <div class="draft-counter" id="draft-unit-count">UNITS: 0 / 3</div>
  <div class="draft-grid" id="draft-unit-list"></div>

  <div class="draft-counter" id="draft-card-count">CARDS: 0 / 5</div>
  <div class="draft-grid" id="draft-card-list"></div>

  <button id="btn-draft-confirm" onclick="DRAFT.confirm()" disabled>CONFIRM & START</button>
</div>

<div id="screen-hangar" class="screen hidden">
  <div class="hangar-top">
    <div style="font-size:14px; color:#0ff;">HANGAR <span style="font-size:10px; color:#889;">// STAGE <span id="ui-stage">1</span></span></div>
    <div class="money-disp">$<span id="ui-money">500</span></div>
  </div>
  <div class="hangar-tabs">
    <button class="tab-btn active" onclick="HANGAR.setTab('all')">ALL</button>
    <button class="tab-btn" onclick="HANGAR.setTab('unit')">UNITS</button>
    <button class="tab-btn" onclick="HANGAR.setTab('card')">CARDS</button>
    <button class="tab-btn" onclick="HANGAR.setTab('upgrade')">UPGRADES</button>
  </div>
  <div class="hangar-main">
    <div class="shop-list scroll-box" id="shop-list"></div>
    <div class="info-panel">
      <div id="info-content" style="display:none; height:100%; flex-direction:column;">
        <div class="info-name" id="info-name">NAME</div>
        <div class="info-role" id="info-role">ROLE</div>
        <div class="info-desc" id="info-desc">Description text...</div>
        <div class="info-row" style="margin-top:auto;">
          <div class="info-price">$<span id="info-price">0</span></div>
          <button id="btn-buy" onclick="HANGAR.buy()" style="width:120px;">BUY</button>
        </div>
      </div>
      <div id="info-empty" style="color:#667; text-align:center; margin-top:50px;">SELECT ITEM</div>
    </div>
  </div>
  <div class="hangar-footer">
<div style="display:flex; gap:10px;">
  <button onclick="GAME.goToTitle()" style="border-color:#445; color:#889; font-size:12px; width:60px; text-indent: -10px;">QUIT</button>
  
  <button id="btn-reroll" onclick="HANGAR.reroll()" style="border-color:#0ff; color:#0ff; font-size:12px; width:80px; text-indent: -10px;">REROLL $100</button>
</div>

    <button onclick="GAME.startSurvivalBattle()" style="border-color:#f05; color:#f05; width:150px;">>> NEXT BATTLE</button>
  </div>

</div>

<div id="screen-battle" class="screen hidden">
  <div id="layer-bg"></div>
  <svg id="layer-lines" width="100%" height="100%"><line id="drag-line" x1="0" y1="0" x2="0" y2="0" /></svg>
  <div id="layer-count"></div>

  <div id="layer-ui">
    <div class="hud">
     <div id="pause-btn">II</div>

      <div>TIME<span id="ui-timer">300</span></div>
    </div>

    <div class="field">
      <div class="enemy-hand-pos">
        <div class="slot enemy" id="e_slot_0"><div class="cd-mask"></div></div>
        <div class="slot enemy" id="e_slot_1"><div class="cd-mask"></div></div>
      </div>

      <div class="row boss">
        <div class="core e" id="e_boss" data-id="e_boss">100%<div class="indicators" id="ind-e_boss"></div></div>
      </div>

      <div class="row enemy-row">
        <div class="box e" id="e_supp" data-id="e_supp"><div class="badge">Lv.1</div><div class="bars"><div class="bar-bg"><div class="fill hp e"></div></div><div class="bar-bg"><div class="fill xp"></div></div></div><div class="cd-mask"></div><div class="indicators" id="ind-e_supp"></div></div>
        <div class="box e" id="e_atk" data-id="e_atk"><div class="badge">Lv.1</div><div class="bars"><div class="bar-bg"><div class="fill hp e"></div></div><div class="bar-bg"><div class="fill xp"></div></div></div><div class="cd-mask"></div><div class="indicators" id="ind-e_atk"></div></div>
        <div class="box e" id="e_tank" data-id="e_tank"><div class="badge">Lv.1</div><div class="bars"><div class="bar-bg"><div class="fill hp e"></div></div><div class="bar-bg"><div class="fill xp"></div></div></div><div class="cd-mask"></div><div class="indicators" id="ind-e_tank"></div></div>
      </div>

      <div class="row mob-line">
        <div class="mob" id="mob_0" data-id="mob_0"><div class="cd-mask"></div><div class="bars"><div class="bar-bg"><div class="fill hp m"></div></div></div><div class="indicators" id="ind-mob_0"></div></div>
        <div class="mob" id="mob_1" data-id="mob_1"><div class="cd-mask"></div><div class="bars"><div class="bar-bg"><div class="fill hp m"></div></div></div><div class="indicators" id="ind-mob_1"></div></div>
        <div class="mob" id="mob_2" data-id="mob_2"><div class="cd-mask"></div><div class="bars"><div class="bar-bg"><div class="fill hp m"></div></div></div><div class="indicators" id="ind-mob_2"></div></div>
      </div>

      <div class="row ally">
        <div class="box p" id="p_supp" data-id="p_supp"><div class="badge">Lv.1</div><div class="bars"><div class="bar-bg"><div class="fill hp p"></div></div><div class="bar-bg"><div class="fill xp"></div></div></div><div class="cd-mask"></div><div class="indicators" id="ind-p_supp"></div></div>
        <div class="box p" id="p_atk" data-id="p_atk"><div class="badge">Lv.1</div><div class="bars"><div class="bar-bg"><div class="fill hp p"></div></div><div class="bar-bg"><div class="fill xp"></div></div></div><div class="cd-mask"></div><div class="indicators" id="ind-p_atk"></div></div>
        <div class="box p" id="p_tank" data-id="p_tank"><div class="badge">Lv.1</div><div class="bars"><div class="bar-bg"><div class="fill hp p"></div></div><div class="bar-bg"><div class="fill xp"></div></div></div><div class="cd-mask"></div><div class="indicators" id="ind-p_tank"></div></div>
      </div>

      <div class="row boss">
        <div class="core p" id="p_boss" data-id="p_boss">100%<div class="indicators" id="ind-p_boss"></div></div>
      </div>
    </div>

    <div class="hand">
      <div class="slot" id="slot-0"><div class="cd-mask"></div></div>
      <div class="slot" id="slot-1"><div class="cd-mask"></div></div>
    </div>
  </div>
  <div id="layer-drag"></div>
</div>

<div id="result-modal">
    <div id="res-title" class="result-title">VICTORY</div>

    <div id="res-sub" class="result-sub">STAGE CLEARED</div>
    <button onclick="BATTLE.endBattle()">NEXT</button>
</div>

<div id="pause-modal" class="hidden" style="position:fixed; inset:0; z-index:3000; background:rgba(0,0,0,0.8); backdrop-filter:blur(5px); display:flex; flex-direction:column; justify-content:center; align-items:center;">
  <h2 style="color:#0ff; font-size:40px; text-shadow:0 0 10px #0ff; margin-bottom:40px;">PAUSED</h2>
  <button onclick="BATTLE.resume()" style="width:200px; margin-bottom:20px; font-size:20px;">RESUME</button>
  <button onclick="BATTLE.quitBattle()" style="width:200px; border-color:#f05; color:#f05; font-size:20px;">QUIT</button>
</div>

<div id="modal-scout" class="hidden" style="position:fixed; inset:0; z-index:2500; background:rgba(0,5,10,0.95); flex-direction:column; align-items:center; justify-content:center; backdrop-filter:blur(5px);">
  <h2 style="color:#f05; font-size:30px; margin-bottom:10px; text-shadow:0 0 10px #f05;">ENEMY SCOUT</h2>
  <div style="color:#889; font-size:12px; margin-bottom:30px;">WARNING: HIGH THREAT DETECTED</div>

  <div style="display:flex; gap:20px; margin-bottom:20px;">
    <div class="d-slot filled" id="scout-u-0" style="border-color:#f05; pointer-events:none;">
       <div class="label" style="color:#f05;">SUPP</div>
       <img src="" style="width:60px; height:60px; object-fit:contain;">
       <div class="name" style="font-size:10px;"></div>
    </div>
    <div class="d-slot filled" id="scout-u-1" style="border-color:#f05; pointer-events:none;">
       <div class="label" style="color:#f05;">ATK</div>
       <img src="" style="width:60px; height:60px; object-fit:contain;">
       <div class="name" style="font-size:10px;"></div>
    </div>
    <div class="d-slot filled" id="scout-u-2" style="border-color:#f05; pointer-events:none;">
       <div class="label" style="color:#f05;">TANK</div>
       <img src="" style="width:60px; height:60px; object-fit:contain;">
       <div class="name" style="font-size:10px;"></div>
    </div>
  </div>

  <div style="margin-bottom:5px; color:#fff; font-size:14px;">ENEMY DECK</div>
  <div id="scout-deck-list" style="display:flex; gap:5px; margin-bottom:15px;"></div>

  <div style="width:90%; max-width:400px; margin-bottom:30px;">
      <div style="color:#f05; font-size:12px; margin-bottom:5px; border-bottom:1px solid #f05;">DETECTED LOGS</div>
      <div id="scout-log" style="
          width:100%; height:100px; 
          background:rgba(0,0,0,0.5); border:1px solid #334; 
          padding:10px; overflow-y:auto; 
          font-family:monospace; font-size:11px; color:#ffcccc;
          display:flex; flex-direction:column; gap:4px;
      ">
          </div>
  </div>

  <div style="display:flex; gap:20px;">
    <button onclick="document.getElementById('modal-scout').classList.add('hidden');" style="border-color:#889; color:#889; width:120px;">BACK</button>
    <button onclick="GAME.confirmStartBattle()" style="border-color:#f05; color:#f05; width:160px; box-shadow:0 0 20px #f05;">BATTLE START</button>
  </div>
</div>

<script>
// ============================================
//  DATABASE (ä¿®æ­£ç‰ˆ)
// ============================================

const DB = {
  units: [
    { id: 'taki', name: 'Taki', role: 'ATK', price: 400, img: 'char_taki.png', hp: 250, atk: 55, spd: 4.0, desc: '[ãƒ¢ãƒ–ç‰¹æ”»] ãƒ¢ãƒ–ã¸ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ãŒ2å€ã«ãªã‚‹ã€‚' },
    
    // â–¼â–¼â–¼ Pizza time: spd 1.5 -> 1.0 â–¼â–¼â–¼
    { id: 'pizza', name: 'Pizza time', role: 'ATK', price: 500, img: 'char_pizza.png', hp: 150, atk: 10, spd: 1.0, desc: '[é€Ÿæ”»] äºˆå‚™å‹•ä½œ1ç§’ã€CD2ç§’ã§é«˜é€Ÿæ”»æ’ƒã™ã‚‹ã€‚' },
    
    // â–¼â–¼â–¼ However: atk 40 -> 35 â–¼â–¼â–¼
    { id: 'however', name: 'However', role: 'ATK', price: 700, img: 'char_however.png', hp: 300, atk: 35, spd: 6.0, desc: '[å…¨ä½“] ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã¨åŒã˜ç¨®é¡ã®æ•µå…¨å“¡ã‚’æ”»æ’ƒã™ã‚‹ã€‚' },
    
    { id: 'thislove', name: 'This love', role: 'SUPP', price: 400, img: 'char_thislove.png', hp: 200, atk: 40, spd: 3.0, desc: '[ã‚¹ã‚¿ãƒ³] è© å”±ä¸­ã®æ•µã‚’æ”»æ’ƒã™ã‚‹ã¨ã‚¹ã‚¿ãƒ³ã•ã›ã‚‹ã€‚' },
// DB.units å†…
{ id: 'pop', name: 'PoP', role: 'SUPP', price: 600, img: 'char_pop.png', hp: 250, atk: 20, spd: 3.0, desc: '[å¼±ä½“åŒ–] æ•µã«è¢«ãƒ€ãƒ¡1.5å€ãƒ‡ãƒãƒ•ã‚’ä¸ãˆã‚‹(æœ€å¤§2ç´¯ç©)ã€‚' },

    { id: 'cheer', name: 'Cheerleeder', role: 'SUPP', price: 600, img: 'char_cheer.png', hp: 180, atk: 40, spd: 2.0, desc: '[é…å»¶] CDä¸­ã®æ•µã‚’æ”»æ’ƒã™ã‚‹ã¨ã€æ™‚é–“ã‚’å·»ãæˆ»ã™ã€‚' },
    { id: 'golden', name: 'Golden', role: 'TANK', price: 400, img: 'char_golden.png', hp: 500, atk: 50, spd: 4.0, desc: '[å®ˆè­·] å‘³æ–¹ã‚’æŒ‡å®šã™ã‚‹ã¨ã€ãƒ€ãƒ¡ãƒ¼ã‚¸ç„¡åŠ¹ãƒãƒªã‚¢ã‚’å¼µã‚‹ã€‚' },
    
    // â–¼â–¼â–¼ Old town road: spd 5.0 -> 4.0 â–¼â–¼â–¼
    { id: 'oldtown', name: 'Old town road', role: 'TANK', price: 400, img: 'char_oldtown.png', hp: 500, atk: 50, spd: 4.0, desc: '[å›å¾©] ãƒ¬ãƒ™ãƒ«ã«å¿œã˜ã¦å›å¾©é‡ãŒå¢—åŠ ã™ã‚‹ã€‚' },
    
    { id: 'wata', name: 'WATA', role: 'TANK', price: 600, img: 'char_wata.png', hp: 450, atk: 40, spd: 4.0, desc: '[æ•™è‚²] ãƒ¬ãƒ™ãƒ«ã«å¿œã˜ã¦çµŒé¨“å€¤ã‚’ä¸ãˆã‚‹ã€‚' },
  ],


  // â–¼â–¼â–¼ cardsã‚’ã“ã“ã‹ã‚‰ã‚³ãƒ”ãƒ¼ã—ã¦ä¸Šæ›¸ãã—ã¦ãã ã•ã„ â–¼â–¼â–¼
  cards: [
    // valsé…åˆ—ã¨ã€åˆæœŸçŠ¶æ…‹ã®descã‚’å®šç¾©
    { id: 'lstun', name: 'LIL STUN', type: 'JAM',  price: 300, level: 1, maxLevel: 3, vals: [2.0, 3.0, 4.0], desc: '[å¦¨å®³] è© å”±ä¸­ã®æ•µ1ä½“ã‚’ã€2ç§’é–“ã‚¹ã‚¿ãƒ³ã€‘ã•ã›ã‚‹ã€‚' },
    { id: 'rage',  name: 'RAGE',     type: 'BUFF', price: 400, level: 1, maxLevel: 3, vals: [1.3, 1.5, 1.7], desc: '[å¼·åŒ–] å‘³æ–¹1ä½“ã®æ”»æ’ƒåŠ›ã‚’ä¸€å®šæ™‚é–“ã€1.3å€ã€‘ã«ã™ã‚‹ã€‚' },
    { id: 'juice', name: 'JUICE',    type: 'BUFF', price: 400, level: 1, maxLevel: 3, vals: [1.3, 1.5, 1.7], desc: '[åŠ é€Ÿ] å‘³æ–¹1ä½“ã®è© å”±ãƒ»CDé€Ÿåº¦ã‚’ã€1.3å€ã€‘ã«ã™ã‚‹ã€‚' },
    { id: 'bom',   name: 'BOM',      type: 'ATK',  price: 500, level: 1, maxLevel: 3, vals: [30, 60, 90], desc: '[çˆ†æ’ƒ] æ•µå‘³æ–¹ãƒ»ãƒ¢ãƒ–å•ã‚ãšç”»é¢å…¨ä½“ã«ã€30ãƒ€ãƒ¡ã€‘ã€‚' },
    { id: 'grow',  name: 'GROW',     type: 'BUFF', price: 300, level: 1, maxLevel: 3, vals: [15, 25, 40],    desc: '[è‚²æˆ] å‘³æ–¹1ä½“ã«ã€çµŒé¨“å€¤ 15ã€‘ã‚’ç›´æ¥ä¸ãˆã‚‹ã€‚' },
    
    // ä»¥ä¸‹ã¯MaxLevel 1 (valsãªã—)
    { id: 'feed',   name: 'FEED',   type: 'SPEC', price: 300, level: 1, maxLevel: 1, desc: '[çµ¦é¤Œ] æ•µãƒ¢ãƒ–1ä½“ã‚’ã€å›å¾©ã€‘ã•ã›ã€æ•µã®Lvä¸Šã’ã‚’å¦¨å®³ã€‚' },
    { id: 'heal',   name: 'HEAL',   type: 'DEF',  price: 200, level: 1, maxLevel: 1, desc: '[å›å¾©] å‘³æ–¹1ä½“ã®HPã‚’å›å¾©ã™ã‚‹ã€‚' },
    { id: 'shld', name: 'SHIELD', type: 'DEF',  price: 300, level: 1, maxLevel: 1, desc: '[é˜²å£] å‘³æ–¹1ä½“ã«5ç§’é–“ã€ç„¡æ•µã‚·ãƒ¼ãƒ«ãƒ‰ã€‘ã‚’ä»˜ä¸ã€‚' },
    { id: 'quick',  name: 'QUICK',  type: 'BUFF', price: 300, level: 1, maxLevel: 1, desc: '[å……å¡«] å‘³æ–¹1ä½“ã®ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ã‚’ã€å³åº§ã«è§£æ¶ˆã€‘ã™ã‚‹ã€‚' }
  ],
  // â–²â–²â–² ä¸Šæ›¸ãã“ã“ã¾ã§ â–²â–²â–²

  upgrades: [
    // ... (ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰å®šç¾©ã¯å¤‰æ›´ãªã—) ...
    { id: 'u_laser2', name: 'TARGET_UNLOCK', price: 800, desc: 'ã‚³ã‚¢ã®è¿æ’ƒãƒ¬ãƒ¼ã‚¶ãƒ¼ãŒã€ãƒ¢ãƒ–ã ã‘ã§ãªãã€æ•µã‚­ãƒ£ãƒ©ã€‘ã‚‚ç‹™ã†ã€‚' },
    { id: 'u_hp', name: 'HP_PATCH_v1.0', price: 500, desc: 'å‘³æ–¹å…¨å“¡ã®æœ€å¤§HPãŒã€10% å¢—åŠ ã€‘ã™ã‚‹ã€‚' },
    { id: 'u_quick', name: 'QUICK_LOADER', price: 600, desc: 'ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚«ãƒ¼ãƒ‰ã®ãƒªãƒ­ãƒ¼ãƒ‰æ™‚é–“ãŒã€20% çŸ­ç¸®ã€‘ã•ã‚Œã‚‹ã€‚' },
    { id: 'u_laser_spd', name: 'LASER_OVERCLOCK', price: 500, desc: 'ã‚³ã‚¢ã‹ã‚‰å‡ºã‚‹ãƒ¬ãƒ¼ã‚¶ãƒ¼ã®ç™ºå°„é–“éš”ãŒé€Ÿããªã‚‹ã€‚' },
    { id: 'u_xp', name: 'DATA_HARVEST', price: 600, desc: 'æ•µã‚’å€’ã—ãŸæ™‚ã®ç²å¾—çµŒé¨“å€¤(XP)ãŒå¢—åŠ ã™ã‚‹ã€‚' },
    { id: 'u_cd', name: 'LATENCY_FIX', price: 700, desc: 'å‘³æ–¹å…¨å“¡ã®CDãŒã€10% çŸ­ç¸®ã€‘ã•ã‚Œã‚‹ã€‚' },
    { id: 'u_heal_laser', name: 'REPAIR_PROTOCOL', price: 800, desc: 'ã‚³ã‚¢ãŒè¿æ’ƒä»¥å¤–ã«ã€ã€å‘³æ–¹ã‚’å›å¾©ã™ã‚‹ãƒ¬ãƒ¼ã‚¶ãƒ¼ã€‘ã‚‚æ’ƒã¤ã€‚' },
    { id: 'u_share_xp', name: 'CLOUD_SYNC', price: 600, desc: 'ãƒ¢ãƒ–æ’ƒç ´æ™‚ã€ãƒˆãƒ‰ãƒ¡ä»¥å¤–ã®å‘³æ–¹ã«ã‚‚çµŒé¨“å€¤ãŒå…¥ã‚‹ã€‚' },
    { id: 'u_money', name: 'BIT_MINER', price: 500, desc: 'å‹åˆ©æ™‚ã«è²°ãˆã‚‹ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ($)ãŒå¢—åŠ ã™ã‚‹ã€‚' },
    { id: 'u_atk', name: 'OVERCLOCK_FAN', price: 600, desc: 'Atkã®æ”»æ’ƒé€Ÿåº¦ãŒ20%ã‚¢ãƒƒãƒ—ã™ã‚‹ã€‚' },
    { id: 'u_discount', name: 'DISCOUNT_KEY', price: 1000, desc: 'ã‚·ãƒ§ãƒƒãƒ—ã®å…¨å•†å“ãŒ20% OFFã«ãªã‚‹ã€‚' }
  ]
};

// ============================================
//  GAME STATE & CONTROLLERS
// ============================================

const STATE = {
  mode: null, stage: 1, money: 0,
  inventory: { units: [], cards: [], upgrades: [] },
  deck: { units: [], cards: [] },
  shopItems: [] // â˜…è¿½åŠ ï¼šç¾åœ¨ã®ã‚·ãƒ§ãƒƒãƒ—ã®å•†å“ãƒªã‚¹ãƒˆ
};

const GAME = {
  // åˆæœŸåŒ–ï¼ˆãƒ­ãƒ¼ãƒ‰æ™‚ã«å‘¼ã°ã‚Œã‚‹ï¼‰
  init: () => {
    document.querySelectorAll('.target-frame').forEach(el => el.remove());
    
    // ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¦ã¿ã‚‹
    if (SAVE.load()) {
        // ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆ â†’ ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ã§CONTINUEãƒœã‚¿ãƒ³ã‚’è¡¨ç¤ºã™ã‚‹ï¼ˆéš è”½ã‚¯ãƒ©ã‚¹ã‚’å¤–ã™ï¼‰
        document.getElementById('btn-continue').classList.remove('hidden');
    }
    
    // â˜…ã©ã¡ã‚‰ã®å ´åˆã‚‚ã€å¿…ãšã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ã‚’è¡¨ç¤ºã™ã‚‹
    UI.showScreen('screen-title');
  },

  // ç¶šãã‹ã‚‰å§‹ã‚ã‚‹ï¼ˆãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸæ™‚ã®å‡¦ç†ï¼‰
  continueGame: () => {
      UI.showScreen('screen-hangar');
      HANGAR.updateUI();
  },

  // éŸ³é‡è¨­å®š
  setVolume: (type, val) => {
    if (type === 'bgm') {
      CONFIG.bgmVolume = parseFloat(val);
      SOUND.updateBGMVolume(CONFIG.bgmVolume);
    }
    if (type === 'se') CONFIG.seVolume = parseFloat(val);
  },

  // ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ã¸æˆ»ã‚‹
  goToTitle: () => {
    SOUND.stopBGM();
    UI.showScreen('screen-title');
    
    // ã‚¿ã‚¤ãƒˆãƒ«ã«æˆ»ã£ãŸæ™‚ã‚‚ã€ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ã—ã¦ãƒœã‚¿ãƒ³ã‚’å‡ºã™
    if (SAVE.load()) {
        document.getElementById('btn-continue').classList.remove('hidden');
    } else {
        document.getElementById('btn-continue').classList.add('hidden');
    }
  },

  // ã‚µãƒã‚¤ãƒãƒ«ãƒ¢ãƒ¼ãƒ‰ï¼ˆãƒ‰ãƒ©ãƒ•ãƒˆï¼‰é–‹å§‹
  startDraft: () => {
    // æ–°ã—ãå§‹ã‚ã‚‹ã®ã§ã€å¤ã„ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã°ç¢ºå®Ÿã«æ¶ˆã™
    SAVE.clear();
    // CONTINUEãƒœã‚¿ãƒ³ã‚’éš ã™
    document.getElementById('btn-continue').classList.add('hidden');

    // â–¼â–¼â–¼ è¿½åŠ ï¼šDBã®æ±šæŸ“ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆå‰ã®ã‚²ãƒ¼ãƒ ã®ãƒ¬ãƒ™ãƒ«ã‚’å¼•ãç¶™ãŒãªã„ã‚ˆã†ã«ã™ã‚‹ï¼‰ â–¼â–¼â–¼
    DB.units.forEach(u => {
        u.level = 1;
    });
    
    DB.cards.forEach(c => {
        c.level = 1;
    });
    // â–²â–²â–² è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–²

    STATE.mode = 'survival';
    STATE.money = 500;
    STATE.stage = 1;
    STATE.inventory = { units: [], cards: [], upgrades: [] };
    STATE.deck = { units: [], cards: [] };
    
    UI.showScreen('screen-draft');
    DRAFT.init();
  },


  // ç·´ç¿’ãƒ¢ãƒ¼ãƒ‰é–‹å§‹
  startPractice: (diff) => {
    STATE.mode = 'practice';
    
    // å·¦: This Love, ä¸­: Taki, å³: Golden
    STATE.inventory.units = ['thislove', 'taki', 'golden'];
    
    // ã‚«ãƒ¼ãƒ‰å›ºå®š
    STATE.deck.cards = ['heal', 'quick', 'grow', 'shield', 'feed'];
    
    BATTLE.start(diff);
  },


  // ãƒãƒ³ã‚¬ãƒ¼ç”»é¢ï¼ˆã‚·ãƒ§ãƒƒãƒ—ï¼‰ã¸ç§»å‹•
  goToHangar: () => {
    STATE.mode = 'survival';
    UI.showScreen('screen-hangar');
    if (STATE.money === 0 && STATE.stage === 1) STATE.money = 500; 
    
    if (!STATE.shopItems || STATE.shopItems.length === 0) {
        HANGAR.generateShop();
    }
    
    // ã‚ªãƒ¼ãƒˆã‚»ãƒ¼ãƒ–
    SAVE.save();

    HANGAR.updateUI();
  },

  // â˜…ã“ã“ã«æ¬¡å›ãƒãƒƒãƒæƒ…å ±ã‚’ä¿å­˜ã™ã‚‹å¤‰æ•°ã‚’è¿½åŠ 
  nextMatch: null,

  // ãƒãƒˆãƒ«é–‹å§‹ï¼ˆã‚¹ã‚«ã‚¦ãƒˆç”»é¢è¡¨ç¤º & æ•µã®è²·ã„ç‰©ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
  startSurvivalBattle: () => { 
      // 1. æ•µã®æ§‹æˆã‚’ç”Ÿæˆ
      const roles = ['supp', 'atk', 'tank'];
      const enemyUnits = [];
      roles.forEach(role => {
          let candidates = DB.units.filter(u => u.role === role.toUpperCase());
          const unit = candidates[Math.floor(Math.random() * candidates.length)] || DB.units[0];
          enemyUnits.push({ ...unit, level: 1 }); 
      });

      // 2. æ•µã®ãƒ‡ãƒƒã‚­ã‚’ç”Ÿæˆ
      const enemyDeck = [];
      const pool = [...Object.values(CARD_MAP)]; 
      for (let i = 0; i < 5; i++) {
          if (pool.length === 0) break; 
          const randIdx = Math.floor(Math.random() * pool.length);
          enemyDeck.push(pool[randIdx].id);
          pool.splice(randIdx, 1);
      }

      // 3. â–¼â–¼â–¼ æ•µã®è²·ã„ç‰©ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ â–¼â–¼â–¼
      let budget = (STATE.stage - 1) * 600;
      if (STATE.stage > 1) budget += 200;

      const enemyUpgrades = [];
      const enemyCardLevels = {};
      enemyDeck.forEach(id => enemyCardLevels[id] = 1);
      
      const logs = [];
      const shopOptions = ['unit', 'card', 'passive'];
      
      // â˜…è¿½åŠ ï¼šãƒ¦ãƒ‹ãƒƒãƒˆã®æœ€å¤§ãƒ¬ãƒ™ãƒ«å®šç¾©
      const MAX_UNIT_LV = 10; 
      
      while (budget >= 300) {
        const choice = shopOptions[Math.floor(Math.random() * shopOptions.length)];
        
        if (choice === 'unit') {
            // â–  ãƒ¦ãƒ‹ãƒƒãƒˆå¼·åŒ–
            const targetUnit = enemyUnits[Math.floor(Math.random() * enemyUnits.length)];
            
            let cost = 400;
            if (targetUnit.role === 'ATK') cost = 800; 

            // â–¼â–¼â–¼ ä¿®æ­£ï¼šäºˆç®—ãƒã‚§ãƒƒã‚¯ã«åŠ ãˆã€ãƒ¬ãƒ™ãƒ«ä¸Šé™(10)ãƒã‚§ãƒƒã‚¯ã‚’è¿½åŠ  â–¼â–¼â–¼
            if (budget >= cost && targetUnit.level < MAX_UNIT_LV) {
                targetUnit.level++;
                budget -= cost;
                logs.push(`> ãƒ¦ãƒ‹ãƒƒãƒˆå¼·åŒ–: ${targetUnit.name} (Lv.${targetUnit.level})`);
            } else {
                budget -= 100; // è²·ãˆãªã„/ã‚«ãƒ³ã‚¹ãƒˆãªã‚‰äºˆç®—ã‚’å°‘ã—æ¸›ã‚‰ã—ã¦æ¬¡ã¸
            }
            // â–²â–²â–²
        }
        else if (choice === 'card') {
            // â–  ã‚«ãƒ¼ãƒ‰å¼·åŒ–
            const cardId = enemyDeck[Math.floor(Math.random() * enemyDeck.length)];
            
            // â–¼â–¼â–¼ ä¿®æ­£ï¼šã‚«ãƒ¼ãƒ‰ã”ã¨ã®æ­£ã—ã„æœ€å¤§ãƒ¬ãƒ™ãƒ«ã‚’å–å¾—ã—ã¦åˆ¤å®š â–¼â–¼â–¼
            const cDef = DB.cards.find(c => c.id === cardId);
            const limit = cDef ? cDef.maxLevel : 1; // ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯1ã¨ã¿ãªã™

            if (enemyCardLevels[cardId] < limit) {
                enemyCardLevels[cardId]++;
                budget -= 400;
                const cName = CARD_MAP[cardId] ? CARD_MAP[cardId].name : cardId;
                logs.push(`> ã‚«ãƒ¼ãƒ‰Lvä¸Šæ˜‡: ${cName} -> Lv.${enemyCardLevels[cardId]}`);
            } else {
                budget -= 100;
            }
            // â–²â–²â–²
        }
        else if (choice === 'passive') {
            // â–  ãƒ‘ãƒƒã‚·ãƒ–å¼·åŒ–
            const pPool = ['u_hp', 'u_atk', 'u_cd', 'u_laser_spd'];
            const pick = pPool[Math.floor(Math.random() * pPool.length)];
            
            if (!enemyUpgrades.includes(pick)) {
                enemyUpgrades.push(pick);
                budget -= 500;
                
                let pName = pick;
                if(pick==='u_hp') pName = "HPå¢—å¼·ãƒ‘ãƒƒãƒ";
                if(pick==='u_atk') pName = "æ”»æ’ƒãƒªãƒŸãƒƒã‚¿ãƒ¼è§£é™¤";
                if(pick==='u_cd') pName = "å‹•ä½œãƒ¬ã‚¤ãƒ†ãƒ³ã‚·æ”¹å–„";
                if(pick==='u_laser_spd') pName = "è¿æ’ƒãƒ¬ãƒ¼ã‚¶ãƒ¼é«˜é€ŸåŒ–";
                
                logs.push(`> ã‚·ã‚¹ãƒ†ãƒ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«: [${pName}]`);
            } else {
                budget -= 100;
            }
        }
      }

      if (logs.length === 0) {
          logs.push("> å¼·åŒ–ã‚·ã‚°ãƒŠãƒ«ãªã—");
          logs.push("> æ•µã¯åˆæœŸæ§‹æˆã®ã¾ã¾ã§ã™");
      }

      // 4. çµæœã‚’ä¿å­˜
      GAME.nextMatch = {
          units: enemyUnits,
          deck: enemyDeck,
          cardLevels: enemyCardLevels,
          upgrades: enemyUpgrades
      };

      // 5. ã‚¹ã‚«ã‚¦ãƒˆç”»é¢æç”»
      const modal = document.getElementById('modal-scout');
      
      enemyUnits.forEach((u, i) => {
          const slot = document.getElementById(`scout-u-${i}`);
          if(slot) {
            slot.querySelector('img').src = u.img;
            slot.querySelector('.name').innerHTML = `<span style="color:#fff;">Lv.${u.level}</span> ${u.name}`; 
          }
      });

      const dList = document.getElementById('scout-deck-list');
      dList.innerHTML = '';
      enemyDeck.forEach(cid => {
          const cDef = CARD_MAP[cid]; 
          const d = document.createElement('div');
          d.style.cssText = "width:50px; height:70px; border:1px solid #f05; background:#201; display:flex; flex-direction:column; justify-content:center; align-items:center; font-size:10px; color:#f05; text-align:center;";
          d.innerText = cDef ? cDef.name : cid;
          
          if (enemyCardLevels[cid] > 1) {
              d.innerHTML += `<br><span style="color:#fff; font-weight:bold;">Lv.${enemyCardLevels[cid]}</span>`;
              d.style.boxShadow = "0 0 10px #f05"; 
          }
          dList.appendChild(d);
      });

      const logBox = document.getElementById('scout-log');
      logBox.innerHTML = logs.join('<br>');
      logBox.scrollTop = logBox.scrollHeight;

      modal.classList.remove('hidden');
      modal.style.display = 'flex';
  },


  // â˜…è¿½åŠ ï¼šã‚¹ã‚«ã‚¦ãƒˆç”»é¢ã‹ã‚‰ã€ŒBATTLE STARTã€ã‚’æŠ¼ã—ãŸæ™‚ã®å‡¦ç†
  confirmStartBattle: () => {
      document.getElementById('modal-scout').classList.add('hidden');
      document.getElementById('modal-scout').style.display = 'none';
      
      STATE.shopItems = []; 
      BATTLE.start('omg'); // ã“ã“ã§æˆ¦é—˜é–‹å§‹
  }
};

const UI = {
  showScreen: (id) => {
    document.querySelectorAll('.screen').forEach(el => el.classList.add('hidden'));
    document.getElementById(id).classList.remove('hidden');
  },
  togglePractice: () => {
    document.getElementById('practice-menu').classList.toggle('open');
  },
  // Shop Card (Small)
  createItemCard: (data, type) => {
    const el = document.createElement('div');
    el.className = `item-card type-${type === 'unit' && data.role ? data.role.toLowerCase() : type}`;

    // â–¼â–¼â–¼ è¿½åŠ ï¼šã‚«ãƒ¼ãƒ‰ã®å ´åˆã¯ãƒãƒˆãƒ«ç”¨ã®è¦‹ãŸç›®ã«ã™ã‚‹ â–¼â–¼â–¼
    if (type === 'card') {
        // ã‚·ãƒ§ãƒƒãƒ—ã‚¢ã‚¤ãƒ†ãƒ ã¨ã—ã¦ã®æ ç·šã‚„èƒŒæ™¯ã‚’é€æ˜ã«ã™ã‚‹
        el.style.borderColor = 'transparent'; 
        el.style.backgroundColor = 'transparent';

        // â˜…â˜…â˜… è¿½åŠ ï¼šã“ã“ã§ã‚µã‚¤ã‚ºã‚’ä¸€å›ã‚Šå¤§ããã™ã‚‹ â˜…â˜…â˜…
        // (å…ƒã®ã‚µã‚¤ã‚ºã¯ CSSã§ width:70px, height:90px ã§ã™)
        el.style.width = '71px';   
        el.style.height = '95px'; 

        // ãƒãƒˆãƒ«ã‚«ãƒ¼ãƒ‰ã®ä¸­èº«ã‚’ä½œã‚‹
        const cardInner = document.createElement('div');
        cardInner.className = 'card'; 
        cardInner.innerText = data.name;
        
        // è‰²åˆ¤å®š
        const isRed = (data.type === 'ATK' || data.type === 'atk');
        const color = isRed ? '#f05' : '#0ff';

        // ã‚¹ã‚¿ã‚¤ãƒ«é©ç”¨
        cardInner.style.borderColor = color;
        cardInner.style.color = color;
        
        cardInner.style.fontSize = '12px'; 
        
        cardInner.style.textShadow = `0 0 5px ${color}`;
        
        el.style.padding = '2px';
        
            // ... (ã•ã£ãè¿½åŠ ã—ãŸã‚«ãƒ¼ãƒ‰ã®å‡¦ç†) ...
        el.appendChild(cardInner);
        return el; 
    }
    // â–²â–²â–² ã‚«ãƒ¼ãƒ‰è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–²

    // â–¼â–¼â–¼ è¿½åŠ ï¼šã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ãªã‚‰ã€Œç·‘è‰²ã®ãƒãƒƒãƒ—ã€ã«ã™ã‚‹ â–¼â–¼â–¼
    else if (type === 'upgrade') {
        el.style.borderColor = 'transparent';
        el.style.backgroundColor = 'transparent';

        // ãƒãƒƒãƒ—ã®è¦‹ãŸç›®ã‚’ä½œã‚‹
        const chip = document.createElement('div');
        chip.style.width = '100%';
        chip.style.height = '100%';
        chip.style.border = '2px solid #0f0'; // ç·‘è‰²ã®æ 
        chip.style.borderRadius = '6px';
        chip.style.backgroundColor = '#001';
        chip.style.display = 'flex';
        chip.style.flexDirection = 'column';
        chip.style.justifyContent = 'center';
        chip.style.alignItems = 'center';
        chip.style.color = '#0f0';
        chip.style.boxShadow = '0 0 8px rgba(0, 255, 0, 0.4)';
        chip.style.textShadow = '0 0 2px #0f0';
        chip.style.padding = '4px';

        // ä¸­å¤®ã®ã‚¢ã‚¤ã‚³ãƒ³æ–‡å­—ã‚’IDã‹ã‚‰åˆ¤å®š
        let iconTxt = "SYS";
        if (data.id.includes('hp')) iconTxt = "HP";
        if (data.id.includes('atk')) iconTxt = "ATK";
        if (data.id.includes('laser')) iconTxt = "LASER";
        if (data.id.includes('money')) iconTxt = "$$$";
        if (data.id.includes('cd') || data.id.includes('quick')) iconTxt = "SPD";
        if (data.id.includes('xp')) iconTxt = "XP";

        // ã‚¢ã‚¤ã‚³ãƒ³è¡¨ç¤º
        const icon = document.createElement('div');
        icon.innerText = `[ ${iconTxt} ]`;
        icon.style.fontSize = '10px';
        icon.style.marginBottom = '5px';
        icon.style.fontWeight = 'bold';
        chip.appendChild(icon);

        // ã‚¢ã‚¤ãƒ†ãƒ åè¡¨ç¤º
        const name = document.createElement('div');
        name.innerText = data.name.replace(/_/g, ' '); // ã‚¢ãƒ³ãƒ€ãƒ¼ã‚¹ã‚³ã‚¢ã‚’ã‚¹ãƒšãƒ¼ã‚¹ã«
        name.style.fontSize = '9px';
        name.style.textAlign = 'center';
        name.style.lineHeight = '1.1';
        chip.appendChild(name);

        el.appendChild(chip);
        return el;
    }
    // â–²â–²â–² è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–²

    if (data.img) {

      const img = document.createElement('img'); img.src = data.img;
      img.onerror = function() { this.style.display='none'; this.parentNode.querySelector('.no-img').style.display='flex'; };
      el.appendChild(img);
      const fb = document.createElement('div'); fb.className = 'no-img'; fb.style.display='none'; fb.innerText = "NO IMG"; el.appendChild(fb);
    } else {
      const box = document.createElement('div'); box.className = 'no-img'; box.style.display='flex'; box.innerText = type === 'card' ? data.type : "ITEM"; el.appendChild(box);
    }
    const name = document.createElement('div'); name.className = 'name'; name.innerText = data.name; el.appendChild(name);
    return el;
  },
  // Draft Detail Card (Large)
  createDraftCard: (data, type) => {
    const el = document.createElement('div');
    // ...ï¼ˆã‚¯ãƒ©ã‚¹è¨­å®šãªã©ã¯ãã®ã¾ã¾ï¼‰...
    el.className = `draft-card type-${type === 'unit' && data.role ? data.role.toLowerCase() : type}`;
    
    // Image Area
    const imgArea = document.createElement('div'); imgArea.className = 'img-area';
    
    // â–¼â–¼â–¼ ä¿®æ­£ï¼šã‚«ãƒ¼ãƒ‰ãªã‚‰ãƒãƒˆãƒ«ç”¨ãƒ‡ã‚¶ã‚¤ãƒ³ã‚’è¡¨ç¤ºã€ãã‚Œä»¥å¤–(ãƒ¦ãƒ‹ãƒƒãƒˆ)ãªã‚‰ç”»åƒã‚’è¡¨ç¤º â–¼â–¼â–¼
    if (type === 'card') {
        const cardInner = document.createElement('div');
        cardInner.className = 'card'; // ãƒãƒˆãƒ«ç”¨ã®CSSã‚¯ãƒ©ã‚¹
        cardInner.innerText = data.name;
        
        // ã‚«ãƒ¼ãƒ‰ã®è‰²åˆ¤å®š
        const isRed = (data.type === 'ATK' || data.type === 'atk');
        const color = isRed ? '#f05' : '#0ff';

        // è¦‹ãŸç›®ã®èª¿æ•´ï¼ˆå°ã•ã„æ ã«åã‚ã‚‹ï¼‰
        cardInner.style.width = '100%';
        cardInner.style.height = '100%';
        cardInner.style.borderColor = color;
        cardInner.style.color = color;
        cardInner.style.fontSize = '8px'; // æ–‡å­—ã¯å°ã•ã
        cardInner.style.textShadow = `0 0 4px ${color}`;
        cardInner.style.display = 'flex';
        cardInner.style.justifyContent = 'center';
        cardInner.style.alignItems = 'center';
        cardInner.style.textAlign = 'center';
        
        imgArea.appendChild(cardInner);
    } 
    else if (data.img) {
      // ãƒ¦ãƒ‹ãƒƒãƒˆç”»åƒãŒã‚ã‚‹å ´åˆï¼ˆå…ƒã®ã‚³ãƒ¼ãƒ‰ï¼‰
      const img = document.createElement('img'); img.src = data.img;
      img.onerror = function() { this.style.display='none'; this.parentNode.querySelector('.no-img').style.display='flex'; };
      imgArea.appendChild(img);
      const fb = document.createElement('div'); fb.className = 'no-img'; fb.style.display='none'; fb.innerText = "NO IMG"; imgArea.appendChild(fb);
    } else {
      // ç”»åƒãŒãªã„å ´åˆï¼ˆå…ƒã®ã‚³ãƒ¼ãƒ‰ï¼‰
      const box = document.createElement('div'); box.className = 'no-img'; box.innerText = "ITEM"; imgArea.appendChild(box);
    }
    // â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–²

    el.appendChild(imgArea);

    // ...ï¼ˆä»¥ä¸‹ã® role-badge ã‚„ name ã®å‡¦ç†ã¯ãã®ã¾ã¾ï¼‰...

    // Role Badge
    const role = document.createElement('div'); 
    role.className = `role-badge type-${type === 'unit' ? data.role.toLowerCase() : type}`;
    role.innerText = type === 'unit' ? data.role : data.type;
    el.appendChild(role);

    // Name & Desc
    const name = document.createElement('div'); name.className = 'name'; name.innerText = data.name; el.appendChild(name);
    const desc = document.createElement('div'); desc.className = 'desc'; desc.innerText = data.desc; el.appendChild(desc);
    
    return el;
  }
};

const DRAFT = {
  // ã‚¹ãƒ­ãƒƒãƒˆç®¡ç† (0:Left, 1:Center, 2:Right)
  unitSlots: [null, null, null], 
  selectedCards: new Set(),

  init: () => {
    DRAFT.unitSlots = [null, null, null];
    DRAFT.selectedCards.clear();
    DRAFT.renderLists();
    DRAFT.updateUI();
  },

  renderLists: () => {
    const uList = document.getElementById('draft-unit-list'); uList.innerHTML = '';
    DB.units.forEach(u => {
      const el = UI.createDraftCard(u, 'unit');
      el.onclick = () => DRAFT.toggleUnit(u.id);
      el.id = `draft-u-${u.id}`;
      uList.appendChild(el);
    });

    const cList = document.getElementById('draft-card-list'); cList.innerHTML = '';
    DB.cards.forEach(c => {
      const el = UI.createDraftCard(c, 'card');
      el.onclick = () => DRAFT.toggleCard(c.id);
      el.id = `draft-c-${c.id}`;
      cList.appendChild(el);
    });
  },

  toggleUnit: (id) => {
    const existingIdx = DRAFT.unitSlots.indexOf(id);
    if (existingIdx !== -1) {
        DRAFT.unitSlots[existingIdx] = null;
    } else {
        const emptyIdx = DRAFT.unitSlots.indexOf(null);
        if (emptyIdx !== -1) {
            DRAFT.unitSlots[emptyIdx] = id;
            SOUND.play('select');
        }
    }
    DRAFT.updateUI();
  },

  clickSlot: (idx) => {
      if (DRAFT.unitSlots[idx]) {
          DRAFT.unitSlots[idx] = null;
          DRAFT.updateUI();
          SOUND.play('cancel');
      }
  },

  toggleCard: (id) => {
    if (DRAFT.selectedCards.has(id)) DRAFT.selectedCards.delete(id);
    else if (DRAFT.selectedCards.size < 5) DRAFT.selectedCards.add(id);
    DRAFT.updateUI();
  },

  updateUI: () => {
    // 1. ãƒ¦ãƒ‹ãƒƒãƒˆãƒªã‚¹ãƒˆé¸æŠçŠ¶æ…‹
    const unitList = document.getElementById('draft-unit-list');
    if (unitList) {
        unitList.querySelectorAll('.draft-card').forEach(el => el.classList.remove('selected'));
    }
    DRAFT.unitSlots.forEach(id => {
        if(id) document.getElementById(`draft-u-${id}`)?.classList.add('selected');
    });

    // 2. ã‚«ãƒ¼ãƒ‰ãƒªã‚¹ãƒˆé¸æŠçŠ¶æ…‹
    const cardList = document.getElementById('draft-card-list');
    if (cardList) {
        cardList.querySelectorAll('.draft-card').forEach(el => el.classList.remove('selected'));
    }
    DRAFT.selectedCards.forEach(id => document.getElementById(`draft-c-${id}`)?.classList.add('selected'));
    
    // 3. ã‚¹ãƒ­ãƒƒãƒˆæç”»
    [0, 1, 2].forEach(idx => {
        const slotEl = document.getElementById(`d-slot-${idx}`);
        const uid = DRAFT.unitSlots[idx];
        const label = slotEl.querySelector('.label');
        slotEl.innerHTML = ''; 
        slotEl.appendChild(label);

        if (uid) {
            const uData = DB.units.find(u => u.id === uid);
            slotEl.classList.add('filled');
            const img = document.createElement('img'); img.src = uData.img; slotEl.appendChild(img);
            const name = document.createElement('div'); name.className = 'name'; name.innerText = uData.name; slotEl.appendChild(name);
            const removeHint = document.createElement('div'); removeHint.className = 'remove-hint'; removeHint.innerText = 'Ã—'; slotEl.appendChild(removeHint);
        } else {
            slotEl.classList.remove('filled');
            const ph = document.createElement('div'); ph.className = 'placeholder'; ph.innerText = '+'; slotEl.appendChild(ph);
        }
    });

    // 4. ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ãƒ»ãƒœã‚¿ãƒ³æ›´æ–°
    const filledCount = DRAFT.unitSlots.filter(x => x !== null).length;
    
    const uCount = document.getElementById('draft-unit-count');
    uCount.innerText = `UNITS: ${filledCount} / 3`;
    uCount.className = filledCount === 3 ? 'draft-counter ok' : 'draft-counter';

    const cCount = document.getElementById('draft-card-count');
    cCount.innerText = `CARDS: ${DRAFT.selectedCards.size} / 5`;
    cCount.className = DRAFT.selectedCards.size === 5 ? 'draft-counter ok' : 'draft-counter';

    document.getElementById('btn-draft-confirm').disabled = (filledCount !== 3 || DRAFT.selectedCards.size !== 5);
  },

  confirm: () => {
    // 1. åœ¨åº«ã¨ãƒ‡ãƒƒã‚­ã«ãƒ‰ãƒ©ãƒ•ãƒˆçµæœã‚’ä¿å­˜
    STATE.inventory.units = [...DRAFT.unitSlots];
    STATE.deck.units = [...DRAFT.unitSlots];
    
    STATE.inventory.cards = Array.from(DRAFT.selectedCards);
    STATE.deck.cards = Array.from(DRAFT.selectedCards);
    
    // 2. æœ€åˆã®ã‚·ãƒ§ãƒƒãƒ—ç”Ÿæˆ
    STATE.shopItems = [];
    
    // â‘  é¸ã‚“ã ãƒ¦ãƒ‹ãƒƒãƒˆã‚’è¿½åŠ 
    DRAFT.unitSlots.forEach(uid => {
        const uData = DB.units.find(u => u.id === uid);
        if (uData) {
            STATE.shopItems.push({ ...uData, _type: 'unit' });
        }
    });

    // â‘¡ é¸ã‚“ã ã‚«ãƒ¼ãƒ‰ã‚’è¿½åŠ 
    DRAFT.selectedCards.forEach(cid => {
        const cData = DB.cards.find(c => c.id === cid);
        if (cData) {
            STATE.shopItems.push({ ...cData, _type: 'card' });
        }
    });

    // â‘¢ â–¼â–¼â–¼ è¿½åŠ ï¼šã™ã¹ã¦ã®ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã‚’è¿½åŠ  â–¼â–¼â–¼
    DB.upgrades.forEach(u => {
        STATE.shopItems.push({ ...u, _type: 'upgrade' });
    });
    // â–²â–²â–² è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–²

    // 3. ãƒãƒ³ã‚¬ãƒ¼ç”»é¢ã¸ç§»å‹•
    GAME.goToHangar();
  }

};

const HANGAR = {
  // ... (currentTab ãªã©ã¯ãã®ã¾ã¾) ...
  currentTab: 'all', selectedItem: null,

  generateShop: () => {
      STATE.shopItems = [];
      let pool = [];

      // â˜…è¿½åŠ ï¼šãƒ¦ãƒ‹ãƒƒãƒˆã®æœ€å¤§ãƒ¬ãƒ™ãƒ«å®šç¾©ï¼ˆãƒãƒˆãƒ«å´ã®åˆ¶é™ã«åˆã‚ã›ã‚‹ï¼‰
      const MAX_UNIT_LV = 10;

      // 1. ãƒ¦ãƒ‹ãƒƒãƒˆï¼šæ‰€æŒæ¸ˆã¿ ã‹ã¤ æœ€å¤§ãƒ¬ãƒ™ãƒ«æœªæº€ ãªã‚‰ãƒ—ãƒ¼ãƒ«ã«å…¥ã‚Œã‚‹
      DB.units.forEach(u => { 
          // æ‰€æŒã—ã¦ã„ã‚‹ã‹ï¼Ÿ
          if (STATE.inventory.units.includes(u.id)) {
             // â˜…ä¿®æ­£ï¼šãƒ¬ãƒ™ãƒ«ãƒã‚§ãƒƒã‚¯ã‚’è¿½åŠ ï¼ˆæœªå®šç¾©ãªã‚‰Lv1ã¨ã¿ãªã™ï¼‰
             const curLv = u.level || 1;
             if (curLv < MAX_UNIT_LV) {
                 pool.push({ ...u, _type: 'unit' }); 
             }
          }
      });

      // 2. ã‚«ãƒ¼ãƒ‰ï¼š
      //  - æ‰€æŒæ¸ˆã¿ ã‹ã¤ ãƒ¬ãƒ™ãƒ«ãŒ MaxLevel æœªæº€ãªã‚‰ãƒ—ãƒ¼ãƒ«ã«å…¥ã‚Œã‚‹ï¼ˆæ–°è¦ã‚«ãƒ¼ãƒ‰ã¯å‡ºã•ãªã„ï¼‰
      DB.cards.forEach(c => { 
          const isOwned = STATE.inventory.cards.includes(c.id);
          
          // â–¼â–¼â–¼ ä¿®æ­£ï¼šæœªæ‰€æŒ (!isOwned) ã®æ¡ä»¶ã‚’å‰Šé™¤ã—ã€æŒã£ã¦ã„ã‚‹ã‚«ãƒ¼ãƒ‰ã®å¼·åŒ–ã®ã¿ã«ã™ã‚‹ â–¼â–¼â–¼
          if (isOwned && c.level < c.maxLevel) {
              pool.push({ ...c, _type: 'card' }); 
          }
          // â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–²
      });

      // 3. ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ï¼šæœªæ‰€æŒãªã‚‰ãƒ—ãƒ¼ãƒ«ã«å…¥ã‚Œã‚‹
      DB.upgrades.forEach(u => { 
          if (!STATE.inventory.upgrades.includes(u.id)) {
              pool.push({ ...u, _type: 'upgrade' });
          }
      });

      // ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã—ã¦5ã¤é¸ã¶
      while (STATE.shopItems.length < 5) {
          if (pool.length === 0) break;
          const randIdx = Math.floor(Math.random() * pool.length);
          const item = pool[randIdx];
          
          if (!STATE.shopItems.find(x => x.id === item.id)) {
              STATE.shopItems.push(item);
          }
          pool.splice(randIdx, 1);
      }
      
      // 5æ åŸ‹ã¾ã‚‰ãªã‹ã£ãŸå ´åˆã®å‡¦ç†ï¼ˆSOLD OUTè¡¨ç¤ºç”¨ãªã©ï¼‰ã¯ç¾çŠ¶ã®ã¾ã¾ã§OK
  },


  // â˜… ä¿®æ­£ï¼šãƒªãƒ­ãƒ¼ãƒ«æ©Ÿèƒ½
  reroll: () => {
      // ã‚¹ãƒ†ãƒ¼ã‚¸1ãªã‚‰å®Ÿè¡Œã—ãªã„ï¼ˆå¿µã®ç‚ºã®ã‚¬ãƒ¼ãƒ‰ï¼‰
      if (STATE.stage === 1) return;

      const cost = 100;
      if (STATE.money >= cost) {
          STATE.money -= cost;
          HANGAR.generateShop(); 
          HANGAR.selectedItem = null;
          HANGAR.updateInfoPanel();
          HANGAR.updateUI();
          SOUND.play('count');
      } else {
          alert("Not enough money!");
      }
  },

  // â˜… ä¿®æ­£ï¼šç”»é¢æ›´æ–°æ™‚ã«ãƒœã‚¿ãƒ³ã‚’åˆ¶å¾¡
  updateUI: () => {
    document.getElementById('ui-money').innerText = STATE.money;
    document.getElementById('ui-stage').innerText = STATE.stage;
    
    // â–¼â–¼â–¼ è¿½åŠ ï¼šã‚¹ãƒ†ãƒ¼ã‚¸1ãªã‚‰ãƒªãƒ­ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ– â–¼â–¼â–¼
    const rerollBtn = document.getElementById('btn-reroll');
    if (rerollBtn) {
        if (STATE.stage === 1) {
            rerollBtn.disabled = true;
            rerollBtn.style.opacity = 0.5;
            rerollBtn.style.cursor = 'not-allowed';
            rerollBtn.innerText = "LOCKED"; // æ–‡å­—ã‚’å¤‰ãˆã¦åˆ†ã‹ã‚Šã‚„ã™ã
        } else {
            rerollBtn.disabled = false;
            rerollBtn.style.opacity = 1.0;
            rerollBtn.style.cursor = 'pointer';
            rerollBtn.innerText = "REROLL $100";
        }
    }
    // â–²â–²â–² è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–²

    HANGAR.renderShop();
  },

  setTab: (tab) => {
    HANGAR.currentTab = tab;
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    event.target.classList.add('active');
    HANGAR.selectedItem = null; HANGAR.updateInfoPanel(); HANGAR.renderShop();
  },

  renderShop: () => {
    const list = document.getElementById('shop-list'); 
    list.innerHTML = '';
    let items = STATE.shopItems;
    if (HANGAR.currentTab !== 'all') items = items.filter(x => x._type === HANGAR.currentTab);

    items.forEach(item => {
      const el = UI.createItemCard(item, item._type);
      const isOwned = (item._type === 'unit' && STATE.inventory.units.includes(item.id)) ||
                      (item._type === 'card' && STATE.inventory.cards.includes(item.id)) ||
                      (item._type === 'upgrade' && STATE.inventory.upgrades.includes(item.id));
      // â–¼â–¼â–¼ ä¿®æ­£: ãƒãƒƒã‚¸ï¼ˆæ–‡å­—ï¼‰ã¯ä½œã‚‰ãšã€ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰æ¸ˆã¿ãªã‚‰è–„ãã™ã‚‹ã ã‘ã«ã™ã‚‹ â–¼â–¼â–¼
      if (isOwned && item._type === 'upgrade') {
          el.style.opacity = 0.5;
      }
      // â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–²

      el.onclick = () => HANGAR.select(item, isOwned);
      list.appendChild(el);
    });
    
    if (items.length === 0) {
        const msg = document.createElement('div');
        msg.style.color = '#889'; msg.style.width = '100%'; msg.style.textAlign = 'center'; msg.style.marginTop = '20px';
        msg.innerText = "NO ITEMS IN THIS CATEGORY";
        list.appendChild(msg);
    }
  },

  select: (item, isOwned) => { HANGAR.selectedItem = { ...item, isOwned }; HANGAR.updateInfoPanel(); },
  
  // HANGARã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ä¸­ã«ã‚ã‚‹ updateInfoPanel ã‚’ã“ã‚Œã«ç½®ãæ›ãˆ
  updateInfoPanel: () => {
    const panel = document.getElementById('info-content'); 
    const empty = document.getElementById('info-empty');
    const item = HANGAR.selectedItem;
    
    if (!item) { panel.style.display='none'; empty.style.display='flex'; return; }
    
    empty.style.display='none'; panel.style.display='flex';
    
    // åŸºæœ¬æƒ…å ±ã®è¡¨ç¤º
    document.getElementById('info-name').innerText = item.name || "UNKNOWN";
    const typeText = item._type ? item._type.toUpperCase() : "ITEM";
    const roleText = item.role ? ` / ${item.role}` : "";
    document.getElementById('info-role').innerText = typeText + roleText;
    
    // â–¼â–¼â–¼ ä¿®æ­£ï¼šèª¬æ˜æ–‡ç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ã‚’å®‰å…¨åŒ– â–¼â–¼â–¼
    let descHtml = item.desc || "No Description";

    // ã‚«ãƒ¼ãƒ‰ã‹ã¤ã€æ‰€æŒæ¸ˆã¿ã§ã€ã¾ã æˆé•·ã®ä½™åœ°ãŒã‚ã‚‹å ´åˆ
    if (item._type === 'card' && item.isOwned && item.maxLevel > 1) {
        
        // ãƒ¬ãƒ™ãƒ«ã¨Valsã®å®‰å…¨ãªå–å¾—
        const curLv = item.level || 1; 
        
        // â˜…ä¿®æ­£ç‚¹: valsãŒå­˜åœ¨ã—ã€é…åˆ—ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹
        if (Array.isArray(item.vals) && item.vals.length > curLv) {
            const currentVal = item.vals[curLv - 1]; // ç¾åœ¨ã®å€¤
            const nextVal = item.vals[curLv];        // æ¬¡ã®å€¤

            // undefinedãƒã‚§ãƒƒã‚¯ã‚’ã—ã¦ã‹ã‚‰è¡¨ç¤º
            if (currentVal !== undefined && nextVal !== undefined) {
                descHtml += `<br><br><span style="color:#889; font-size:10px;">>> NEXT UPDATE (Lv.${curLv + 1})</span>`;
                descHtml += `<br><span style="color:#fff;">EFFECT: <span style="color:#889;">${currentVal}</span> <span style="color:#0ff; font-weight:bold;">âœ ${nextVal}</span></span>`;
            }
        }
    }
    document.getElementById('info-desc').innerHTML = descHtml;
    // â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–²
    
    // ä¾¡æ ¼è¨ˆç®—
    let finalPrice = item.price;
    if (STATE.inventory.upgrades.includes('u_discount')) {
        finalPrice = Math.floor(finalPrice * 0.8);
    }
    document.getElementById('info-price').innerText = finalPrice;
    
    // ãƒœã‚¿ãƒ³åˆ¶å¾¡
    const btn = document.getElementById('btn-buy');
    const MAX_UNIT_LV = 10; 

    if (item.isOwned) {
        // â–  ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ (1å›é™ã‚Š)
        if (item._type === 'upgrade') { 
            btn.innerText = "MAXED"; 
            btn.disabled = true; 
        } 
        // â–  ãƒ¦ãƒ‹ãƒƒãƒˆ (Lv10åˆ¶é™)
        else if (item._type === 'unit') {
            const curLv = item.level || 1;
            if (curLv >= MAX_UNIT_LV) {
                btn.innerText = "MAXED";
                btn.disabled = true;
            } else {
                btn.innerText = "LEVEL UP"; 
                btn.disabled = (STATE.money < finalPrice);
            }
        }
        // â–  ã‚«ãƒ¼ãƒ‰ (å€‹åˆ¥ã®maxLevelåˆ¶é™)
        else if (item._type === 'card') {
            const curLv = item.level || 1;
            // maxLevelãŒç„¡ã„å ´åˆã¯1ã¨ã¿ãªã™
            const maxLv = item.maxLevel || 1;
            if (curLv >= maxLv) {
                btn.innerText = "MAXED";
                btn.disabled = true;
            } else {
                btn.innerText = "LEVEL UP";
                btn.disabled = (STATE.money < finalPrice);
            }
        }
    } else { 
        // æœªæ‰€æŒãªã‚‰è³¼å…¥ãƒœã‚¿ãƒ³
        btn.innerText = "BUY"; 
        btn.disabled = (STATE.money < finalPrice); 
    }
  },

  buy: () => {
    const item = HANGAR.selectedItem;
    if (!item) return;

    // ä¾¡æ ¼å†è¨ˆç®—
    let finalPrice = item.price;
    if (STATE.inventory.upgrades.includes('u_discount')) {
        finalPrice = Math.floor(finalPrice * 0.8);
    }

    if (STATE.money < finalPrice) {
        SOUND.play('cancel'); // ãŠé‡‘ãŒè¶³ã‚Šãªã„æ™‚ã®éŸ³
        return;
    }

    // â–¼â–¼â–¼ æ¼”å‡ºå‡¦ç†ã“ã“ã‹ã‚‰ â–¼â–¼â–¼

    // 1. ãƒ‘ãƒãƒ«ã‚’ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ã•ã›ã‚‹
    const panel = document.querySelector('.info-panel');
    panel.classList.remove('fx-buy-flash');
    void panel.offsetWidth; // ãƒªãƒ•ãƒ­ãƒ¼å¼·åˆ¶
    panel.classList.add('fx-buy-flash');

    // 2. ãƒœã‚¿ãƒ³ã®ä½ç½®ã‚’å–å¾—ã—ã¦ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã®ç™ºç”Ÿæºã«ã™ã‚‹
    const btn = document.getElementById('btn-buy');
    const rect = btn.getBoundingClientRect();
    const cx = rect.left + rect.width / 2;
    const cy = rect.top + rect.height / 2;

    // 3. ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ã‚’æ•£ã‚‰ã™ (è‰²ã¯ã‚¢ã‚¤ãƒ†ãƒ ã‚¿ã‚¤ãƒ—ã«åˆã‚ã›ã‚‹)
    let pColor = '#fff';
    if (item._type === 'unit') {
        if (item.role === 'ATK') pColor = '#f05';
        else if (item.role === 'TANK') pColor = '#0f0';
        else pColor = '#0ff';
    } else if (item._type === 'card') {
        pColor = (item.type === 'atk' || item.type === 'ATK') ? '#f05' : '#0ff';
    } else if (item._type === 'upgrade') {
        pColor = '#0f0'; // ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã¯ç·‘
    }

    for(let i=0; i<12; i++) {
        const p = document.createElement('div');
        p.className = 'shop-particle';
        p.style.left = cx + 'px';
        p.style.top = cy + 'px';
        p.style.color = pColor;
        p.style.backgroundColor = pColor;
        
        // ãƒ©ãƒ³ãƒ€ãƒ ãªæ–¹å‘ã«é£›ã°ã™
        const angle = Math.random() * Math.PI * 2;
        const dist = 50 + Math.random() * 50;
        p.style.setProperty('--tx', Math.cos(angle) * dist + 'px');
        p.style.setProperty('--ty', Math.sin(angle) * dist + 'px');
        
        document.body.appendChild(p);
        setTimeout(() => p.remove(), 600);
    }

    // 4. é‡‘é¡ã‚’ãƒ•ãƒ­ãƒ¼ãƒˆè¡¨ç¤º (-$500)
    const floatTxt = document.createElement('div');
    floatTxt.className = 'shop-float-text';
    floatTxt.innerText = `-$${finalPrice}`;
    floatTxt.style.left = cx + 'px';
    floatTxt.style.top = (rect.top - 20) + 'px';
    document.body.appendChild(floatTxt);
    setTimeout(() => floatTxt.remove(), 1000);

    // â–²â–²â–² æ¼”å‡ºå‡¦ç†ã“ã“ã¾ã§ â–²â–²â–²


    // å®Ÿéš›ã®è³¼å…¥å‡¦ç†
    STATE.money -= finalPrice;
    
    // â–  æœªæ‰€æŒã®å ´åˆï¼šã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªã«è¿½åŠ 
    if (!item.isOwned) {
        if (item._type === 'unit') STATE.inventory.units.push(item.id);
        if (item._type === 'card') STATE.inventory.cards.push(item.id);
        if (item._type === 'upgrade') STATE.inventory.upgrades.push(item.id);
        item.isOwned = true;
    } else {
        // â–  æ‰€æŒæ¸ˆã¿ã®å ´åˆï¼ˆãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—å‡¦ç†ï¼‰
        
        // 1. ãƒ¦ãƒ‹ãƒƒãƒˆã®ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—
        if (item._type === 'unit') {
            const original = DB.units.find(u => u.id === item.id);
            if (original) {
                if (!original.level) original.level = 1;
                original.level++;
                
                // â–¼â–¼â–¼ ä¿®æ­£ï¼š1.2å€ â†’ 1.3å€ ã«å¤‰æ›´ï¼ˆãƒãƒˆãƒ«ä¸­ã®ä¸Šæ˜‡å¹…ã¨çµ±ä¸€ï¼‰ â–¼â–¼â–¼
                original.hp = Math.floor(original.hp * 1.3);
                original.atk = Math.floor(original.atk * 1.3);
                // â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–²

                item.hp = original.hp; item.atk = original.atk; item.level = original.level; 
            }
        }
        
        // 2. ã‚«ãƒ¼ãƒ‰ã®ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—éƒ¨åˆ†
        if (item._type === 'card') {
            const original = DB.cards.find(c => c.id === item.id);
            if (original && original.level < original.maxLevel) {
                original.level++;
                item.level = original.level;
                
                const lvIdx = original.level - 1;
                // â–¼â–¼â–¼ ä¿®æ­£ï¼š[ã‚¿ã‚°]ã‚’æ®‹ã—ã¦æ•°å€¤ã‚’æ›´æ–° â–¼â–¼â–¼
                if (item.id === 'lstun') original.desc = `[å¦¨å®³] è© å”±ä¸­ã®æ•µ1ä½“ã‚’ã€${original.vals[lvIdx]}ç§’é–“ã‚¹ã‚¿ãƒ³ã€‘ã•ã›ã‚‹ã€‚`;
                if (item.id === 'rage')  original.desc = `[å¼·åŒ–] å‘³æ–¹1ä½“ã®æ”»æ’ƒåŠ›ã‚’ä¸€å®šæ™‚é–“ã€${original.vals[lvIdx]}å€ã€‘ã«ã™ã‚‹ã€‚`;
                if (item.id === 'juice') original.desc = `[åŠ é€Ÿ] å‘³æ–¹1ä½“ã®è© å”±ãƒ»CDé€Ÿåº¦ã‚’ã€${original.vals[lvIdx]}å€ã€‘ã«ã™ã‚‹ã€‚`;
                if (item.id === 'bom')   original.desc = `[çˆ†æ’ƒ] æ•µå‘³æ–¹ãƒ»ãƒ¢ãƒ–å•ã‚ãšç”»é¢å…¨ä½“ã«ã€${original.vals[lvIdx]}ãƒ€ãƒ¡ãƒ¼ã‚¸ã€‘ã€‚`;
                if (item.id === 'grow')  original.desc = `[è‚²æˆ] å‘³æ–¹1ä½“ã«ã€çµŒé¨“å€¤ ${original.vals[lvIdx]}ã€‘ã‚’ç›´æ¥ä¸ãˆã‚‹ã€‚`;
                // â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–²

                item.desc = original.desc; 
            }
        }
    }

    HANGAR.updateUI(); HANGAR.updateInfoPanel(); 
    
    // éŸ³ã‚‚è±ªè¯ã«ã™ã‚‹
    SOUND.play('count');
    SOUND.play('bit');
  },

};


// ============================================
//  BATTLE SYSTEM INTEGRATION (v17.5)
// ============================================

const CONFIG = {
  bgmVolume: 0.5, // 50%
  seVolume: 0.5   // 50%
};

const SOUND = {
  ctx: null,
  bgmBuffer: null,
  bgmSource: null,
  bgmGain: null,
  
  init: async () => { 
    try {
      if (!SOUND.ctx) SOUND.ctx = new (window.AudioContext || window.webkitAudioContext)(); 
      if (SOUND.ctx.state === 'suspended') SOUND.ctx.resume();

      // BGMç”¨ã®éŸ³é‡ãƒãƒ¼ãƒ‰ã‚’ä½œæˆ
      if (!SOUND.bgmGain) {
          SOUND.bgmGain = SOUND.ctx.createGain();
          SOUND.bgmGain.gain.value = CONFIG.bgmVolume;
          SOUND.bgmGain.connect(SOUND.ctx.destination);
      }

      // â˜…ã“ã“ã§ battlebgm.mp3 ã‚’èª­ã¿è¾¼ã¿ã¾ã™
      if (!SOUND.bgmBuffer) {
          const res = await fetch('battlebgm.mp3');
          const arr = await res.arrayBuffer();
          SOUND.bgmBuffer = await SOUND.ctx.decodeAudioData(arr);
      }
    } catch(e) { console.log('Audio init failed', e); }
  },

  playBGM: () => {
      if (!SOUND.ctx || !SOUND.bgmBuffer) return;
      SOUND.stopBGM(); // æ—¢ã«é³´ã£ã¦ãŸã‚‰æ­¢ã‚ã‚‹
      
      SOUND.bgmSource = SOUND.ctx.createBufferSource();
      SOUND.bgmSource.buffer = SOUND.bgmBuffer;
      SOUND.bgmSource.loop = true; // ãƒ«ãƒ¼ãƒ—å†ç”Ÿ
      SOUND.bgmSource.connect(SOUND.bgmGain);
      SOUND.bgmSource.start(0);
  },

  stopBGM: () => {
      if (SOUND.bgmSource) {
          try { SOUND.bgmSource.stop(); } catch(e){}
          SOUND.bgmSource = null;
      }
  },

  updateBGMVolume: (val) => {
    if (SOUND.bgmGain) SOUND.bgmGain.gain.value = val;
  },

  play: (type) => {
    if (!SOUND.ctx) return;
    const osc = SOUND.ctx.createOscillator(); const gain = SOUND.ctx.createGain();
    const t = SOUND.ctx.currentTime; osc.connect(gain); gain.connect(SOUND.ctx.destination);
    
    const vol = CONFIG.seVolume;

    if (type === 'shoot') { 
      osc.type='triangle'; osc.frequency.setValueAtTime(880,t); osc.frequency.exponentialRampToValueAtTime(110,t+0.1); 
      gain.gain.setValueAtTime(vol * 0.4,t); gain.gain.exponentialRampToValueAtTime(0.001,t+0.1); osc.start(t); osc.stop(t+0.1); 
    } 
    else if (type === 'hit') { 
      osc.type='square'; osc.frequency.setValueAtTime(100,t); osc.frequency.exponentialRampToValueAtTime(50,t+0.05); 
      gain.gain.setValueAtTime(vol * 0.8,t); gain.gain.exponentialRampToValueAtTime(0.001,t+0.05); osc.start(t); osc.stop(t+0.05); 
    }
    else if (type === 'heal') { osc.type='sine'; osc.frequency.setValueAtTime(440,t); osc.frequency.linearRampToValueAtTime(880,t+0.3); gain.gain.setValueAtTime(vol * 0.5,t); gain.gain.linearRampToValueAtTime(0,t+0.3); osc.start(t); osc.stop(t+0.3); }
    else if (type === 'shield') { osc.type='triangle'; osc.frequency.setValueAtTime(220,t); gain.gain.setValueAtTime(vol * 0.5,t); gain.gain.linearRampToValueAtTime(0,t+0.2); osc.start(t); osc.stop(t+0.2); }
    else if (type === 'parry') { 
      osc.type='sine'; osc.frequency.setValueAtTime(1500,t); osc.frequency.exponentialRampToValueAtTime(800,t+0.3); 
      gain.gain.setValueAtTime(vol * 0.8,t); gain.gain.exponentialRampToValueAtTime(0.001,t+0.3); osc.start(t); osc.stop(t+0.3);
    }
    else if (type === 'stun') { 
      osc.type='square'; osc.frequency.setValueAtTime(80,t); osc.frequency.linearRampToValueAtTime(40,t+0.3);
      gain.gain.setValueAtTime(vol * 1.0,t); gain.gain.exponentialRampToValueAtTime(0.001,t+0.3); osc.start(t); osc.stop(t+0.3);
    }
    else if (type === 'bit') {
      osc.type='sine'; osc.frequency.setValueAtTime(600,t); osc.frequency.exponentialRampToValueAtTime(300,t+0.1);
      gain.gain.setValueAtTime(vol * 0.5,t); gain.gain.exponentialRampToValueAtTime(0.001,t+0.1); osc.start(t); osc.stop(t+0.1);
    }
    else if (type === 'levelup') { 
      osc.type='triangle'; osc.frequency.setValueAtTime(440,t); osc.frequency.linearRampToValueAtTime(880,t+0.1); osc.frequency.linearRampToValueAtTime(1760,t+0.4);
      gain.gain.setValueAtTime(vol,t); gain.gain.linearRampToValueAtTime(0,t+0.6); osc.start(t); osc.stop(t+0.6); 
    }
    else if (type === 'explode') { 
      osc.type='sawtooth'; osc.frequency.setValueAtTime(150,t); osc.frequency.exponentialRampToValueAtTime(20,t+0.3); 
      gain.gain.setValueAtTime(vol * 1.5,t); gain.gain.exponentialRampToValueAtTime(0.001,t+0.3); osc.start(t); osc.stop(t+0.3);
    }
    else if (type === 'heavy_explode') { 
      osc.type='sawtooth'; osc.frequency.setValueAtTime(80,t); osc.frequency.exponentialRampToValueAtTime(10,t+0.5); 
      gain.gain.setValueAtTime(vol * 2.5,t); gain.gain.exponentialRampToValueAtTime(0.001,t+0.5); osc.start(t); osc.stop(t+0.5);
    }
    else if (type === 'ready') { osc.type='sine'; osc.frequency.setValueAtTime(880,t); gain.gain.setValueAtTime(vol * 0.3,t); gain.gain.exponentialRampToValueAtTime(0.001,t+0.1); osc.start(t); osc.stop(t+0.1); } 
    else if (type === 'cancel') { osc.type='square'; osc.frequency.setValueAtTime(220,t); osc.frequency.linearRampToValueAtTime(110,t+0.1); gain.gain.setValueAtTime(vol * 0.5,t); gain.gain.exponentialRampToValueAtTime(0.001,t+0.1); osc.start(t); osc.stop(t+0.1); }
    else if (type === 'count') { osc.type='sine'; osc.frequency.setValueAtTime(440,t); gain.gain.setValueAtTime(vol,t); gain.gain.exponentialRampToValueAtTime(0.001,t+0.2); osc.start(t); osc.stop(t+0.2); }
    else if (type === 'go') { osc.type='square'; osc.frequency.setValueAtTime(880,t); gain.gain.setValueAtTime(vol,t); gain.gain.exponentialRampToValueAtTime(0.001,t+0.4); osc.start(t); osc.stop(t+0.4); }
  }
};

const SPECS = {
  cast: { atk: 4.0, fast: 1.3, mob: 2.3, supp: 2.0 },
  cd: { atk: 8.0, guard: 10.0, miss: 4.0, boss: 20.0, stun: 10.0, mob_kill: 4.0, card_reload: 12.0 },
  val: { heal: 300, shield: 100, grow: 15, wipe: 100 },
  xp_req: 30,
  respawn: { supp: 15, atk: 20, tank: 30, mob: 40 }
};

const UNIT_DEFS = {
  p_tank: { hp: 400, atk: 50, role: 'tank', team: 'p', xp: 50 },
  p_supp: { hp: 200, atk: 40, role: 'supp', team: 'p', xp: 40 },
  p_atk:  { hp: 250, atk: 60, role: 'atk',  team: 'p', xp: 60 },
  e_tank: { hp: 550, atk: 50, role: 'tank', team: 'e', xp: 50 },
  e_supp: { hp: 250, atk: 40, role: 'supp', team: 'e', xp: 40 },
  e_atk:  { hp: 300, atk: 60, role: 'atk',  team: 'e', xp: 60 },
  mob:    { hp: 500, xp: 30, type: 'norm', team: 'mob' },
  boss:   { hp: 3500 }
};

// Map Step 2 Card IDs to Step 3 Card IDs/Logic
// â–¼â–¼â–¼ ä¿®æ­£ï¼šå…¨ã‚«ãƒ¼ãƒ‰ã‚’æ­£å¼ãªIDã§å®šç¾© â–¼â–¼â–¼
const CARD_MAP = {
  'heal':   { id: 'heal',   name: 'HEAL',      type: 'def',  speed: 'fast' },
  'shld': { id: 'shld',   name: 'SHIELD',    type: 'def',  speed: 'fast' },
  'quick':  { id: 'quick',  name: 'QUICK',     type: 'def',  speed: 'fast' },
  'grow':   { id: 'grow',   name: 'GROW',      type: 'def',  speed: 'fast' },
  'lstun':  { id: 'lstun',  name: 'LIL STUN',  type: 'jam',  speed: 'fast' }, // å¦¨å®³
  'rage':   { id: 'rage',   name: 'RAGE',      type: 'buff', speed: 'fast' }, // å¼·åŒ–
  'feed':   { id: 'feed',   name: 'FEED',      type: 'spec', speed: 'fast' }, // ç‰¹æ®Š
  'juice':  { id: 'juice',  name: 'JUICE',     type: 'buff', speed: 'fast' }, // åŠ é€Ÿ
  'bom':    { id: 'bom',    name: 'BOM',       type: 'atk',  speed: 'fast' }  // å…¨ä½“æ”»æ’ƒ
};

const BATTLE_STATE = {
  running: false, time: 300, units: {}, hand: [null, null], drag: null,
  difficulty: 'normal',
  enemyCardCd: 5, enemyMaxCardCd: 5,
  
  enemyDeck: [], 
  // â–¼â–¼â–¼ è¿½åŠ : æ•µã®å¼·åŒ–çŠ¶æ…‹ç®¡ç† â–¼â–¼â–¼
  enemyUpgrades: [],     // æ•µãŒæŒã£ã¦ã„ã‚‹ãƒ‘ãƒƒã‚·ãƒ– (ä¾‹: ['u_hp', 'u_atk'])
  enemyCardLevels: {},   // æ•µã®ã‚«ãƒ¼ãƒ‰ãƒ¬ãƒ™ãƒ« (ä¾‹: { 'bom': 2 })
  // â–²â–²â–² è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–²

  enemyHand: [ 
      { cd: 0, max: 1, cast: 0, maxCast: 1, act: null, cardId: null, reload: 0, maxReload: SPECS.cd.card_reload }, 
      { cd: 0, max: 1, cast: 0, maxCast: 1, act: null, cardId: null, reload: 0, maxReload: SPECS.cd.card_reload } 
  ],
  pCoreTimer: 0, eCoreTimer: 0
};

const BATTLE = {
  start: (diff) => {
    UI.showScreen('screen-battle');
    
    // ãƒªã‚»ãƒƒãƒˆå‡¦ç†
    BATTLE_STATE.hand = [null, null];
    document.querySelectorAll('.slot .card').forEach(el => el.remove());
    BATTLE_STATE.enemyHand = [ 
        { cd: 0, max: 1, cast: 0, maxCast: 1, act: null, cardId: null, reload: 0, maxReload: SPECS.cd.card_reload }, 
        { cd: 0, max: 1, cast: 0, maxCast: 1, act: null, cardId: null, reload: 0, maxReload: SPECS.cd.card_reload } 
    ];
    document.querySelectorAll('.mob, .box, .core').forEach(el => {
        el.classList.remove('dead', 'casting', 'shaking', 'active-flash', 'highlight', 'shaking');
        if (el.classList.contains('mob')) {
            el.className = 'mob'; el.style.border = ''; el.style.backgroundColor = 'transparent'; el.style.transform = ''; 
        }
        const mask = el.querySelector('.cd-mask');
        if (mask) { mask.style.height = '0%'; mask.innerText = ''; mask.style.backgroundColor = 'transparent'; }
        const stGrid = el.querySelector('.status-grid');
        if (stGrid) stGrid.innerHTML = '';
    });
    const selectors = ['.pop', '.particle', '.bit', '.fx-cross', '.fx-white-overlay', '.fx-lvup-overlay', '.fx-thunder', '.fx-spark', '.ghost', '.target-frame'];
    document.querySelectorAll(selectors.join(', ')).forEach(el => el.remove());
    document.getElementById('drag-line').style.display = 'none';
    BATTLE_STATE.drag = null;

    BATTLE_STATE.time = 240; 
    const btn = document.getElementById('pause-btn');
    const forcePause = (e) => { e.stopPropagation(); e.preventDefault(); BATTLE.togglePause(); };
    btn.ontouchstart = forcePause; btn.onmousedown = forcePause;
    BATTLE_STATE.difficulty = diff || 'normal';
    
    SOUND.init().then(() => { SOUND.playBGM(); });
    BATTLE_STATE.running = false;
    
    // â˜…ã“ã“ãŒå¤‰ã‚ã‚Šã¾ã—ãŸï¼šæ•µãƒ‡ãƒ¼ã‚¿ã®ãƒ­ãƒ¼ãƒ‰
    BATTLE_STATE.enemyDeck = [];
    BATTLE_STATE.enemyUpgrades = [];
    BATTLE_STATE.enemyCardLevels = {};

    if (STATE.mode === 'practice') {
        BATTLE_STATE.enemyDeck = ['heal', 'quick', 'grow', 'shld', 'feed'];
        BATTLE_STATE.enemyDeck.forEach(id => BATTLE_STATE.enemyCardLevels[id] = 1);
    } else if (STATE.mode === 'survival' && GAME.nextMatch) {
        // ã‚¹ã‚«ã‚¦ãƒˆç”»é¢ã§ä½œã£ãŸãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ãƒ‰
        BATTLE_STATE.enemyDeck = [...GAME.nextMatch.deck];
        BATTLE_STATE.enemyUpgrades = [...GAME.nextMatch.upgrades];
        BATTLE_STATE.enemyCardLevels = { ...GAME.nextMatch.cardLevels };
        
        // ãƒ‘ãƒƒã‚·ãƒ–åŠ¹æœã®é©ç”¨ (HPã‚¢ãƒƒãƒ—)
        if (BATTLE_STATE.enemyUpgrades.includes('u_hp')) {
            ['e_atk', 'e_tank', 'e_supp'].forEach(id => {
               // initEntitieså‰ãªã®ã§ã“ã“ã§ã¯é©ç”¨ã§ããªã„ãŒã€å¾Œã§é©ç”¨ã•ã‚Œã‚‹ã‚ˆã†ã«ãƒ•ãƒ©ã‚°ç®¡ç†ã—ã¦ã‚‚ã‚ˆã„
               // ä»Šå›ã¯initEntitiesã®ä¸­ã§è¨ˆç®—æ¸ˆã¿ãƒ¦ãƒ‹ãƒƒãƒˆã‚’ä½¿ã†ã®ã§ã€ã“ã“ã§ã¯ä½•ã‚‚ã—ãªãã¦OK
            });
        }
    } else {
        const allCards = Object.values(CARD_MAP);
        for (let i = 0; i < 5; i++) {
            const randCard = allCards[Math.floor(Math.random() * allCards.length)];
            BATTLE_STATE.enemyDeck.push(randCard.id);
            BATTLE_STATE.enemyCardLevels[randCard.id] = 1;
        }
    }

    // ãƒ¦ãƒ‹ãƒƒãƒˆé…ç½®
    BATTLE.initEntities();

    // æ‰‹æœ­è£œå……
    BATTLE.fillHand(0); BATTLE.fillHand(1);
    BATTLE.fillEnemyHand(0); BATTLE.fillEnemyHand(1);
    
    [0,1].forEach(i => {
        BATTLE_STATE.enemyHand[i].cast = 0; BATTLE_STATE.enemyHand[i].act = null; 
        BATTLE_STATE.enemyHand[i].reload = 0; BATTLE_STATE.enemyHand[i].cd = 0;
    });

    BATTLE_DRAW.draw();
    BATTLE.runCountdown(3);

    const w = window;
    w.removeEventListener('mousedown', INPUT.start); w.removeEventListener('mousemove', INPUT.move); w.removeEventListener('mouseup', INPUT.end);
    w.removeEventListener('touchstart', INPUT.start); w.removeEventListener('touchmove', INPUT.move); w.removeEventListener('touchend', INPUT.end);
    w.addEventListener('mousedown', INPUT.start); w.addEventListener('mousemove', INPUT.move); w.addEventListener('mouseup', INPUT.end);
    w.addEventListener('touchstart', INPUT.start, {passive: false}); w.addEventListener('touchmove', INPUT.move, {passive: false}); w.addEventListener('touchend', INPUT.end);

    if(BATTLE_STATE.loopId) clearInterval(BATTLE_STATE.loopId);
    if(BATTLE_STATE.drawId) clearInterval(BATTLE_STATE.drawId);
    if(BATTLE_STATE.tickId) clearInterval(BATTLE_STATE.tickId);

    BATTLE_STATE.loopId = setInterval(BATTLE.update, 50); 
    BATTLE_STATE.drawId = setInterval(BATTLE_DRAW.draw, 50);   
    BATTLE_STATE.tickId = setInterval(BATTLE.tick, 1000); 
  },
  
  // ä¸€æ™‚åœæ­¢ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸã¨ã
  togglePause: () => {

    BATTLE_STATE.running = false; // ã‚²ãƒ¼ãƒ ã‚’æ­¢ã‚ã‚‹
    document.getElementById('pause-modal').classList.remove('hidden'); // ç”»é¢ã‚’å‡ºã™
    document.getElementById('pause-modal').style.display = 'flex'; // è¡¨ç¤ºã‚’ç¢ºå®Ÿã«ã™ã‚‹
  },

  // å†é–‹ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸã¨ã
  resume: () => {
    document.getElementById('pause-modal').classList.add('hidden'); // ç”»é¢ã‚’æ¶ˆã™
    document.getElementById('pause-modal').style.display = 'none';
    BATTLE_STATE.running = true; // ã‚²ãƒ¼ãƒ å†é–‹
  },

  // ã‚„ã‚ã‚‹ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸã¨ã
  quitBattle: () => {
    BATTLE.stop(); // â˜…ã“ã“ãŒé‡è¦ï¼åœæ­¢å‡¦ç†ã‚’å‘¼ã¶
    SOUND.stopBGM();
    document.getElementById('pause-modal').classList.add('hidden');
    document.getElementById('pause-modal').style.display = 'none';
    GAME.goToTitle(); 
  },

  showResult: (result) => {
    // 1. æ™‚ã‚’æ­¢ã‚ã‚‹
    BATTLE_STATE.running = false;
    
    const modal = document.getElementById('result-modal');
    const title = document.getElementById('res-title');
    const sub = document.getElementById('res-sub');
    
    // UIåˆæœŸåŒ–ï¼ˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒªã‚»ãƒƒãƒˆï¼‰
    title.classList.remove('slam-anim');
    title.style.opacity = 1; 
    
    // ã‚´ãƒƒãƒ‰ãƒ¬ã‚¤ãŒã‚ã‚Œã°æ¶ˆã—ã¦ãŠãï¼ˆå†åˆ©ç”¨ã®ãŸã‚ï¼‰
    const oldRays = modal.querySelector('.god-rays');
    if (oldRays) oldRays.remove();

    // ----------------------------------------------------
    // â–  æ•—åŒ— (LOSE)
    // ----------------------------------------------------
    if (result === 'lose') {
        SAVE.clear();
        modal.style.display = 'flex';
        title.innerText = "GAME OVER";
        title.style.color = "#f05";
        sub.innerText = `FAILED AT STAGE ${STATE.stage}...`;
        SOUND.play('heavy_explode');
        return;
    }

    // ----------------------------------------------------
    // â–  å‹åˆ© (WIN) - åˆ¤å®š
    // ----------------------------------------------------
    
    // â˜…æœ€çµ‚ã‚¹ãƒ†ãƒ¼ã‚¸ã‚¯ãƒªã‚¢ã‹ã©ã†ã‹åˆ¤å®š
    const isAllClear = (STATE.mode === 'survival' && STATE.stage >= 5);

    // â–¼â–¼â–¼ ä¿®æ­£ï¼šå ±é…¬è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ã‚’å¤‰æ›´ â–¼â–¼â–¼
    // åŸºæœ¬è¨ˆç®—: 300 + (ã‚¹ãƒ†ãƒ¼ã‚¸æ•° Ã— 100)
    // Stage 1ã‚¯ãƒªã‚¢: 300 + 100 = 400
    // Stage 2ã‚¯ãƒªã‚¢: 300 + 200 = 500
    // Stage 3ã‚¯ãƒªã‚¢: 300 + 300 = 600
    // Stage 4ã‚¯ãƒªã‚¢: 300 + 400 = 700
    let reward = 300 + (STATE.stage * 100);

    // BIT_MINER (u_money) ãƒœãƒ¼ãƒŠã‚¹: +100 â†’ +200 ã«å¤‰æ›´
    if (STATE.inventory.upgrades.includes('u_money')) reward += 200;
    
    STATE.money += reward;
    // â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–²
    
    // ã‚¹ãƒ†ãƒ¼ã‚¸é€²è¡Œï¼ˆå…¨ã‚¯ãƒªã§ãªã‘ã‚Œã°é€²ã‚ã‚‹ï¼‰
    if (STATE.mode === 'survival' && !isAllClear) STATE.stage++;

    // ----------------------------------------------------
    // ãƒ‘ã‚¿ãƒ¼ãƒ³A: é€šå¸¸ã‚¯ãƒªã‚¢ (ã‚ã£ã•ã‚Šæ¼”å‡º)
    // ----------------------------------------------------
    if (!isAllClear) {
        modal.style.display = 'flex'; // â˜…ã™ãã«è¡¨ç¤º
        title.innerText = "VICTORY";
        title.style.color = "#0ff";
        sub.innerText = "STAGE CLEARED";
        SOUND.play('levelup'); // è»½ã‚ã®éŸ³
        return;
    }

    // ----------------------------------------------------
    // ãƒ‘ã‚¿ãƒ¼ãƒ³B: å®Œå…¨åˆ¶è¦‡ (è„³æ±ãƒ‰ãƒãƒ‰ãƒæ¼”å‡º)
    // ----------------------------------------------------
    if (isAllClear) {
        SAVE.clear(); // ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢
        BATTLE_STATE.lastResult = 'clear';

        // â‘  é–ƒå…‰ (Flash Bang)
        const flash = document.createElement('div');
        flash.className = 'flash-bang';
        document.body.appendChild(flash);
        setTimeout(() => flash.remove(), 1500);

        // â‘¡ å¤§çˆ†ç™ºéŸ³ & ç”»é¢æºã‚Œ
        SOUND.play('heavy_explode');
        BATTLE_DRAW.screenShake();

        // â‘¢ ã‚¿ã‚¤ãƒˆãƒ«æ–‡å­—ã‚’éš ã—ã¦ã€Œæºœã‚ã€ã‚’ä½œã‚‹
        title.style.opacity = 0; 

        // â‘£ 600mså¾Œã«ãƒ‰ã‚«ãƒ¼ãƒ³ï¼
        setTimeout(() => {
            modal.style.display = 'flex';
            
            // ãƒ†ã‚­ã‚¹ãƒˆè¨­å®š
            title.innerText = "ALL CLEAR!!";
            title.style.color = "#ffd700"; 
            sub.innerText = "THANK YOU FOR PLAYING!";
            
            // ã‚´ãƒƒãƒ‰ãƒ¬ã‚¤ï¼ˆå¾Œå…‰ï¼‰è¿½åŠ 
            const rays = document.createElement('div');
            rays.className = 'god-rays';
            modal.insertBefore(rays, modal.firstChild);

            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é©ç”¨ï¼ˆå©ãã¤ã‘ï¼‰
            title.classList.add('slam-anim');
            
            // éŸ³ï¼šãƒ•ã‚¡ãƒ³ãƒ•ã‚¡ãƒ¼ãƒ¬çš„ãªé€£ç¶šéŸ³
            SOUND.play('levelup'); 
            setTimeout(() => SOUND.play('count'), 200);

            // ç´™å¹é›ªä¹±èˆ
            BATTLE_DRAW.victoryConfetti();
            setTimeout(() => BATTLE_DRAW.victoryConfetti(), 400);

        }, 600); // â˜…ã“ã®é…å»¶ãŒæ°—æŒã¡ã‚ˆã•ã®ãƒã‚¤ãƒ³ãƒˆ
    }
  },

  endBattle: () => {
    BATTLE.stop(); // â˜…ã“ã“ãŒé‡è¦ï¼æ¬¡ã«è¡Œãå‰ã«ä»Šã®ãƒãƒˆãƒ«ã‚’æ­¢ã‚ã‚‹
    SOUND.stopBGM();
    document.getElementById('result-modal').style.display = 'none';

    // â–¼â–¼â–¼ Practiceãªã‚‰ã‚¿ã‚¤ãƒˆãƒ«ã¸ã€Survivalãªã‚‰ã‚·ãƒ§ãƒƒãƒ—ã¸ â–¼â–¼â–¼
    if (BATTLE_STATE.lastResult === 'lose' || BATTLE_STATE.lastResult === 'clear' || STATE.mode === 'practice') {
        GAME.goToTitle();
    } else {
        GAME.goToHangar();
    }
    // â–²â–²â–²
  },

  runCountdown: (num) => {
    const el = document.getElementById('layer-count');
    if(!el) return;
    el.className = ''; void el.offsetWidth;
    if (num > 0) {
      el.innerText = num; el.className = 'count-anim'; el.style.color = '#fff'; 
      SOUND.play('count');
      setTimeout(() => { BATTLE.runCountdown(num - 1); }, 1000);
    } else {
      el.innerText = "GO!"; el.className = 'count-anim'; el.style.color = '#0ff'; 
      SOUND.play('go');
      setTimeout(() => { el.className = ''; el.innerText = ""; BATTLE_STATE.running = true; }, 1000);
    }
  },

  initEntities: () => {
    // 1. å‘³æ–¹ (Player) ã®è¨­å®š
    const pSlots = ['p_supp', 'p_atk', 'p_tank'];
    pSlots.forEach((slotId, idx) => {
        const uId = STATE.inventory.units[idx];
        const selectedUnit = DB.units.find(u => u.id === uId) || DB.units.find(u => u.id === 'golden');
        let pDef = { ...UNIT_DEFS[slotId] };

        if (selectedUnit) {
            document.getElementById(slotId).style.backgroundImage = `url('${selectedUnit.img}')`;
            pDef.charId = selectedUnit.id;
            if (selectedUnit.role) pDef.role = selectedUnit.role.toLowerCase();
            if (selectedUnit.level) pDef.level = selectedUnit.level; 
            if (selectedUnit.hp) pDef.hp = selectedUnit.hp;
            if (selectedUnit.atk) pDef.atk = selectedUnit.atk;
            if (selectedUnit.spd) pDef.castTime = selectedUnit.spd;
        }
        BATTLE.spawn(slotId, pDef);
    });

    // 2. æ•µ (Enemy) ã®è¨­å®š
    const roles = ['supp', 'atk', 'tank'];
    
    // ã‚¹ã‚«ã‚¦ãƒˆç”»é¢ã§ç”Ÿæˆã—ãŸãƒ¦ãƒ‹ãƒƒãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ã†
    let presetUnits = null;
    if (STATE.mode === 'survival' && GAME.nextMatch) {
        presetUnits = GAME.nextMatch.units;
    }

    roles.forEach((role, idx) => {
        const slotId = `e_${role}`;
        let eDef = { ...UNIT_DEFS[slotId] };
        let selectedUnit = null;

        if (presetUnits && presetUnits[idx]) {
            selectedUnit = presetUnits[idx];
        } else {
            // ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆï¼ˆç·´ç¿’ãƒ¢ãƒ¼ãƒ‰ãªã©ï¼‰
            let candidates = DB.units.filter(u => u.role === role.toUpperCase());
            if (STATE.mode === 'practice') {
                if (role === 'supp') candidates = [ DB.units.find(u => u.id === 'thislove') ];
                if (role === 'atk')  candidates = [ DB.units.find(u => u.id === 'taki') ];
                if (role === 'tank') candidates = [ DB.units.find(u => u.id === 'golden') ];
            }
            selectedUnit = candidates[Math.floor(Math.random() * candidates.length)];
        }
        
        if (selectedUnit) {
            document.getElementById(slotId).style.backgroundImage = `url('${selectedUnit.img}')`;
            eDef.charId = selectedUnit.id;
            if (selectedUnit.role) eDef.role = selectedUnit.role.toLowerCase();
            if (selectedUnit.spd) eDef.castTime = selectedUnit.spd;

            // â˜…ãƒ¬ãƒ™ãƒ«è¨ˆç®—ï¼šæ¸¡ã•ã‚ŒãŸãƒ¬ãƒ™ãƒ«ã«åŸºã¥ã„ã¦ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å¼·åŒ–
            eDef.level = selectedUnit.level || 1;
            
            // ãƒ™ãƒ¼ã‚¹å€¤ã®å–å¾—
            let hp = selectedUnit.hp || eDef.hp;
            let atk = selectedUnit.atk || eDef.atk;
            
            // ãƒ¬ãƒ™ãƒ«-1å›åˆ†ã ã‘1.3å€ã«ã™ã‚‹
            for (let i = 1; i < eDef.level; i++) {
                hp = Math.floor(hp * 1.3);
                atk = Math.floor(atk * 1.3);
            }
            
            // ãƒ‘ãƒƒã‚·ãƒ–åŠ¹æœ (HP UP) ãŒã‚ã‚Œã°æ›´ã«ä¸Šä¹—ã›
            if (BATTLE_STATE.enemyUpgrades.includes('u_hp')) {
                hp = Math.floor(hp * 1.1);
            }

            eDef.hp = hp;
            eDef.atk = atk;

        } else {
            document.getElementById(slotId).style.backgroundImage = `url('char_golden.png')`;
            eDef.charId = 'golden';
        }
        BATTLE.spawn(slotId, eDef);
    });

    // 3. ãã®ä»– (Mob, Boss)
    [0, 1, 2].forEach(i => BATTLE.spawn(`mob_${i}`, UNIT_DEFS.mob));
    document.getElementById('p_boss').style.backgroundImage = "url('boss.png')";
    document.getElementById('e_boss').style.backgroundImage = "url('boss.png')";
    
    BATTLE_STATE.units['p_boss'] = { id:'p_boss', team:'p', max:3500, hp:3500, dead:false };
    BATTLE_STATE.units['e_boss'] = { id:'e_boss', team:'e', max:3500, hp:3500, dead:false };
    BATTLE_STATE.pCoreTimer = 2.0 + Math.random() * 3.0;
    BATTLE_STATE.eCoreTimer = 2.0 + Math.random() * 3.0;
  },



  spawn: (id, def) => {
    let hpMod = 1.0;
    // â–¼ è¿½åŠ : HP_PATCH_v1.0 (å‘³æ–¹HP +10%)
    if (def.team === 'p' && STATE.inventory.upgrades.includes('u_hp')) {
        hpMod = 1.1;
    }

    const maxHp = Math.floor(def.hp * hpMod);
    
    BATTLE_STATE.units[id] = {
      id: id, ...def, max: maxHp, hp: maxHp,
      
      // â˜… å¤‰æ›´ï¼šæ¸¡ã•ã‚ŒãŸãƒ¬ãƒ™ãƒ«ãŒã‚ã‚Œã°ãã‚Œã‚’ä½¿ã„ã€ãªã‘ã‚Œã°1ã«ã™ã‚‹
      lv: def.level || 1, 
      
      xp: 0, nxt: SPECS.xp_req,
      // ... (ä»¥ä¸‹ç•¥) ...
      cd: 0, maxCd: 1, cast: 0, maxCast: 1, act: null, 
      dead: false, rt: 0, buffs: [],
      reserve: null, reservedCardIdx: null,

  vulnStacks: 0 
    };
  },

  fillHand: (idx) => {
    if (BATTLE_STATE.hand[idx]) return;
    
    // Draw from Player Inventory (STATE.deck.cards)
    let cardDef = null;
    if (STATE.deck.cards.length > 0) {
       const randId = STATE.deck.cards[Math.floor(Math.random() * STATE.deck.cards.length)];
       cardDef = CARD_MAP[randId] || CARD_MAP['heal'];
    } else {
       // Fallback Deck
       const defaults = Object.values(CARD_MAP);
       cardDef = defaults[Math.floor(Math.random() * defaults.length)];
    }

    BATTLE_STATE.hand[idx] = { ...cardDef, idx: idx, cast: 0, maxCast: 1, reload: 0, maxReload: SPECS.cd.card_reload, reservedTarget: null }; 
    const slot = document.getElementById(`slot-${idx}`);
    if(!slot) return;
    const old = slot.querySelector('.card'); if(old) old.remove();
    const el = document.createElement('div');
    el.className = `card`; el.innerText = cardDef.name;
    el.style.borderColor = cardDef.type === 'atk' ? '#f05' : '#0ff';
    el.style.color = cardDef.type === 'atk' ? '#f05' : '#0ff';
    slot.appendChild(el);
  },

  fillEnemyHand: (idx) => {
      // æ•µã®ãƒ‡ãƒƒã‚­(BATTLE_STATE.enemyDeck)ã®ä¸­ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã«å¼•ã
      const deckIds = BATTLE_STATE.enemyDeck;

      // ã‚¨ãƒ©ãƒ¼å›é¿ï¼šã‚‚ã—ãƒ‡ãƒƒã‚­ãŒç©ºãªã‚‰ãƒ’ãƒ¼ãƒ«ã‚’å…¥ã‚Œã‚‹
      if (!deckIds || deckIds.length === 0) {
          BATTLE_STATE.enemyHand[idx].cardId = 'heal'; 
      } else {
          const randId = deckIds[Math.floor(Math.random() * deckIds.length)];
          BATTLE_STATE.enemyHand[idx].cardId = randId;
      }
      BATTLE_STATE.enemyHand[idx].reload = 0;
  },


  update: () => {
    if (!BATTLE_STATE.running) return;

    // â–¼â–¼â–¼ ä¿®æ­£: æ•µå‘³æ–¹ãã‚Œãã‚Œã®ãƒ¬ãƒ¼ã‚¶ãƒ¼é€Ÿåº¦è¨­å®š â–¼â–¼â–¼
    const pLaserSpd = STATE.inventory.upgrades.includes('u_laser_spd') ? 1.5 : 1.0;
    // æ•µã‚‚ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã‚’æŒã£ã¦ã„ã‚Œã°é€Ÿããªã‚‹
    const eLaserSpd = BATTLE_STATE.enemyUpgrades.includes('u_laser_spd') ? 1.5 : 1.0;
    
    BATTLE_STATE.pCoreTimer -= 0.05 * pLaserSpd;
    if (BATTLE_STATE.pCoreTimer <= 0) { BATTLE.fireCoreBit('p'); BATTLE_STATE.pCoreTimer = 6.0 + Math.random() * 4.0; }

    // â˜…æ•µã®ã‚¿ã‚¤ãƒãƒ¼ã«ã‚‚å€ç‡ã‚’é©ç”¨
    BATTLE_STATE.eCoreTimer -= 0.05 * eLaserSpd;
    if (BATTLE_STATE.eCoreTimer <= 0) { BATTLE.fireCoreBit('e'); BATTLE_STATE.eCoreTimer = 6.0 + Math.random() * 4.0; }

    // â–¼â–¼â–¼ ä¿®æ­£: CDçŸ­ç¸®ã¨ATKé€Ÿåº¦ã®è¨­å®š â–¼â–¼â–¼
    const pCdMod = STATE.inventory.upgrades.includes('u_cd') ? 1.1 : 1.0;
    const eCdMod = BATTLE_STATE.enemyUpgrades.includes('u_cd') ? 1.1 : 1.0;
    
    const pAtkMod = STATE.inventory.upgrades.includes('u_atk') ? 1.2 : 1.0;
    const eAtkMod = BATTLE_STATE.enemyUpgrades.includes('u_atk') ? 1.2 : 1.0;

    Object.values(BATTLE_STATE.units).forEach(u => {
      if (u.dead) { u.rt -= 0.05; if (u.rt <= 0) BATTLE.revive(u); return; }

      let speedMod = 1.0;
      if (u.buffs && u.buffs.length > 0) {
          u.buffs.forEach(b => b.time -= 0.05);
          const juice = u.buffs.find(b => b.type === 'juice');
          if (juice) speedMod = juice.val;
          u.buffs = u.buffs.filter(b => b.time > 0);
      }

      // â–¼â–¼â–¼ ä¿®æ­£: CDçŸ­ç¸®ã‚’ãƒãƒ¼ãƒ ã”ã¨ã«é©ç”¨ â–¼â–¼â–¼
      let finalCdSpeed = speedMod;
      if (u.team === 'p') finalCdSpeed *= pCdMod; 
      if (u.team === 'e') finalCdSpeed *= eCdMod; // â˜…æ•µã«ã‚‚é©ç”¨

      if (u.cd > 0) {
        u.cd -= 0.05 * finalCdSpeed;
        if (u.cd <= 0) {
           u.cd = 0;
           if (u.reserve) {
             const t = BATTLE_STATE.units[u.reserve.tid];
             if (t && !t.dead) { BATTLE.setAction(u, u.reserve.tid); }
             u.reserve = null;
           }
        }
      }
      if (u.shieldTime > 0) { u.shieldTime -= 0.05; if (u.shieldTime <= 0) u.hasShield = false; }
// ä¿®æ­£å‰
// if (u.vulnTime > 0) { u.vulnTime -= 0.05; if (u.vulnTime <= 0) u.vuln = false; }

// â–¼â–¼â–¼ ä¿®æ­£å¾Œï¼šæ™‚é–“åˆ‡ã‚Œã§ã‚¹ã‚¿ãƒƒã‚¯ã‚‚ãƒªã‚»ãƒƒãƒˆ â–¼â–¼â–¼
if (u.vulnTime > 0) { 
    u.vulnTime -= 0.05; 
    if (u.vulnTime <= 0) {
        u.vuln = false;
        u.vulnStacks = 0; // ã‚¹ã‚¿ãƒƒã‚¯ã‚‚0ã«æˆ»ã™
    }
}
// â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–²


      // â–¼â–¼â–¼ ä¿®æ­£: è© å”±é€Ÿåº¦(ATK)ã‚’ãƒãƒ¼ãƒ ã”ã¨ã«é©ç”¨ â–¼â–¼â–¼
      let finalCastSpeed = speedMod;
      if (u.role === 'atk') {
          if (u.team === 'p') finalCastSpeed *= pAtkMod;
          if (u.team === 'e') finalCastSpeed *= eAtkMod; // â˜…æ•µã«ã‚‚é©ç”¨
      }
      
      if (u.cast > 0) { u.cast -= 0.05 * finalCastSpeed; if (u.cast <= 0) BATTLE.commit(u); }
    });

    // â–¼ è¿½åŠ : QUICK_LOADER (ã‚«ãƒ¼ãƒ‰ãƒªãƒ­ãƒ¼ãƒ‰çŸ­ç¸® 20% = é€Ÿåº¦1.25å€)
    // â€»ã“ã“ã¯ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ‰‹æœ­ã ã‘ãªã®ã§å¤‰æ›´ãªã—
    const reloadSpd = STATE.inventory.upgrades.includes('u_quick') ? 1.25 : 1.0;

        BATTLE_STATE.hand.forEach((c, i) => {
      if (!c) return;

      // â˜…è¿½åŠ ï¼šQUICKç­‰ã®ã€Œäºˆç´„ä¸­(reservedTargetã‚ã‚Š)ã€ã‚«ãƒ¼ãƒ‰ã®æ•‘æ¸ˆå‡¦ç†
      if (c.reservedTarget) {
          const u = BATTLE_STATE.units[c.reservedTarget];
          // ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãŒã€Œå­˜åœ¨ã—ãªã„ã€ã€Œæ­»ã‚“ã§ã„ã‚‹ã€ã€Œè© å”±ã—ã¦ã„ãªã„ï¼ˆã‚¹ã‚¿ãƒ³ç­‰ã§ä¸­æ–­ã•ã‚ŒãŸï¼‰ã€å ´åˆ
          if (!u || u.dead || u.cast <= 0) {
              // äºˆç´„ã‚’å¼·åˆ¶è§£é™¤ã—ã¦ã€ã¾ãŸä½¿ãˆã‚‹ã‚ˆã†ã«æˆ»ã™
              c.reservedTarget = null;
          }
      }

      if (c.cast > 0) { c.cast -= 0.05; if (c.cast <= 0) BATTLE.commitCard(c); }
      if (c.reload > 0) { c.reload -= 0.05 * reloadSpd; if (c.reload <= 0) { BATTLE_STATE.hand[i] = null; BATTLE.fillHand(i); } }
    });
    
    // (æ•µã®ãƒ­ã‚¸ãƒƒã‚¯çœç•¥) ã®éƒ¨åˆ†ã‚’ä»¥ä¸‹ã«å·®ã—æ›¿ãˆ
    ['e_atk','e_tank','e_supp'].forEach((uid, idx) => {
      const u = BATTLE_STATE.units[uid];
      if (!u || u.dead || u.cd > 0 || u.cast > 0) {
          u.aiWait = null; // å‹•ä½œä¸­ãªã‚‰ãƒªã‚»ãƒƒãƒˆ
          return;
      }

      // â–  æ€è€ƒæ™‚é–“ï¼ˆAI Waitï¼‰ã®ç®¡ç†
      if (u.aiWait === null || u.aiWait === undefined) {
          // â–¼â–¼â–¼ ä¿®æ­£ï¼šå…¨ã‚¹ãƒ†ãƒ¼ã‚¸å…±é€šã®è¨­å®š â–¼â–¼â–¼
          // 20ãƒ•ãƒ¬ãƒ¼ãƒ  = 1ç§’ (updateã¯50msé–“éš”)
          // å¸¸ã« 0.5ç§’ ï½ 2.0ç§’ ã®é–“ã§ãƒ©ãƒ³ãƒ€ãƒ ã«è¿·ã†ã‚ˆã†ã«ã™ã‚‹
          let minWait = 10; 
          let maxWait = 40; 

          // â€»ã‚‚ã—é›£æ˜“åº¦ã€ŒOMGã€ã§ãƒ—ãƒ¬ã‚¤ã—ã¦ã„ã¦ã€Œé€Ÿã™ãã‚‹ã€ã¨æ„Ÿã˜ã‚‹å ´åˆã¯
          // ã“ã“ã®æ•°å€¤ã‚’ minWait = 10; maxWait = 30; ãã‚‰ã„ã«èª¿æ•´ã—ã¦ãã ã•ã„
          if (BATTLE_STATE.difficulty === 'hard') { minWait = 5; maxWait = 20; }
          if (BATTLE_STATE.difficulty === 'omg')  { minWait = 2; maxWait = 10; }
          
          u.aiWait = minWait + Math.floor(Math.random() * (maxWait - minWait));
      }

      // æ€è€ƒä¸­...
      if (u.aiWait > 0) {
          u.aiWait--;
          return; 
      }

      // æ€è€ƒå®Œäº†ï¼æ”»æ’ƒã‚’å®Ÿè¡Œ
      BATTLE.runEnemyLogic(u, idx);
      u.aiWait = null;
    });

    BATTLE_STATE.enemyHand.forEach((slot, idx) => {
      if (slot.reload > 0) { slot.reload -= 0.05; if (slot.reload <= 0) { slot.reload = 0; BATTLE.fillEnemyHand(idx); } }
      if (slot.act && slot.cast > 0) { slot.cast -= 0.05; if (slot.cast <= 0) BATTLE.commitEnemyCard(slot, idx); } 
      else if (slot.cd > 0) { slot.cd -= 0.05; } 
      else if (slot.reload <= 0) { BATTLE.enemyCardAI(idx); }
    });
    
  },


  fireCoreBit: (team) => {
      // ã‚¿ãƒ¼ã‚²ãƒƒãƒˆé¸å®šãƒ­ã‚¸ãƒƒã‚¯
      const mobs = ['mob_0', 'mob_1', 'mob_2'].filter(id => !BATTLE_STATE.units[id].dead);
      let targets = [...mobs];
      
      // â–¼ è¿½åŠ : TARGET_UNLOCK (æ•µã‚­ãƒ£ãƒ©ã‚‚ç‹™ã†)
      if (team === 'p' && STATE.inventory.upgrades.includes('u_laser2')) {
          ['e_atk','e_tank','e_supp'].forEach(id => {
              const u = BATTLE_STATE.units[id];
              if(u && !u.dead) targets.push(id);
          });
      }

      // â–¼ è¿½åŠ : REPAIR_PROTOCOL (å‘³æ–¹ã‚’å›å¾©ã™ã‚‹ãƒ¬ãƒ¼ã‚¶ãƒ¼ã‚’ç¢ºç‡ã§æ’ƒã¤)
      if (team === 'p' && STATE.inventory.upgrades.includes('u_heal_laser') && Math.random() < 0.4) {
          // å‘³æ–¹ã§HPãŒæ¸›ã£ã¦ã„ã‚‹ã‚­ãƒ£ãƒ©ã‚’æ¢ã™
          const injured = ['p_atk','p_tank','p_supp'].filter(id => {
              const u = BATTLE_STATE.units[id]; return u && !u.dead && u.hp < u.max;
          });
          if (injured.length > 0) {
              const tId = injured[Math.floor(Math.random() * injured.length)];
              BATTLE_DRAW.fireBit('p_boss', tId, '#0f0', () => {
                 BATTLE.heal(BATTLE_STATE.units[tId], 50); 
              });
              return; // æ”»æ’ƒã¯ã—ãªã„
          }
      }

      if (targets.length === 0) return;
      const targetId = targets[Math.floor(Math.random() * targets.length)];
      const sourceId = team === 'p' ? 'p_boss' : 'e_boss';
      const color = team === 'p' ? '#0ff' : '#f05';
      
      BATTLE_DRAW.fireBit(sourceId, targetId, color, () => {
          const m = BATTLE_STATE.units[targetId];
          if(m && !m.dead) { 
              BATTLE.damage(m, 80, BATTLE_STATE.units[sourceId]); 
              SOUND.play('bit'); 
          }
      });
  },

  runEnemyLogic: (u, idx) => {
    // ãƒ‡ãƒ¼ã‚¿å–å¾—
    const allies = ['e_atk', 'e_tank', 'e_supp'].map(id => BATTLE_STATE.units[id]).filter(a => a && !a.dead);
    const players = ['p_atk', 'p_tank', 'p_supp'].map(id => BATTLE_STATE.units[id]).filter(p => p && !p.dead);
    const mobs = ['mob_0', 'mob_1', 'mob_2'].map(id => BATTLE_STATE.units[id]).filter(m => m && !m.dead);
    
    // å…¨ã¦ã®æœ‰åŠ¹ãªã‚¿ãƒ¼ã‚²ãƒƒãƒˆå€™è£œï¼ˆãƒ¢ãƒ–ï¼‹ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼‹ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚³ã‚¢ï¼‰
    let candidates = [...mobs.map(m=>m.id), ...players.map(p=>p.id), 'p_boss'];

    // å„ªå…ˆã‚¿ãƒ¼ã‚²ãƒƒãƒˆï¼ˆã“ã‚Œã‚’è¨­å®šã™ã‚‹ã¨ç¢ºå®šï¼‰
    let priorityTarget = null;

    // ------------------------------------------------
    // â–  ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å›ºæœ‰ãƒ­ã‚¸ãƒƒã‚¯
    // ------------------------------------------------

    // 1. Taki: ãƒ¢ãƒ–ã®ãƒ©ã‚¹ãƒˆãƒ’ãƒƒãƒˆã‚’ç‹™ã†
    if (u.charId === 'taki') {
        // ãƒ¢ãƒ–ã¸ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ã¯2å€ãªã®ã§ã€(ç¾åœ¨ã®HP <= æ”»æ’ƒåŠ›*2) ã®ãƒ¢ãƒ–ã‚’æ¢ã™
        const killableMob = mobs.find(m => m.hp <= u.atk * 2.0);
        if (killableMob) priorityTarget = killableMob.id;
    }

    // 2. However: Lv3ã«ãªã‚‹ã¾ã§ã‚³ã‚¢ã‚’ç‹™ã‚ãªã„
    else if (u.charId === 'however') {
        const pBossHp = BATTLE_STATE.units['p_boss'].hp;
        // ãƒ¬ãƒ™ãƒ«3æœªæº€ã€ã‹ã¤æ•µã‚³ã‚¢HPãŒååˆ†ã‚ã‚‹ãªã‚‰ã€å€™è£œã‹ã‚‰p_bossã‚’å¤–ã™
        if (u.lv < 3 && pBossHp > 500) {
            candidates = candidates.filter(id => id !== 'p_boss');
        }
    }

    // 3. This love: å‘³æ–¹ãŒæ”»æ’ƒå‹•ä½œã«å…¥ã£ãŸã‚‰ã€ãƒ©ãƒ³ãƒ€ãƒ ãªæ•µã‚’ã‚¹ã‚¿ãƒ³ã•ã›ã«ã„ã
    else if (u.charId === 'thislove') {
        // è‡ªåˆ†ä»¥å¤–ã®å‘³æ–¹ãŒè© å”±ä¸­ã‹ï¼Ÿ
        const allyCasting = allies.some(a => a.id !== u.id && a.cast > 0);
        if (allyCasting && players.length > 0) {
            // ãƒ©ãƒ³ãƒ€ãƒ ãªãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ç‹™ã†
            priorityTarget = players[Math.floor(Math.random() * players.length)].id;
        }
    }

    // 4. Cheerleader: CDä¸­ã®æ•µã‚’ç‹™ã†
    else if (u.charId === 'cheer') {
        const cdPlayer = players.find(p => p.cd > 0);
        if (cdPlayer) priorityTarget = cdPlayer.id;
    }

    // 5. Golden: ç‹™ã‚ã‚Œã¦ã„ã‚‹å‘³æ–¹ã«ãƒãƒªã‚¢ (å‘³æ–¹ã‚¿ã‚²)
    else if (u.charId === 'golden') {
        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®èª°ã‹ã‹ã‚‰ç‹™ã‚ã‚Œã¦ã„ã‚‹å‘³æ–¹ã‚’æ¢ã™ï¼ˆâ˜…ä¿®æ­£ï¼šè‡ªåˆ†ä»¥å¤–ï¼‰
        const threatened = allies.find(a => a.id !== u.id && players.some(p => p.act && p.act.tid === a.id));
        if (threatened) {
            BATTLE.setAction(u, threatened.id); // setActionã§å³æ™‚å®Ÿè¡Œ
            return;
        }
    }

    // 6. Old town road: HP60%ä»¥ä¸‹ã®å‘³æ–¹ã‚’å›å¾© (å‘³æ–¹ã‚¿ã‚²)
    else if (u.charId === 'oldtown') {
        // ï¼ˆâ˜…ä¿®æ­£ï¼šè‡ªåˆ†ä»¥å¤–ã§ã€HPãŒæ¸›ã£ã¦ã„ã‚‹å‘³æ–¹ï¼‰
        const injured = allies.find(a => a.id !== u.id && a.hp < a.max * 0.6);
        if (injured) {
            BATTLE.setAction(u, injured.id);
            return;
        }
    }

    // 7. Wata: åºç›¤(Lv3æœªæº€)ã¯ç©æ¥µçš„ã«å‘³æ–¹ã‚’æ®´ã£ã¦è‚²æˆ (å‘³æ–¹ã‚¿ã‚²)
    else if (u.charId === 'wata') {
        // ï¼ˆâ˜…ä¿®æ­£ï¼šè‡ªåˆ†ä»¥å¤–ã§ã€Lv3æœªæº€ã®å‘³æ–¹ï¼‰
        const lowLvAlly = allies.find(a => a.id !== u.id && a.lv < 3); 
        if (lowLvAlly) {
            BATTLE.setAction(u, lowLvAlly.id);
            return;
        }
    }


    // â–¼â–¼â–¼ è¿½åŠ ï¼šã‚µãƒã‚¤ãƒãƒ«çµ‚ç›¤(æ®‹ã‚Š50ç§’)ï¼†è² ã‘ã¦ã‚‹ãªã‚‰ã€æˆ¦è¡“ã‚’æ¨ã¦ã¦ã‚³ã‚¢ç‰¹æ”» â–¼â–¼â–¼
    if (STATE.mode === 'survival' && BATTLE_STATE.time <= 50) {
        const eHP = BATTLE_STATE.units['e_boss'].hp;
        const pHP = BATTLE_STATE.units['p_boss'].hp;
        
        // è‡ªåˆ†ã®HPãŒç›¸æ‰‹ã‚ˆã‚Šä½ã„ï¼ˆè² ã‘ã¦ã„ã‚‹ï¼‰å ´åˆ
        if (eHP < pHP) {
            // ä»–ã®å„ªå…ˆé †ä½ï¼ˆãƒ¢ãƒ–ç‹™ã„ã‚„å¼±ã£ãŸæ•µç‹™ã„ãªã©ï¼‰ã‚’å…¨ã¦ç„¡è¦–ã—ã¦ã‚³ã‚¢ã‚’ç‹™ã†
            priorityTarget = 'p_boss';
        }
    }
    // â–²â–²â–² è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–²

    // ------------------------------------------------
    // â–  å…¨ä½“å…±æœ‰ãƒ­ã‚¸ãƒƒã‚¯ (PoPãƒ‡ãƒãƒ•ã¸ã®ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ãªã©)
    // ------------------------------------------------
    
    // PoPã¾ãŸã¯å‘³æ–¹ãŒä»˜ä¸ã—ãŸã€ŒWEAK(vuln)ã€çŠ¶æ…‹ã®æ•µãŒã„ã‚Œã°æœ€å„ªå…ˆ
    if (!priorityTarget) {
        // å¼±ä½“åŒ–ä¸­ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‹ãƒ¢ãƒ–ã‚’æ¢ã™
        const weakUnit = [...players, ...mobs].find(t => t.vuln);
        if (weakUnit) priorityTarget = weakUnit.id;
    }

    // ------------------------------------------------
    // â–  ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
    // ------------------------------------------------

    if (priorityTarget) {
        BATTLE.setAction(u, priorityTarget);
    } else {
        // ç‰¹ã«ãªã‘ã‚Œã°å€™è£œã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã€ã¾ãŸã¯æ¨™æº–çš„ãªå‹•ã
        // (ã‚³ã‚¢ã‚’æ®´ã‚‹ç¢ºç‡ã¯çŠ¶æ³ã«ã‚ˆã‚‹ãŒã€ã“ã“ã§ã¯ç°¡æ˜“çš„ã«å€™è£œã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ )
        if (candidates.length > 0) {
            const finalTid = candidates[Math.floor(Math.random() * candidates.length)];
            BATTLE.setAction(u, finalTid);
        } else {
            // å€™è£œãªã—ãªã‚‰ã¨ã‚Šã‚ãˆãšãƒœã‚¹
            BATTLE.setAction(u, 'p_boss');
        }
    }
  },

  enemyCardAI: (slotIdx) => {
    const slot = BATTLE_STATE.enemyHand[slotIdx];
    if (slot.act || slot.reload > 0 || !slot.cardId) return; 

    // â–¼â–¼â–¼ è¿½åŠ ï¼šã‚‚ã†ç‰‡æ–¹ã®ã‚¹ãƒ­ãƒƒãƒˆãŒè© å”±ä¸­ãªã‚‰å¾…æ©Ÿã™ã‚‹ï¼ˆåŒæ™‚ç™ºå‹•é˜²æ­¢ï¼‰ â–¼â–¼â–¼
    const otherIdx = slotIdx === 0 ? 1 : 0;
    const otherSlot = BATTLE_STATE.enemyHand[otherIdx];
    if (otherSlot && (otherSlot.act || otherSlot.cast > 0)) return;

    // â–¼â–¼â–¼ ä¿®æ­£ï¼šé›£æ˜“åº¦ã”ã¨ã®æ€è€ƒé »åº¦èª¿æ•´ï¼ˆæºœã‚ã‚’ä½œã‚‹ï¼‰ â–¼â–¼â–¼
    // updateã¯50msæ¯ã«èµ°ã‚‹ãŸã‚ã€ç¢ºç‡ã¯ã‹ãªã‚Šä½ãè¨­å®šã—ãªã„ã¨ã™ãæ’ƒã£ã¦ã—ã¾ã„ã¾ã™
    let threshold = 0.995; // Normal: 0.5% (ç´„2ã€œ4ç§’ã«1å›)

    if (BATTLE_STATE.difficulty === 'easy') threshold = 0.998; // Easy: 0.2% (ã‹ãªã‚Šé…ã„)
    if (BATTLE_STATE.difficulty === 'hard') threshold = 0.985; // Hard: 1.5%
    // OMGã¯åˆ¶é™ãªã—ï¼ˆå³æ’ƒã¡ï¼‰

    if (BATTLE_STATE.difficulty !== 'omg' && Math.random() < threshold) return; 

    const cardId = slot.cardId;
    let targetId = null;
    // ... (ä»¥ä¸‹ã®ãƒ­ã‚¸ãƒƒã‚¯ã¯ãã®ã¾ã¾

    // ç”Ÿå­˜ãƒ¦ãƒ‹ãƒƒãƒˆå–å¾—
    const allies = ['e_atk', 'e_tank', 'e_supp'].map(id => BATTLE_STATE.units[id]).filter(u => u && !u.dead);
    const players = ['p_atk', 'p_tank', 'p_supp'].map(id => BATTLE_STATE.units[id]).filter(u => u && !u.dead);
    const mobs = ['mob_0', 'mob_1', 'mob_2'].map(id => BATTLE_STATE.units[id]).filter(u => u && !u.dead);

    // â–¼ RAGE: æ”»æ’ƒåŠ›ã®é«˜ã„ã‚­ãƒ£ãƒ©ã¸
    if (cardId === 'rage') {
        if (allies.length > 0) {
            allies.sort((a, b) => b.atk - a.atk);
            targetId = allies[0].id;
        }
    }
    
    // â–¼ JUICE / GROW: ãƒ©ãƒ³ãƒ€ãƒ 
    else if (cardId === 'juice' || cardId === 'grow') {
        if (allies.length > 0) targetId = allies[Math.floor(Math.random() * allies.length)].id;
    }

    // â–¼ QUICK: ãƒ©ãƒ³ãƒ€ãƒ ãªã‚­ãƒ£ãƒ©ãŒãƒœã‚¹ã‚’æ®´ã£ã¦ã€ãã®ã‚­ãƒ£ãƒ©ã«ä½¿ã†
    else if (cardId === 'quick') {
        if (allies.length > 0) {
            const actor = allies[Math.floor(Math.random() * allies.length)];
            // å¼·åˆ¶çš„ã«ãƒœã‚¹æ”»æ’ƒå‘½ä»¤ã‚’ã‚»ãƒƒãƒˆ
            BATTLE.setAction(actor, 'p_boss'); 
            targetId = actor.id;
        }
    }

    // â–¼ HEAL: HPãŒæ¸›ã£ã¦ã‚‹ã‚­ãƒ£ãƒ© or ç©ºæ’ƒã¡
    else if (cardId === 'heal') {
        const injured = allies.find(u => u.hp < u.max * 0.8);
        if (injured) targetId = injured.id;
        else if (allies.length > 0) targetId = allies[Math.floor(Math.random() * allies.length)].id;
    }

    // â–¼ SHIELD: ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‹ã‚‰ç‹™ã‚ã‚Œã¦ã„ã‚‹å‘³æ–¹ or ç©ºæ’ƒã¡
    else if (cardId === 'shld') {
        const targetedAlly = allies.find(a => players.some(p => p.act && p.act.tid === a.id));
        if (targetedAlly) targetId = targetedAlly.id;
        else if (allies.length > 0) targetId = allies[Math.floor(Math.random() * allies.length)].id;
    }

    // â–¼ LilSTUN: ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®äºˆå‚™å‹•ä½œ(cast > 0)ã«åˆã‚ã›ã¦
    else if (cardId === 'lstun') {
        const castingPlayer = players.find(p => p.cast > 0);
        if (castingPlayer) targetId = castingPlayer.id;
    }

    // â–¼ BOM: å‘³æ–¹ãŒæ­»ãªãªã„ OR å‘³æ–¹ãŒæ­»ã‚“ã§ã‚‚ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’è¤‡æ•°å€’ã›ã‚‹
    else if (cardId === 'bom') {
        const lv = BATTLE_STATE.enemyCardLevels[cardId] || 1;
        const dmgVals = [30, 60, 90]; 
        const bomDmg = dmgVals[lv - 1] || 30;

        const allyDeaths = allies.filter(a => a.hp <= bomDmg).length;
        
        // â˜…ä¿®æ­£ï¼šã“ã“ã§ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å´ã®æ­»äº¡æ•°ã‚‚è¨ˆç®—ã™ã‚‹
        const playerDeaths = players.filter(p => p.hp <= bomDmg).length;

        // å‘³æ–¹è¢«å®³ãªã—ã€ã¾ãŸã¯ ç‰¹æ”»ï¼ˆæ•µ2ä½“ä»¥ä¸Šé“é€£ã‚Œï¼‰
        if (allyDeaths === 0 || playerDeaths >= 2) {
             targetId = 'p_tank'; 
        }
    }

    // â–¼ FEED: ãƒ¢ãƒ–ã®ãƒ©ã‚¹ãƒˆãƒ’ãƒƒãƒˆå¦¨å®³ or ç©ºæ’ƒã¡
    else if (cardId === 'feed') {
        if (mobs.length > 0) {
            const lowHpMob = mobs.find(m => m.hp < 100);
            if (lowHpMob) targetId = lowHpMob.id;
            else targetId = mobs[Math.floor(Math.random() * mobs.length)].id;
        }
    }

    // å®Ÿè¡Œäºˆç´„
    if (targetId) {
        slot.act = { tid: targetId }; 
        slot.cardId = cardId; 
        slot.cast = SPECS.cast.fast; 
        slot.maxCast = SPECS.cast.fast;
    }
  },

  commitEnemyCard: (slot, idx) => {
      const cid = slot.cardId; const tid = slot.act.tid; const t = BATTLE_STATE.units[tid];
      const cDef = Object.values(CARD_MAP).find(c => c.id === cid); const cName = cDef ? cDef.name : "CARD";
      slot.act = null; slot.cardId = null;

      // â–¼â–¼â–¼ è¿½åŠ : æ•µã®ã‚«ãƒ¼ãƒ‰ãƒ¬ãƒ™ãƒ«ã«å¿œã˜ãŸæ€§èƒ½ã‚’å–å¾— â–¼â–¼â–¼
      const lv = BATTLE_STATE.enemyCardLevels[cid] || 1; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ1
      const dbCard = DB.cards.find(x => x.id === cid);
      const vals = dbCard ? dbCard.vals : [];
      const valIndex = lv - 1; // é…åˆ—ã¯0å§‹ã¾ã‚Š
      // â–²â–²â–²
      
      if (t) { 
          // --- é˜²å¾¡ãƒ»å›å¾©ç³» ---
          if (cid === 'heal' && !t.dead) BATTLE.heal(t, SPECS.val.heal); // HEALã¯å›ºå®šã§OK
          else if (cid === 'shld' && !t.dead) { BATTLE.applyShield(t, 5); BATTLE.heal(t, 100); }
          else if (cid === 'grow' && !t.dead) {
              const growVal = vals[valIndex] || 15;
              BATTLE.addXp(t, growVal);
          }
          else if (cid === 'quick' && !t.dead) { t.cd = 0; }
          
          // --- ãƒãƒ•ç³» ---
          else if (cid === 'rage' && !t.dead) { 
              const rageVal = vals[valIndex] || 1.3;
              t.buffs.push({ type: 'rage', val: rageVal, time: 10.0 });
              BATTLE_DRAW.pop(t.id, "â–² RAGE", "red");
          }
          else if (cid === 'juice' && !t.dead) {
              const juiceVal = vals[valIndex] || 1.3;
              t.buffs.push({ type: 'juice', val: juiceVal, time: 10.0 });
              BATTLE_DRAW.pop(t.id, "â–² JUICE", "orange");
          }

          // --- æ”»æ’ƒãƒ»å¦¨å®³ç³» ---
    else if (cid === 'lstun') { // â˜…ä¿®æ­£: c.id -> cid
        // â–¼â–¼â–¼ ä¿®æ­£ï¼šæ•µã‚‚ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨åŒæ§˜ã€äºˆå‚™å‹•ä½œä¸­ã®ã¿ãƒ’ãƒƒãƒˆã•ã›ã‚‹ â–¼â–¼â–¼
        if (!t.dead && t.cast > 0) {
            const duration = vals[valIndex] || 2.0; // â˜…æ•µå´ã¯ lvIdx ã§ã¯ãªã valIndex
            
            t.cast = 0; 
            t.cd = duration; 
            
            BATTLE_DRAW.fxStun(t.id); SOUND.play('stun');
            BATTLE_DRAW.pop(t.id, `<< STUN ${duration}s >>`, "yellow");
        } else {
            BATTLE_DRAW.pop(t.id, "MISS", "gray"); 
            SOUND.play('cancel'); 
        }
        // â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–²
    }
    // â˜…é‡è¦ï¼šã“ã“ã«è¬ã® else { ... } ãŒæ®‹ã£ã¦ã„ãŸã‚‰å‰Šé™¤ã—ã¦ãã ã•ã„ã€‚
    // ãã®ã¾ã¾ else if (cid === 'bom') ã¸ç¹‹ã’ã¾ã™ã€‚
    
    else if (cid === 'bom') {
        const bomDmg = vals[valIndex] || 100;
        Object.values(BATTLE_STATE.units).forEach(u => {
            if (!u.dead && !u.id.includes('boss') && u.id !== 'e_boss') { 
                BATTLE.damage(u, bomDmg, BATTLE_STATE.units['e_boss']); 
            }
        });
        BATTLE_DRAW.screenShake(); SOUND.play('heavy_explode');
    }
          else if (cid === 'feed') {
              if (!t.dead) { BATTLE.heal(t, 500); }
          }

          if(cid !== 'bom') { 
              BATTLE_DRAW.pop('e_boss', `âš ï¸ ${cName} Lv.${lv}`, '#f05'); // ãƒ¬ãƒ™ãƒ«ã‚‚è¡¨ç¤º
              BATTLE_DRAW.flash('e_boss', tid, 'e');
          } else {
              BATTLE_DRAW.pop('e_boss', `âš ï¸ ${cName} Lv.${lv}`, '#f05'); 
          }
      }
      
      slot.reload = SPECS.cd.card_reload; slot.max = SPECS.cd.card_reload;
  },

  tick: () => {
    if (!BATTLE_STATE.running) return;
    BATTLE_STATE.time--;
    const pHP = BATTLE_STATE.units.p_boss.hp, eHP = BATTLE_STATE.units.e_boss.hp;
    if (Math.abs(pHP - eHP) > 500 && Math.random() < 0.4) {
      const targetTeam = pHP > eHP ? 'p' : 'e';
      const mobs = ['mob_0','mob_1','mob_2'].filter(id => !BATTLE_STATE.units[id].dead);
      if (mobs.length > 0) {
        const m = BATTLE_STATE.units[mobs[Math.floor(Math.random()*mobs.length)]];
        const target = Object.values(BATTLE_STATE.units).find(u => u.team === targetTeam && !u.dead && u.role);
        if (target) { BATTLE.damage(target, 50, null); BATTLE_DRAW.beam(m.id, target.id); BATTLE_DRAW.pop(m.id, "BEAM!", "red"); }
      }
    }
    if (BATTLE_STATE.time <= 0) { BATTLE.showResult(pHP >= eHP ? 'win' : 'lose'); }
  },

  setAction: (u, tid) => {
    if (u.id === tid) return;
    if (!u || u.dead) return; 

    const t = BATTLE_STATE.units[tid]; if (!t) return;
    
    // CDä¸­ã‚„è© å”±ä¸­ã®äºˆç´„å‡¦ç†
    if (u.cd > 0 || u.cast > 0) { 
        u.reserve = { tid: tid }; 
        SOUND.play('ready'); 
        return; 
    }
    
    u.act = { tid: tid };
    let speed = 'atk';
    if (u.role === 'tank' && (t.team === u.team || t.team === 'mob')) speed = 'fast';
    if (u.role === 'supp' && t.team !== 'mob') speed = 'supp';
    if (u.role !== 'tank' && t.team === 'mob') speed = 'mob';
    if (t.id.includes('boss')) speed = 'atk';
    
    u.cast = SPECS.cast[speed]; 

    // â–¼â–¼â–¼ Pizza time: å…¨ã¦äºˆå‚™å‹•ä½œ 1.0ç§’ ã«å›ºå®š â–¼â–¼â–¼
    if (u.charId === 'pizza') {
        u.cast = 1.0;
    }
    // â–²â–²â–²

    u.maxCast = u.cast || 1; 
  },

  setCardAction: (c, tid) => {
    // â˜…ä¿®æ­£1: 'c.reservedTarget' ã‚’å‰Šé™¤ã—ã¦ã€äºˆç´„ä¸­ã§ã‚‚é€šã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹
    if (!c || c.cast > 0 || c.reload > 0) return;

    // â˜…ä¿®æ­£2: ã‚‚ã—æ—¢ã«èª°ã‹ã‚’äºˆç´„ã—ã¦ã„ã‚‹çŠ¶æ…‹ã§ã€æ–°ã—ã„æ“ä½œãŒæ¥ãŸã‚‰â€¦
    if (c.reservedTarget) {
        // åŒã˜ç›¸æ‰‹ã«ã‚‚ã†ä¸€åº¦ãƒ‰ãƒ©ãƒƒã‚°ã—ãŸå ´åˆã¯ä½•ã‚‚ã—ãªã„
        if (c.reservedTarget === tid) return;

        // é•ã†ç›¸æ‰‹ãªã‚‰ã€å¤ã„ç›¸æ‰‹ã®äºˆç´„ãƒ•ãƒ©ã‚°ã‚’æ¶ˆå»ã—ã¦ã‚ã’ã‚‹
        const oldTarget = BATTLE_STATE.units[c.reservedTarget];
        if (oldTarget && oldTarget.reservedCardIdx === c.idx) {
            oldTarget.reservedCardIdx = null;
        }
        c.reservedTarget = null;
        // ã“ã‚Œã§ãƒ•ãƒªãƒ¼ã®çŠ¶æ…‹ã«ãªã‚‹ã®ã§ã€ä¸‹ã®å‡¦ç†ã§æ–°ã—ã„ç›¸æ‰‹ã«é©ç”¨ã•ã‚Œã¾ã™
    }

    const t = BATTLE_STATE.units[tid]; if (!t) return;
    
    // QUICKã®äºˆç´„å‡¦ç† (ã“ã“ã¯ãã®ã¾ã¾)
    if (c.id === 'quick' && t.cast > 0) { t.reservedCardIdx = c.idx; c.reservedTarget = t.id; return; }


    // â–¼â–¼â–¼ æ¡ä»¶åˆ†å²ã‚’è©³ç´°åŒ– â–¼â–¼â–¼
    
    // 1. å‘³æ–¹å°‚ç”¨ (BUFF / HEAL)
    if (['heal','shld','quick','grow','rage','juice'].includes(c.id)) {
        if (t.team !== 'p') return; 
    }

    // 2. LIL STUN (å¦¨å®³)
    if (c.id === 'lstun') {
        // ãƒ¢ãƒ–ã€ã¾ãŸã¯ IDã«'boss'ãŒå«ã¾ã‚Œã‚‹å ´åˆ(ã‚³ã‚¢) ã¯ç¦æ­¢
        if (t.team === 'mob' || t.id.includes('boss')) return; 
    }

    // 3. BOM (å…¨ä½“æ”»æ’ƒ)
    if (c.id === 'bom') {
        // ã‚³ã‚¢ã¸ã®ç©ºæ‰“ã¡ã¯ç¦æ­¢ï¼ˆé–“é•ã£ã¦ã‚³ã‚¢ã®ä¸Šã«è½ã¨ã•ãªã„ã‚ˆã†ã«ï¼‰
        if (t.id.includes('boss')) return;
    }

    // 4. FEED (ãƒ¢ãƒ–å°‚ç”¨)
    if (c.id === 'feed') {
        if (t.team !== 'mob') return; 
    }
    
    // â–²â–²â–² ã“ã“ã¾ã§ â–²â–²â–²

    if (c.id === 'quick' && t.cast > 0) return; 
    c.act = { tid: tid }; c.cast = SPECS.cast[c.speed]; c.maxCast = c.cast || 1; 
  },

  commit: (u) => {
    const t = BATTLE_STATE.units[u.act.tid];
    u.act = null;

    // ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãŒæ­»ã‚“ã§ãŸã‚‰ãƒŸã‚¹
    if (!t || t.dead) { 
        u.cd = SPECS.cd.miss; u.maxCd = u.cd; 
        BATTLE_DRAW.pop(u.id, "ERR: MISS", "gray"); 
        return; 
    }

    // å…±é€šã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
    BATTLE_DRAW.flashUnit(u.id); 
    if (u.id !== 'however') BATTLE_DRAW.flash(u.id, t.id, u.team); 
    SOUND.play('shoot');

    // -----------------------------------------
    // â–  å‘³æ–¹ã¸ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ (TANKã®ã‚¢ãƒ“ãƒªãƒ†ã‚£)
    // -----------------------------------------
    if (u.team === t.team) {
        let isSupportAction = false; // ã‚µãƒãƒ¼ãƒˆè¡Œå‹•ã‚’è¡Œã£ãŸã‹ã©ã†ã‹ã®ãƒ•ãƒ©ã‚°

        if (u.charId === 'golden') {
            // Golden: ã‚¬ãƒ¼ãƒ‰
            BATTLE.applyShield(t, 3); 
            BATTLE_DRAW.pop(t.id, "[ GUARD ]", "#0ff");
            SOUND.play('shield');
            isSupportAction = true;
        } 
        else if (u.charId === 'oldtown') {
            // Old town road: å›å¾©
            const healVal = 100 * u.lv;
            BATTLE.heal(t, healVal); 
            BATTLE_DRAW.flash(u.id, t.id, '#0f0');

            isSupportAction = true;
        } 
        else if (u.charId === 'wata') {
            // WATA: çµŒé¨“å€¤
            const xpVal = 15 + (u.lv - 1) * 5;
            BATTLE.addXp(t, xpVal); 
            BATTLE_DRAW.pop(t.id, `â–² TEACH +${xpVal}`, "gold");
            isSupportAction = true;
        }
        
        // â˜…ã“ã“ãŒå¤‰æ›´ç‚¹â˜…
        // ã‚µãƒãƒ¼ãƒˆè¡Œå‹•ã‚’è¡Œã£ãŸå ´åˆã®ã¿ã€ã“ã“ã§å‡¦ç†ã‚’çµ‚äº†ã™ã‚‹ã€‚
        // PoPã‚„Cheerãªã©ã€ã‚µãƒãƒ¼ãƒˆèƒ½åŠ›ãŒãªã„ã‚­ãƒ£ãƒ©ãŒå‘³æ–¹ã‚’æ®´ã£ãŸå ´åˆã¯ã€
        // ã“ã®ifæ–‡ã‚’æŠœã‘ã¦ã€Œä¸‹ã®æ•µåˆ¤å®šï¼ˆãƒ€ãƒ¡ãƒ¼ã‚¸ï¼†ãƒ‡ãƒãƒ•å‡¦ç†ï¼‰ã€ã«é€²ã‚€ã€‚
        if (isSupportAction) {
            u.cd = SPECS.cd.guard; 
            u.maxCd = u.cd;
            return; 
        }
    }

    // -----------------------------------------
    // â–  æ”»æ’ƒã‚¢ã‚¯ã‚·ãƒ§ãƒ³ (æ•µã€ã¾ãŸã¯å‘³æ–¹ã¸ã®èª¤å°„)
    // -----------------------------------------

    
    let val = u.atk;
    if (u.charId === 'taki' && t.team === 'mob') { val *= 2.0; }

    // ç‰¹æ®ŠåŠ¹æœ (This love, Cheerleeder, PoP, However...)
    // This love ã¯å…ƒã€… !t.hasShield ãŒå…¥ã£ã¦ã„ã‚‹ã®ã§OK
    if (u.charId === 'thislove' && t.cast > 0 && !t.hasShield) {
        t.cast = 0; t.cd = 5.0; 
        BATTLE_DRAW.fxStun(t.id); SOUND.play('stun');
        BATTLE_DRAW.pop(t.id, "<< STUN >>", "yellow", true);
    }

    // â–¼â–¼â–¼ ä¿®æ­£ï¼šCheerleaderã¨PoPã®åŠ¹æœã‚‚ã‚·ãƒ¼ãƒ«ãƒ‰ã§é˜²ã’ã‚‹ã‚ˆã†ã«æ¡ä»¶è¿½åŠ  â–¼â–¼â–¼
    
    // ã‚·ãƒ¼ãƒ«ãƒ‰ãŒãªã„å ´åˆã®ã¿é…å»¶ã•ã›ã‚‹ (!t.hasShield ã‚’è¿½åŠ )
    if (u.charId === 'cheer' && t.cd > 0 && !t.hasShield) {
        t.cd += 3.0; t.maxCd += 3.0; 
        BATTLE_DRAW.pop(t.id, "+3s DELAY", "violet", false, -30);
    }

// ä¿®æ­£å‰
// if (u.charId === 'pop' && !t.hasShield) {
//     t.vuln = true; t.vulnTime = 5.0; 
//     BATTLE_DRAW.pop(t.id, "â–¼ WEAK", "magenta", false, -30);
// }

// â–¼â–¼â–¼ ä¿®æ­£å¾Œï¼šPoPã®å‡¦ç† (ã‚¹ã‚¿ãƒƒã‚¯ç®¡ç†) â–¼â–¼â–¼
if (u.charId === 'pop' && !t.hasShield) {
    t.vuln = true; // AIåˆ¤å®šç”¨ã«ãƒ•ãƒ©ã‚°ã¯æ®‹ã™
    
    // ã¾ã ã‚¹ã‚¿ãƒƒã‚¯å¤‰æ•°ãŒãªã‘ã‚Œã°0ã«ã™ã‚‹ï¼ˆå¿µã®ãŸã‚ï¼‰
    if (typeof t.vulnStacks === 'undefined') t.vulnStacks = 0;

    // ã‚¹ã‚¿ãƒƒã‚¯åŠ ç®—ï¼ˆæœ€å¤§2ï¼‰
    if (t.vulnStacks < 2) {
        t.vulnStacks++;
    }
    
    // æ™‚é–“ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆé‡ã­ãŒã‘ã§æ™‚é–“ã¯å»¶é•·ã•ã‚Œã‚‹ï¼‰
    t.vulnTime = 5.0; 
    
    // è¡¨ç¤ºãƒ†ã‚­ã‚¹ãƒˆ (2ã‚¹ã‚¿ãƒƒã‚¯ç›®ã¯ x2 ã¨è¡¨ç¤º)
    const txt = t.vulnStacks === 2 ? "â–¼ WEAK x2" : "â–¼ WEAK";
    BATTLE_DRAW.pop(t.id, txt, "magenta", false, -30);
}
// â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–²

    // (å‰ç•¥... This love, Cheer, PoP ã®å‡¦ç†ã®å¾Œ)

    // â–¼â–¼â–¼ ä¿®æ­£ï¼šHoweverã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆåˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ â–¼â–¼â–¼
    if (u.charId === 'however') {
        
        // ãƒ‘ã‚¿ãƒ¼ãƒ³A: ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãŒã€Œãƒœã‚¹ã€ã®å ´åˆ â†’ ãƒœã‚¹å˜ä½“ã®ã¿æ”»æ’ƒ
        if (t.id.includes('boss')) {
            BATTLE.damage(t, val, u);
        }
        // ãƒ‘ã‚¿ãƒ¼ãƒ³B: ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãŒã€Œãƒœã‚¹ä»¥å¤–ã€ã®å ´åˆ â†’ ãƒœã‚¹ä»¥å¤–ã®ãƒãƒ¼ãƒ å…¨å“¡ã‚’æ”»æ’ƒ
        else {
            const targets = Object.values(BATTLE_STATE.units).filter(unit => 
                unit.team === t.team && 
                !unit.dead && 
                !unit.id.includes('boss') // ã“ã“ã§ãƒœã‚¹ã‚’å·»ãæ·»ãˆã‹ã‚‰é™¤å¤–
            );
            
            targets.forEach(subT => {
                BATTLE_DRAW.flash(u.id, subT.id, u.team); 
                BATTLE.damage(subT, val, u);
            });
        }
    } 
    else {
        // ãã®ä»–ã®ã‚­ãƒ£ãƒ©ã¯é€šå¸¸é€šã‚Šã‚¿ãƒ¼ã‚²ãƒƒãƒˆ1ä½“ã‚’æ”»æ’ƒ
        BATTLE.damage(t, val, u);
    }
    
    // (å¾Œç•¥... ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³è¨­å®šãªã©)

    // ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³è¨­å®š
    if (t.team === 'mob') u.cd = SPECS.cd.mob_kill; 
    else u.cd = t.id.includes('boss') ? SPECS.cd.boss : SPECS.cd.atk; 

    // â–¼â–¼â–¼ Pizza time: ãƒœã‚¹æ”»æ’ƒæ™‚ã ã‘CDã‚’æ¸›ã‚‰ã™ â–¼â–¼â–¼
    if (u.charId === 'pizza') {
        if (t.id.includes('boss')) {
            u.cd = 1.0; // â˜…ãƒœã‚¹ã‚’æ®´ã£ãŸæ™‚ã¯ã€Œ1ç§’ã€ã«ã™ã‚‹ï¼ˆã“ã“ã‚’å¥½ããªç§’æ•°ã«å¤‰ãˆã¦OKï¼‰
        } else {
            u.cd = 3.0; // ãã‚Œä»¥å¤–ã®æ™‚ã¯ã€Œ3ç§’ã€
        }
    }
    
    u.maxCd = u.cd;
    
    // Quickäºˆç´„å‡¦ç†
    if (typeof u.reservedCardIdx === 'number') {
      const c = BATTLE_STATE.hand[u.reservedCardIdx];
      if (c && c.id === 'quick' && c.reservedTarget === u.id) { 
          u.reservedCardIdx = null; c.reservedTarget = null; 
          c.act = { tid: u.id }; c.cast = SPECS.cast[c.speed]; c.maxCast = c.cast || 1; 
      }
    }
  },

  commitCard: (c) => {
    const t = BATTLE_STATE.units[c.act.tid];
    c.act = null; 
    c.reload = SPECS.cd.card_reload;
    const slot = document.getElementById(`slot-${c.idx}`); const cardEl = slot.querySelector('.card'); if (cardEl) cardEl.remove();

    if (!t && c.id !== 'bom') return; 

    if (c.id !== 'bom' && t) BATTLE_DRAW.flash(`slot-${c.idx}`, t.id, 'p');

    // â–¼â–¼â–¼ ã‚«ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ï¼ˆç¾åœ¨ã®ãƒ¬ãƒ™ãƒ«å€¤ã‚’ä½¿ã†ãŸã‚ï¼‰ â–¼â–¼â–¼
    const dbCard = DB.cards.find(x => x.id === c.id);
    const lvIdx = (dbCard && dbCard.level) ? dbCard.level - 1 : 0;
    const vals = dbCard ? dbCard.vals : [];
    // â–²â–²â–²

    if (c.id === 'heal') { 
        BATTLE.heal(t, SPECS.val.heal); 
    }
    else if (c.id === 'shld') { 
        BATTLE.applyShield(t, 5); BATTLE.heal(t, 100); 
    }
    else if (c.id === 'quick') { 
        t.cd = 0; BATTLE_DRAW.pop(t.id, ">> READY <<", "#0ff"); 
        if (t.reserve) { BATTLE.setAction(t, t.reserve.tid); t.reserve = null; }
    }
    else if (c.id === 'grow') { 
        // vals: [15, 25, 40]
        const val = vals[lvIdx] || 15;
        BATTLE.addXp(t, val); BATTLE_DRAW.pop(t.id, `â–² GROW +${val}`, "gold"); 
    }
    else if (c.id === 'rage') {
        // vals: [1.3, 1.5, 1.7]
        const val = vals[lvIdx] || 1.3;
        t.buffs.push({ type: 'rage', val: val, time: 10.0 });
        BATTLE_DRAW.pop(t.id, "â–² RAGE", "red");
        BATTLE_DRAW.particles(t.id, "#f05");
    }
    else if (c.id === 'juice') {
        // vals: [1.3, 1.5, 1.7]
        const val = vals[lvIdx] || 1.3;
        t.buffs.push({ type: 'juice', val: val, time: 10.0 });
        BATTLE_DRAW.pop(t.id, "â–² JUICE", "orange");
    }
    else if (c.id === 'lstun') {
        // â–¼â–¼â–¼ ä¿®æ­£ï¼šäºˆå‚™å‹•ä½œ(cast > 0)ä»¥å¤–ã¯MISSã«ã™ã‚‹ â–¼â–¼â–¼
        
        // ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãŒç”Ÿãã¦ã„ã¦ã€ã‹ã¤è© å”±ä¸­(cast > 0)ã®ã¿æˆåŠŸ
        if (!t.dead && t.cast > 0) {
             // vals: [2.0, 3.0, 4.0]
             const duration = vals[lvIdx] || 2.0;
             
             // è© å”±ã‚’ä¸­æ–­ã•ã›ã€CDã‚’ä»˜ä¸ã—ã¦å›ºã‚ã‚‹
             t.cast = 0; 
             t.cd = duration; 
             
             BATTLE_DRAW.fxStun(t.id); SOUND.play('stun');
             BATTLE_DRAW.pop(t.id, `<< STUN ${duration}s >>`, "yellow");
        } else {
             // è© å”±ã—ã¦ã„ãªã„ï¼ˆæ£’ç«‹ã¡ã€CDä¸­ã€æ”»æ’ƒå¾Œã€æ­»äº¡ãªã©ï¼‰å ´åˆã¯ãƒŸã‚¹
             BATTLE_DRAW.pop(t.id, "MISS", "gray");
             SOUND.play('cancel');
        }
        // â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–²
    }
    else if (c.id === 'feed') {
        if (t.dead) {
            BATTLE_DRAW.pop(t.id, "MISS", "gray");
            SOUND.play('cancel');
        } else {
            BATTLE.heal(t, 500);
            // (å‰å›ã®ã”è¦æœ›ã«ã‚ˆã‚Šå‰Šé™¤æ¸ˆã¿) BATTLE_DRAW.pop(t.id, "â™¥ FEED", "pink");
        }
    }
    else if (c.id === 'bom') {
        // vals: [30, 60, 90]
        const dmg = vals[lvIdx] || 30;
        Object.values(BATTLE_STATE.units).forEach(u => {
            if (!u.dead && !u.id.includes('boss')) {
                BATTLE.damage(u, dmg, null);
                // (å‰å›ã®ã”è¦æœ›ã«ã‚ˆã‚Šå‰Šé™¤æ¸ˆã¿) BATTLE_DRAW.pop(u.id, "BOM!", "white");
            }
        });
        BATTLE_DRAW.screenShake(); SOUND.play('heavy_explode');
    }
  },

  damage: (t, val, src) => {
    if (t.dead) return;
    
    // â–¼ RAGEãƒãƒ•ã®è¨ˆç®—
    if (src && src.buffs) {
        const rage = src.buffs.find(b => b.type === 'rage');
        if (rage) val = Math.floor(val * rage.val);
    }

// ä¿®æ­£å‰
// if (t.vuln) { val = Math.floor(val * 1.2); }

// â–¼â–¼â–¼ ä¿®æ­£å¾Œï¼š1.5å€ã®ç´¯ç©è¨ˆç®— â–¼â–¼â–¼
if (t.vulnStacks > 0) {
    // 1ã‚¹ã‚¿ãƒƒã‚¯: 1.5å€
    // 2ã‚¹ã‚¿ãƒƒã‚¯: 1.5 * 1.5 = 2.25å€
    const multiplier = Math.pow(1.5, t.vulnStacks);
    val = Math.floor(val * multiplier);
}
// â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–²

    if (t.id.includes('boss')) { val = Math.floor(val * 0.85); }
    
    if (t.hasShield) { t.hasShield = false; t.shieldTime = 0; BATTLE_DRAW.fxParry(t.id); SOUND.play('parry'); BATTLE_DRAW.pop(t.id, "/// PARRY ///", "#0ff", true); return; }
    
    BATTLE_DRAW.shake(t.id); SOUND.play('hit'); BATTLE_DRAW.pop(t.id, val, "#ff3355", false); 
    t.hp -= val;
    
    if (t.hp <= 0) {
      t.hp = 0; t.dead = true; t.act = null; t.cast = 0; t.reserve = null; t.buffs = [];
      BATTLE_DRAW.particles(t.id, (t.team==='p'?'#0ff':(t.team==='e'?'#f05':'#0f0'))); 
      if (t.team === 'mob') { SOUND.play('explode'); } else { SOUND.play('heavy_explode'); BATTLE_DRAW.screenShake(); BATTLE_DRAW.glitch(); }
      if (t.id.includes('boss')) { BATTLE.showResult(t.team === 'e' ? 'win' : 'lose'); return; }
      t.rt = SPECS.respawn[t.role] || SPECS.respawn.mob;
      
      if (t.team === 'mob' || t.team === 'e' || t.team === 'p') {
        const xp = t.xp || 30;
        if (src && src.id === 'p_boss') { 
            const share = Math.floor(xp / 3); 
            ['p_atk','p_tank','p_supp'].forEach(id => BATTLE.addXp(BATTLE_STATE.units[id], share)); 
        }
// ä¿®æ­£å‰
else if (src && src.team === 'p') { 
    BATTLE.addXp(src, xp); 
    // â–¼ è¿½åŠ : CLOUD_SYNC (ãƒˆãƒ‰ãƒ¡ä»¥å¤–ã®å‘³æ–¹ã«ã‚‚XPãŒå…¥ã‚‹)
    if (STATE.inventory.upgrades.includes('u_share_xp')) {
        const shareVal = Math.floor(xp * 0.3); 
        ['p_atk','p_tank','p_supp'].forEach(id => {
            if (id !== src.id) BATTLE.addXp(BATTLE_STATE.units[id], shareVal);
        });
    }
} 

// â–¼â–¼â–¼ è¿½åŠ ï¼šæ•µãƒãƒ¼ãƒ ('e')ã‚‚çµŒé¨“å€¤ã‚’ç²å¾—ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ â–¼â–¼â–¼
else if (src && src.team === 'e') {
    BATTLE.addXp(src, xp);
}
// â–²â–²â–² è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–²

      }
      if (t.team === 'mob') { t.nextType = Math.random() < 0.1 ? 'elite' : (Math.random() < 0.4 ? 'buff' : 'norm'); }
    }
  },


  heal: (t, val) => { t.hp = Math.min(t.max, t.hp + val); BATTLE_DRAW.pop(t.id, `+${val}`, "#0f0"); SOUND.play('heal'); },
  applyShield: (t, dur) => { t.hasShield = true; t.shieldTime = dur; }, 

  addXp: (u, val) => {
    if (!u || u.dead || u.lv >= 10) return;

    // â–¼ è¿½åŠ : DATA_HARVEST (XPç²å¾—é‡ +20%)
    if (u.team === 'p' && STATE.inventory.upgrades.includes('u_xp')) {
        val = Math.floor(val * 1.2);
    }

    u.xp += val;
    if (u.xp >= u.nxt) {
      u.xp -= u.nxt; 
      u.lv++; 
      
      // â–¼â–¼â–¼ ä¿®æ­£ï¼šATKã ã‘æˆé•·æ›²ç·šã‚’å³ã—ãã™ã‚‹ â–¼â–¼â–¼
      let growthRate = 1.5; // åŸºæœ¬ã¯1.5å€
      
      if (u.role === 'atk') {
          growthRate = 2.0; // ATKã¯2.0å€ï¼ˆã“ã“ã‚’å¢—ã‚„ã™ã¨ã‚‚ã£ã¨å³ã—ããªã‚Šã¾ã™ï¼‰
      }
      
      u.nxt = Math.floor(u.nxt * growthRate);
      // â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–²

      u.max = Math.floor(u.max * 1.3); u.atk = Math.floor(u.atk * 1.3); u.hp = u.max;
      BATTLE_DRAW.pop(u.id, "â–² LEVEL UP", "#ffd700", true); SOUND.play('levelup'); BATTLE_DRAW.levelUpFx(u.id);
    }
  },

  revive: (u) => {
    u.dead = false; u.hp = u.max; u.rt = 0; u.act = null; u.cast = 0; u.cd = 0; u.reserve = null;
    if (u.team === 'mob' && u.nextType) {
      u.type = u.nextType; u.max = u.type==='elite' ? 500 : (u.type==='buff' ? 300 : 200); u.xp = u.type==='elite' ? 100 : (u.type==='buff' ? 60 : 30); u.hp = u.max;
      const el = document.getElementById(u.id); el.className = `mob ${u.type}`;
    }
    BATTLE_DRAW.pop(u.id, "REVIVE", "white");
  },
  // ã€æ–°è¦è¿½åŠ ã€‘ãƒãƒˆãƒ«ã‚’å¼·åˆ¶åœæ­¢ã™ã‚‹
  stop: () => {
    BATTLE_STATE.running = false;
    // ãƒ«ãƒ¼ãƒ—å‡¦ç†ã‚’ç¢ºå®Ÿã«æ­¢ã‚ã‚‹
    if (BATTLE_STATE.loopId) clearInterval(BATTLE_STATE.loopId);
    if (BATTLE_STATE.drawId) clearInterval(BATTLE_STATE.drawId);
    if (BATTLE_STATE.tickId) clearInterval(BATTLE_STATE.tickId);

    // â–¼â–¼â–¼ è¿½åŠ ï¼šç”»é¢ã«æ®‹ã£ãŸæ ã‚„ã‚´ãƒ¼ã‚¹ãƒˆã‚’å¼·åˆ¶å‰Šé™¤ â–¼â–¼â–¼
    document.querySelectorAll('.target-frame').forEach(el => el.remove());
    document.querySelectorAll('.ghost').forEach(el => el.remove());
    document.getElementById('drag-line').style.display = 'none';
  },
};

const INPUT = {
  handle: (e, type) => { if(type === 'start') INPUT.start(e); if(type === 'move') INPUT.move(e); if(type === 'end') INPUT.end(e); },
  start: (e) => {
    if (!BATTLE_STATE.running) return;
    if (BATTLE_STATE.drag) {
        if(BATTLE_STATE.drag.ghost) BATTLE_STATE.drag.ghost.remove();
        document.getElementById('drag-line').style.display='none';
        BATTLE_STATE.drag = null;
    }
    const t = e.changedTouches ? e.changedTouches[0] : e;
    const target = document.elementFromPoint(t.clientX, t.clientY);
    if (!target) return;
    const box = target.closest('.box, .mob, .core, .slot');

    let payload = null, srcEl = null;
    if (!box) return;
    if (box.classList.contains('box') && box.id.startsWith('p_')) { payload = { type: 'unit', id: box.id }; srcEl = box; } 
    else if (box.classList.contains('slot') && !box.classList.contains('enemy')) {
        const idx = parseInt(box.id.split('-')[1]); const card = BATTLE_STATE.hand[idx];
        if (card && card.reload <= 0) { payload = { type: 'card', idx: idx }; srcEl = box.querySelector('.card') || box; }
    }
    if (!payload || !srcEl) return;
    if (payload.type === 'unit') { const u = BATTLE_STATE.units[payload.id]; if(u.dead || u.cast > 0) return; }
    e.preventDefault();
    const rect = srcEl.getBoundingClientRect();
    const ghost = srcEl.cloneNode(true); ghost.className = "ghost"; ghost.style.width = rect.width + 'px'; ghost.style.height = rect.height + 'px';
    document.getElementById('layer-drag').appendChild(ghost);
    BATTLE_STATE.drag = { payload, ghost, w: rect.width, h: rect.height };
    INPUT.move(e);
    const line = document.getElementById('drag-line'); line.setAttribute('x1', rect.left + rect.width/2); line.setAttribute('y1', rect.top + rect.height/2);
  },
  move: (e) => {
    if (!BATTLE_STATE.drag) return;
    e.preventDefault();
    const t = e.touches ? e.touches[0] : (e.changedTouches ? e.changedTouches[0] : e);
    const x = t.clientX; const y = t.clientY;
    const g = BATTLE_STATE.drag.ghost;
    g.style.left = (x - BATTLE_STATE.drag.w/2) + 'px'; g.style.top = (y - BATTLE_STATE.drag.h/2) + 'px';
    const line = document.getElementById('drag-line'); 
    line.style.display = 'block';
    line.setAttribute('x2', x); line.setAttribute('y2', y);
    document.querySelectorAll('.highlight').forEach(el=>el.classList.remove('highlight'));
    const tid = INPUT.getHit(x, y);
    if (tid) { const el = document.getElementById(tid); if (el) el.classList.add('highlight'); }
  },
  end: (e) => {
    if (!BATTLE_STATE.drag) return;
    const t = e.changedTouches ? e.changedTouches[0] : e;
    if(BATTLE_STATE.drag.ghost) BATTLE_STATE.drag.ghost.remove(); 
    document.getElementById('drag-line').style.display='none'; document.querySelectorAll('.highlight').forEach(el=>el.classList.remove('highlight'));
    const tid = INPUT.getHit(t.clientX, t.clientY);
    
    if (tid) {
      // ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã®ä¸Šã§é›¢ã—ãŸå ´åˆï¼ˆå®Ÿè¡Œãƒ»äºˆç´„ï¼‰
      if (BATTLE_STATE.drag.payload.type === 'unit') BATTLE.setAction(BATTLE_STATE.units[BATTLE_STATE.drag.payload.id], tid);
      else BATTLE.setCardAction(BATTLE_STATE.hand[BATTLE_STATE.drag.payload.idx], tid);
    } else {
      // ä½•ã‚‚ãªã„å ´æ‰€ã§é›¢ã—ãŸå ´åˆï¼ˆã‚­ãƒ£ãƒ³ã‚»ãƒ«å‡¦ç†ï¼‰
      
      // 1. ãƒ¦ãƒ‹ãƒƒãƒˆã®äºˆç´„ã‚­ãƒ£ãƒ³ã‚»ãƒ«
      if (BATTLE_STATE.drag.payload.type === 'unit') { 
          const u = BATTLE_STATE.units[BATTLE_STATE.drag.payload.id]; 
          if (u && u.reserve) { 
              u.reserve = null; 
              BATTLE_DRAW.pop(u.id, "CANCEL", "gray"); 
              SOUND.play('cancel'); 
          } 
      }
      
      // â–¼â–¼â–¼ è¿½åŠ : ã‚«ãƒ¼ãƒ‰(Quick)ã®äºˆç´„ã‚­ãƒ£ãƒ³ã‚»ãƒ« â–¼â–¼â–¼
      else if (BATTLE_STATE.drag.payload.type === 'card') {
          const c = BATTLE_STATE.hand[BATTLE_STATE.drag.payload.idx];
          // ã‚‚ã—ã‚«ãƒ¼ãƒ‰ãŒäºˆç´„ä¸­(reservedTargetã‚ã‚Š)ãªã‚‰è§£é™¤
          if (c && c.reservedTarget) {
              const tUnit = BATTLE_STATE.units[c.reservedTarget];
              
              // ãƒ¦ãƒ‹ãƒƒãƒˆå´ã®äºˆç´„ãƒ•ãƒ©ã‚°ã‚‚æ¶ˆã™
              if (tUnit && tUnit.reservedCardIdx === c.idx) {
                  tUnit.reservedCardIdx = null;
              }
              c.reservedTarget = null;
              
              BATTLE_DRAW.pop(`slot-${c.idx}`, "CANCEL", "gray");
              SOUND.play('cancel');
          }
      }
      // â–²â–²â–² è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–²
    }
    BATTLE_STATE.drag = null;
  },
  getHit: (x, y) => {
    const candidates = [...Object.keys(BATTLE_STATE.units)];
    for (let id of candidates) {
      if (id === 'p_boss') continue;
      const el = document.getElementById(id); if (!el) continue;
      const r = el.getBoundingClientRect();
      if (x >= r.left && x <= r.right && y >= r.top && y <= r.bottom) return id;
    }
    return null;
  }
};

const BATTLE_DRAW = {
  curvedLine: (fromId, toId, team, pct, isReserve = false) => {
    const f = document.getElementById(fromId); const t = document.getElementById(toId);
    if(!f || !t) return;
    const r1 = f.getBoundingClientRect(); const r2 = t.getBoundingClientRect();
    const x1 = r1.left + r1.width/2; const y1 = r1.top + r1.height/2;
    const x2 = r2.left + r2.width/2; const y2 = r2.top + r2.height/2;
    const midX = (x1 + x2) / 2; const midY = (y1 + y2) / 2;
    const dx = x2 - x1; const dy = y2 - y1;
    const offsetX = -dy * 0.2; const offsetY = dx * 0.2; 
    const cx = midX + offsetX; const cy = midY + offsetY;
    const pathData = `M ${x1} ${y1} Q ${cx} ${cy} ${x2} ${y2}`;
    const svg = document.getElementById('layer-lines');
    let isBoss = toId.includes('boss'); let typeClass = isBoss ? 'boss' : (toId.includes('mob') ? 'mob' : '');

    if (!isReserve) {
      const base = document.createElementNS('http://www.w3.org/2000/svg','path');
      base.setAttribute('d', pathData); base.setAttribute('class', `path-base ${team}`);
      svg.appendChild(base);
    }
    const gauge = document.createElementNS('http://www.w3.org/2000/svg','path');
    gauge.setAttribute('d', pathData);
    if (isReserve) { gauge.setAttribute('class', `path-reserve`); } 
    else {
      gauge.setAttribute('class', `path-gauge ${team} ${typeClass}`);
      const len = Math.hypot(dx, dy) * 1.2; 
      gauge.style.strokeDasharray = `${len * pct} ${len}`;
      if (pct < 1.0) gauge.style.strokeDasharray = `${len * pct} ${len + 300}`;
      if (isBoss) {
        const core = document.createElementNS('http://www.w3.org/2000/svg','path');
        core.setAttribute('d', pathData); core.setAttribute('class', 'path-boss-core');
        core.style.strokeDasharray = `${len * pct} ${len}`; svg.appendChild(core);
      }
    }
    svg.appendChild(gauge);
  },
  
  markTarget: (tid, team) => {
    const el = document.getElementById(tid); if (!el) return;
    const r = el.getBoundingClientRect();
    const frame = document.createElement('div');
    frame.className = 'target-frame'; frame.style.color = team === 'p' ? '#0ff' : '#f05';
    frame.style.left = (r.left + r.width/2 - 30) + 'px'; frame.style.top = (r.top + r.height/2 - 30) + 'px';
    const tl = document.createElement('div'); tl.className = 'tf-c tf-tl';
    const tr = document.createElement('div'); tr.className = 'tf-c tf-tr';
    const bl = document.createElement('div'); bl.className = 'tf-c tf-bl';
    const br = document.createElement('div'); br.className = 'tf-c tf-br';
    frame.appendChild(tl); frame.appendChild(tr); frame.appendChild(bl); frame.appendChild(br);
    document.body.appendChild(frame);
  },
  
  flash: (fromId, toId, team) => {
    const f = document.getElementById(fromId); const t = document.getElementById(toId); if(!f || !t) return;
    const r1 = f.getBoundingClientRect(); const r2 = t.getBoundingClientRect();
    const l = document.createElementNS('http://www.w3.org/2000/svg','line');
    l.setAttribute('x1', r1.left + r1.width/2); l.setAttribute('y1', r1.top + r1.height/2);
    l.setAttribute('x2', r2.left + r2.width/2); l.setAttribute('y2', r2.top + r2.height/2);
    l.setAttribute('class', `flash`); l.style.stroke = team === 'p' ? '#0ff' : '#f05';
    document.getElementById('layer-lines').appendChild(l); setTimeout(() => l.remove(), 500);
  },
  flashUnit: (id) => {
    const el = document.getElementById(id);
    if(el) { el.classList.add('active-flash'); setTimeout(()=>el.classList.remove('active-flash'), 100); }
  },
  beam: (fromId, toId) => { BATTLE_DRAW.flash(fromId, toId, 'e'); },
  
  pop: (id, txt, color, isCrit = false, yOffset = 0) => { // â˜…å¼•æ•° yOffset ã‚’è¿½åŠ 
    const el = document.getElementById(id); if(!el) return;
    const p = document.createElement('div');
    p.innerText = txt; p.className = isCrit ? 'pop crit' : 'pop'; p.style.color = color;
    const rx = (Math.random() - 0.5) * 60; p.style.setProperty('--rx', rx + 'px');
    const r = el.getBoundingClientRect(); 
    p.style.left = (r.left + r.width/2) + 'px'; 
    
    // â˜…ä¿®æ­£ï¼šyOffset ã‚’è¶³ã—ã¦ä½ç½®ã‚’èª¿æ•´å¯èƒ½ã«
    p.style.top = (r.top + yOffset) + 'px'; 
    
    document.body.appendChild(p); setTimeout(() => p.remove(), isCrit ? 1200 : 1000);
  },
  
  shake: (id) => { const el = document.getElementById(id); if(el) { el.classList.remove('shaking'); void el.offsetWidth; el.classList.add('shaking'); } },
  screenShake: () => { document.body.classList.remove('shake-screen'); void document.body.offsetWidth; document.body.classList.add('shake-screen'); },
  glitch: () => { document.body.classList.remove('glitch-active'); void document.body.offsetWidth; document.body.classList.add('glitch-active'); },

  levelUpFx: (id) => {
    const el = document.getElementById(id); if (!el) return;
    const r = el.getBoundingClientRect();
    const overlay = document.createElement('div'); overlay.className = 'fx-lvup-overlay'; el.appendChild(overlay); setTimeout(() => overlay.remove(), 300);
    const ring = document.createElement('div'); ring.className = 'fx-lvup-ring'; el.appendChild(ring); setTimeout(() => ring.remove(), 600);
    for(let i=0; i<15; i++) {
      const p = document.createElement('div'); p.className = 'particle'; p.style.backgroundColor = '#ffd700'; 
      p.style.left = (r.left + r.width/2) + 'px'; p.style.top = (r.top + r.height/2) + 'px';
      const angle = Math.random() * Math.PI * 2; const dist = 30 + Math.random() * 40;
      p.style.setProperty('--tx', Math.cos(angle) * dist + 'px'); p.style.setProperty('--ty', (Math.sin(angle) * dist - 50) + 'px');
      document.body.appendChild(p); setTimeout(()=>p.remove(), 800);
    }
  },

  particles: (id, color) => {
    const el = document.getElementById(id); if (!el) return;
    const r = el.getBoundingClientRect(); const cx = r.left + r.width/2; const cy = r.top + r.height/2;
    for(let i=0; i<8; i++) {
      const p = document.createElement('div'); p.className = 'particle'; p.style.backgroundColor = color;
      p.style.left = cx + 'px'; p.style.top = cy + 'px';
      const angle = Math.random() * Math.PI * 2; const dist = 50 + Math.random() * 50;
      p.style.setProperty('--tx', Math.cos(angle) * dist + 'px'); p.style.setProperty('--ty', Math.sin(angle) * dist + 'px');
      document.body.appendChild(p); setTimeout(()=>p.remove(), 600);
    }
  },

  fireBit: (fromId, toId, color, onHit) => {
    const f = document.getElementById(fromId); const t = document.getElementById(toId); if(!f || !t) return;
    const r1 = f.getBoundingClientRect(); const r2 = t.getBoundingClientRect();
    const bit = document.createElement('div'); bit.className = 'bit';
    bit.style.left = (r1.left + r1.width/2 - 4) + 'px'; bit.style.top = (r1.top + r1.height/2 - 4) + 'px'; bit.style.color = color;
    document.body.appendChild(bit);
    requestAnimationFrame(() => { bit.style.transform = `translate(${r2.left - r1.left}px, ${r2.top - r1.top}px)`; });
    setTimeout(() => { bit.remove(); if(onHit) onHit(); }, 1200); 
  },

  fxParry: (id) => {
    const el = document.getElementById(id); if (!el) return;
    const cross = document.createElement('div'); cross.className = 'fx-cross'; el.appendChild(cross); setTimeout(() => cross.remove(), 200);
    const overlay = document.createElement('div'); overlay.className = 'fx-white-overlay'; el.appendChild(overlay); setTimeout(() => overlay.remove(), 150);
  },

  fxStun: (id) => {
    const el = document.getElementById(id); if (!el) return;
    el.classList.add('fx-glitch-target'); setTimeout(() => el.classList.remove('fx-glitch-target'), 600);
    const thunder = document.createElement('div'); thunder.className = 'fx-thunder'; el.appendChild(thunder); setTimeout(() => thunder.remove(), 300);
    for(let i=0; i<3; i++) {
      const s = document.createElement('div'); s.className = 'fx-spark'; s.style.setProperty('--r', (Math.random()*360)+'deg');
      el.appendChild(s); setTimeout(() => s.remove(), 350);
    }
  },

  // BATTLE_DRAW ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå†…ã«è¿½åŠ ã—ã¦ãã ã•ã„

  victoryConfetti: () => {
    // ç”»é¢ä¸­å¤®ã‹ã‚‰å¤§é‡ã®ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ã‚’çˆ†ç™ºã•ã›ã‚‹
    const cx = window.innerWidth / 2;
    const cy = window.innerHeight / 2;
    const colors = ['#0ff', '#f05', '#ffd700', '#fff']; // ãƒã‚ªãƒ³ã‚«ãƒ©ãƒ¼ + é‡‘

    for (let i = 0; i < 60; i++) {
        const p = document.createElement('div');
        p.className = 'particle';
        // è‰²ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«
        p.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        // å¤§ãã•ã‚‚ãƒ©ãƒ³ãƒ€ãƒ ã«
        const size = 4 + Math.random() * 8;
        p.style.width = size + 'px'; p.style.height = size + 'px';
        
        p.style.left = cx + 'px'; p.style.top = cy + 'px';
        
        // é£›ã³æ•£ã‚‹è§’åº¦ã¨è·é›¢
        const angle = Math.random() * Math.PI * 2;
        const dist = 100 + Math.random() * 400; // ã‹ãªã‚Šåºƒç¯„å›²ã«
        const tx = Math.cos(angle) * dist;
        const ty = Math.sin(angle) * dist;

        // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³æ™‚é–“ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«ã—ã¦è‡ªç„¶ã«
        const dur = 0.8 + Math.random() * 0.8;
        p.style.transition = `transform ${dur}s cubic-bezier(0.25, 1, 0.5, 1), opacity ${dur}s ease-in`;
        
        document.body.appendChild(p);
        
        // å°‘ã—é…ã‚‰ã›ã¦ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹ï¼ˆDOMè¿½åŠ ç›´å¾Œã ã¨å‹•ã‹ãªã„ã“ã¨ãŒã‚ã‚‹ãŸã‚ï¼‰
        requestAnimationFrame(() => {
            p.style.transform = `translate(${tx}px, ${ty}px) scale(0)`;
            p.style.opacity = 0;
        });

        setTimeout(() => p.remove(), dur * 1000);
    }
  },
  
  draw: () => {
    try {
      document.getElementById('ui-timer').innerText = BATTLE_STATE.time;
      const pHP = BATTLE_STATE.units.p_boss.hp, eHP = BATTLE_STATE.units.e_boss.hp;
      if(document.getElementById('e_boss').childNodes[0]) document.getElementById('e_boss').childNodes[0].nodeValue = Math.floor(eHP/3500*100)+'%';
      if(document.getElementById('p_boss').childNodes[0]) document.getElementById('p_boss').childNodes[0].nodeValue = Math.floor(pHP/3500*100)+'%';

      const svg = document.getElementById('layer-lines');
      while(svg.lastChild && svg.lastChild.id !== 'drag-line') { svg.removeChild(svg.lastChild); }
      
      document.querySelectorAll('.target-frame').forEach(e => e.remove());
      document.querySelectorAll('.indicators').forEach(el => el.innerHTML = '');

      const pendingActions = {}; 
      const registerAction = (tid, team, time, role) => {
          if (!pendingActions[tid]) pendingActions[tid] = [];
          pendingActions[tid].push({ team, time, role });
      };

      // (å‰ç•¥) BATTLE_DRAW.draw ã®ä¸­...

      Object.values(BATTLE_STATE.units).forEach(u => {
        const el = document.getElementById(u.id); if (!el) return;
        
        // ... (æ—¢å­˜ã®dead, casting, hasShield ãªã©ã®ã‚¯ãƒ©ã‚¹å‡¦ç†) ...
        if (u.dead) el.classList.add('dead'); else el.classList.remove('dead');
        if (u.cast > 0) el.classList.add('casting'); else el.classList.remove('casting');
        if (u.hasShield) el.style.border = "3px solid white"; else { if (!el.classList.contains('mob')) el.style.border = ""; }

        // ... (æ—¢å­˜ã®ãƒãƒ¼æ›´æ–°å‡¦ç†) ...
        const hpBar = el.querySelector('.fill.hp'); if (hpBar) hpBar.style.width = (u.hp / u.max * 100) + '%';
        const badge = el.querySelector('.badge'); if (badge) badge.innerText = `Lv.${u.lv}`;
        const xpBar = el.querySelector('.fill.xp'); if (xpBar) xpBar.style.width = (u.xp / u.nxt * 100) + '%';


        // â–¼â–¼â–¼ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºã®è¿½åŠ  (ã“ã“ã‹ã‚‰) â–¼â–¼â–¼
        // 1. ã‚³ãƒ³ãƒ†ãƒŠã®å–å¾—ã¾ãŸã¯ä½œæˆ
        let stGrid = el.querySelector('.status-grid');
        if (!stGrid) {
            stGrid = document.createElement('div');
            stGrid.className = 'status-grid';
            el.appendChild(stGrid);
        }

        // 2. ç¾åœ¨ã®ãƒãƒ•ãƒ»ãƒ‡ãƒãƒ•ã‚’é›†è¨ˆ
        const rageCnt = u.buffs ? u.buffs.filter(b => b.type === 'rage').length : 0;
        const juiceCnt = u.buffs ? u.buffs.filter(b => b.type === 'juice').length : 0;
        const isWeak = u.vuln; // PoPã®ãƒ‡ãƒãƒ•

        // 3. HTMLã‚’ç”Ÿæˆ
        let stHtml = '';
        // RAGE (R)
        if (rageCnt > 0) {
            stHtml += `<div class="st-icon st-rage">R${rageCnt > 1 ? `<span>${rageCnt}</span>` : ''}</div>`;
        }
        // JUICE (J)
        if (juiceCnt > 0) {
            stHtml += `<div class="st-icon st-juice">J${juiceCnt > 1 ? `<span>${juiceCnt}</span>` : ''}</div>`;
        }
        // WEAK (W)
// ä¿®æ­£å‰
// if (isWeak) {
//     stHtml += `<div class="st-icon st-weak">W</div>`;
// }

// â–¼â–¼â–¼ ä¿®æ­£å¾Œï¼šã‚¹ã‚¿ãƒƒã‚¯æ•°ã‚’ãƒãƒƒã‚¸ã§è¡¨ç¤º â–¼â–¼â–¼
// isWeakã§ã¯ãªãã€ç›´æ¥ vulnStacks ã‚’è¦‹ã‚‹ã®ãŒç¢ºå®Ÿã§ã™
if (u.vulnStacks > 0) {
    stHtml += `<div class="st-icon st-weak">W${u.vulnStacks > 1 ? `<span>${u.vulnStacks}</span>` : ''}</div>`;
}
// â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–²

        stGrid.innerHTML = stHtml;

        const mask = el.querySelector('.cd-mask');
        if (mask) {
          if (u.dead) {
             mask.style.height = '100%'; mask.style.backgroundColor = 'rgba(0,0,0,0.7)'; mask.innerText = Math.ceil(u.rt); mask.style.fontSize = '24px';
             mask.style.borderRadius = u.team === 'mob' ? '0' : '8px'; // æ­»ã‚“ã æ™‚ã‚‚ãƒ¢ãƒ–ã¯å››è§’ãã™ã‚‹
          } else if (u.cd > 0) {
            
            // â–¼â–¼â–¼ ä¿®æ­£ï¼šãƒ¢ãƒ–ã®å ´åˆã¯ä¸€å®šã®æ¿ƒã•ã¨å››è§’å½¢ã‚’å¼·åˆ¶ã™ã‚‹ â–¼â–¼â–¼
            if (u.team === 'mob') {
                mask.style.backgroundColor = 'rgba(0, 0, 0, 0.8)'; // å¸¸ã«æ¿ƒã„é»’ (é€æ˜åº¦0.8å›ºå®š)
                mask.style.borderRadius = '0px'; // è§’ä¸¸ãªã—ï¼ˆå®Œå…¨ãªå››è§’ï¼‰
            } else {
                // å‘³æ–¹ã‚„æ•µã‚­ãƒ£ãƒ©ã¯ä»Šã¾ã§é€šã‚Šï¼ˆæ®‹ã‚Šæ™‚é–“ã§è–„ããªã‚‹æ¼”å‡ºã‚ã‚Šï¼‰
                const alpha = Math.min(0.85, (u.cd / u.maxCd) * 0.85);
                mask.style.backgroundColor = `rgba(0, 0, 0, ${alpha})`;
                mask.style.borderRadius = '8px';
            }
            // â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–²

            mask.innerText = Math.ceil(u.cd); mask.style.height = '100%'; mask.style.fontSize = '20px';
          } else { 
             mask.style.height = '0%'; mask.innerText = ''; mask.style.backgroundColor = 'transparent'; 
          }
        }
        
        if (u.cast > 0 && u.act) {
          const safeMax = u.maxCast || 1; const pct = 1.0 - (u.cast / safeMax);
          BATTLE_DRAW.curvedLine(u.id, u.act.tid, u.team, pct); BATTLE_DRAW.markTarget(u.act.tid, u.team);
          registerAction(u.act.tid, u.team, u.cast, u.role);
        } else if (u.reserve) {
          
          // â˜…ä¿®æ­£ï¼šã€Œé’ã„ç‚¹ç·šï¼ˆäºˆç´„ç·šï¼‰ã€ã‚’ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼('p')ã®æ™‚ã ã‘æç”»ã™ã‚‹ã‚ˆã†åˆ¶é™ã—ã¾ã™
          if (u.team === 'p') {
              BATTLE_DRAW.curvedLine(u.id, u.reserve.tid, u.team, 1.0, true); 
          }
          
          // å››è§’ã„æ ã¨ãƒ‰ãƒƒãƒˆï¼ˆã‚¿ãƒ¼ã‚²ãƒƒãƒˆæƒ…å ±ï¼‰ã¯æ”»ç•¥ã«å¿…è¦ãªã®ã§æ®‹ã—ã¾ã™
          BATTLE_DRAW.markTarget(u.reserve.tid, u.team);
          registerAction(u.reserve.tid, u.team, 99.0, u.role);
        }
      });

      BATTLE_STATE.hand.forEach((c, i) => {
        const slot = document.getElementById(`slot-${i}`); if(!slot) return;
        const mask = slot.querySelector('.cd-mask');
        if (c && c.reservedTarget) {
          BATTLE_DRAW.curvedLine(`slot-${i}`, c.reservedTarget, 'p', 1.0, true); BATTLE_DRAW.markTarget(c.reservedTarget, 'p');
          registerAction(c.reservedTarget, 'p', 99.0, 'card');
          mask.style.height = '100%'; mask.innerText = "WAIT"; mask.style.backgroundColor = 'rgba(0,0,0,0.5)';
        } else if (c && c.reload > 0) {
          const pct = (c.reload / c.maxReload) * 100;
          mask.style.height = pct + '%'; mask.innerText = "RELOAD"; mask.style.backgroundColor = 'rgba(0,0,0,0.85)'; 
        } else if (c && c.cast > 0 && c.act) {
          const safeMax = c.maxCast || 1; const pct = 1.0 - (c.cast / safeMax);
          BATTLE_DRAW.curvedLine(`slot-${i}`, c.act.tid, 'p', pct); BATTLE_DRAW.markTarget(c.act.tid, 'p');
          registerAction(c.act.tid, 'p', c.cast, 'card');
          mask.style.height = '0%';
        } else { mask.style.height = '0%'; mask.innerText = ''; }
      });
      
      [0, 1].forEach(idx => {
        const slotData = BATTLE_STATE.enemyHand[idx]; const slotEl = document.getElementById(`e_slot_${idx}`); const mask = slotEl.querySelector('.cd-mask');
        if (slotData.act && slotData.cast > 0) {
            const safeMax = slotData.maxCast || 1; const pct = 1.0 - (slotData.cast / safeMax);
            BATTLE_DRAW.curvedLine(`e_slot_${idx}`, slotData.act.tid, 'e', pct); BATTLE_DRAW.markTarget(slotData.act.tid, 'e');
            registerAction(slotData.act.tid, 'e', slotData.cast, 'card');
            mask.style.height = '0%'; mask.innerText = ''; mask.style.backgroundColor = 'transparent';
        } else if (slotData.reload > 0) {
            const pct = (slotData.reload / slotData.maxReload) * 100; mask.style.backgroundColor = 'rgba(0,0,0,0.85)'; mask.innerText = "RELOAD"; mask.style.height = pct + '%'; 
        } else { mask.style.height = '0%'; mask.innerText = ''; mask.style.backgroundColor = 'transparent'; }
      });

            Object.keys(pendingActions).forEach(tid => {
          const actions = pendingActions[tid];
          actions.sort((a, b) => a.time - b.time); 
          const container = document.getElementById(`ind-${tid}`);
          if(container) {
              actions.forEach(a => {
                  const dot = document.createElement('div');
                  let shapeClass = '';
                  
                  // â–¼â–¼ åˆ†å²ã‚’è¿½åŠ  â–¼â–¼
                  if (a.role === 'tank') shapeClass = 'square';
                  else if (a.role === 'supp') shapeClass = 'tri';
                  else if (a.role === 'card') shapeClass = 'diamond'; // ã‚«ãƒ¼ãƒ‰ãªã‚‰ã²ã—å½¢
                  
                  dot.className = `b-dot ${a.team} ${shapeClass} ${a.time < 0.5 ? 'urgent' : ''}`;
                  container.appendChild(dot);
              });
          }
      });

    } catch(e) { console.error("Draw Loop Error:", e); }
  }
};

const SAVE = {
  KEY: 'neon_spaghetti_v1', // ä¿å­˜ã™ã‚‹æ™‚ã®åå‰

  // ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ï¼ˆã‚¹ãƒ†ãƒ¼ã‚¸ã‚¯ãƒªã‚¢æ™‚ã‚„è²·ã„ç‰©å¾Œã«å‘¼ã¶ï¼‰
  save: () => {
    // ä¿å­˜ã—ãŸã„ãƒ‡ãƒ¼ã‚¿ã ã‘é¸ã¶
    const data = {
      money: STATE.money,
      stage: STATE.stage,
      inventory: STATE.inventory,
      deck: STATE.deck,
      mode: STATE.mode,
      shopItems: STATE.shopItems // ã‚·ãƒ§ãƒƒãƒ—ã®å“æƒãˆã‚‚ä¿å­˜
    };
    localStorage.setItem(SAVE.KEY, JSON.stringify(data));
    console.log("Game Saved");
  },

  // ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ï¼ˆã‚²ãƒ¼ãƒ èµ·å‹•æ™‚ã«å‘¼ã¶ï¼‰
  load: () => {
    const json = localStorage.getItem(SAVE.KEY);
    if (!json) return false; // ãƒ‡ãƒ¼ã‚¿ãªã—
    
    try {
      const data = JSON.parse(json);
      // èª­ã¿è¾¼ã‚“ã ãƒ‡ãƒ¼ã‚¿ã‚’ä»Šã®STATEã«ä¸Šæ›¸ã
      STATE.money = data.money;
      STATE.stage = data.stage;
      STATE.inventory = data.inventory;
      STATE.deck = data.deck;
      STATE.mode = data.mode;
      STATE.shopItems = data.shopItems || [];
      return true;
    } catch(e) {
      console.error("Save data corrupted", e);
      return false;
    }
  },

  // ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ï¼ˆã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ã‚„å…¨ã‚¯ãƒªæ™‚ã«å‘¼ã¶ï¼‰
  clear: () => {
    localStorage.removeItem(SAVE.KEY);
    console.log("Save data cleared");
  }
};

window.onload = GAME.init;
</script>
</body>
</html>
